<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestionnaire de DÃ©penses</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./images/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./images/icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon-32.png">
    
    <!-- Styles -->
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- ThÃ¨me immÃ©diat pour Ã©viter le flash -->
    <script>
        (function() {
            var theme = localStorage.getItem('preferredTheme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    
    <!-- Styles critiques inline pour l'affichage initial -->
    <style>
        /* Loader initial */
        #app-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary, #0a0a0f);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.3s ease;
        }
        #app-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader-text {
            margin-top: 1rem;
            color: #8b5cf6;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body data-theme="dark">
    <!-- Loader affichÃ© pendant le chargement -->
    <div id="app-loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Chargement...</div>
    </div>

    <!-- Application principale (cachÃ©e pendant le chargement) -->
    <div id="app" style="display: none;">
        
        <!-- Header -->
        <div class="header">
            <div class="header-title">
                <h1><span class="material-icons header-icon">savings</span> Gestionnaire de DÃ©penses</h1>
            </div>
            <div class="header-buttons">
                <button class="btn-icon" onclick="App.openShareModal()" title="Partager">
                    <span class="material-icons">share</span>
                </button>
                <button class="btn-icon" onclick="App.showStats()" title="Statistiques">
                    <span class="material-icons">insights</span>
                </button>
                <button class="btn-icon" onclick="App.toggleCalculator()" title="Calculatrice">
                    <span class="material-icons">calculate</span>
                </button>
                <button class="btn-icon" onclick="App.toggleTheme()" title="Changer le thÃ¨me">
                    <span class="material-icons">brightness_6</span>
                </button>
                <button class="btn-icon" onclick="App.openSettings()" title="ParamÃ¨tres">
                    <span class="material-icons">settings</span>
                </button>
            </div>
        </div>

        <!-- Onglets -->
        <div class="tabs" id="tabs"></div>

        <!-- Contenu principal -->
        <div class="content" id="content">
            <!-- Tableau de bord -->
            <div id="dashboard" class="tab-content active">
                <div class="dashboard" id="dashboard-content"></div>
            </div>

            <!-- Onglet Commun/Balance -->
            <div id="commun" class="tab-content">
                <div class="section balance-section">
                    <div class="section-header">
                        <h2 class="section-title">âš–ï¸ Balance : Qui doit quoi ?</h2>
                        <button class="btn btn-small" onclick="App.openShareModal()">
                            <span class="material-icons" style="font-size: 1rem;">share</span>
                            Partager
                        </button>
                    </div>
                    <div id="balance-content" class="items-list"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">ğŸ’¸ Virements entre personnes</h2>
                        <button class="btn btn-small" onclick="App.addTransfer()">+ Ajouter</button>
                    </div>
                    <div id="transfers-list" class="items-list"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Revenus communs</h2>
                        <button class="btn btn-small" onclick="App.addIncome('commun')">+ Ajouter</button>
                    </div>
                    <div id="commun-incomes" class="items-list"></div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">DÃ©penses communes</h2>
                        <button class="btn btn-small" onclick="App.addCommonExpense()">+ Ajouter</button>
                    </div>
                    <div id="commun-expenses" class="items-list"></div>
                </div>
            </div>
        </div>

        <!-- FAB Button -->
        <button class="fab" id="fabButton" onclick="App.toggleFabMenu()" style="display: none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        </button>
        
        <div class="fab-menu" id="fabMenu">
            <button class="fab-item" onclick="App.quickAddIncome()">
                <span class="fab-label">ğŸ’µ Ajouter un revenu</span>
                <div class="fab-item-icon">+</div>
            </button>
            <button class="fab-item" onclick="App.quickAddExpense()">
                <span class="fab-label">ğŸ›’ Ajouter une dÃ©pense</span>
                <div class="fab-item-icon">âˆ’</div>
            </button>
            <button class="fab-item" onclick="App.toggleCalculator()">
                <span class="fab-label">ğŸ§® Calculatrice</span>
                <div class="fab-item-icon">ğŸ§®</div>
            </button>
        </div>
    </div>

    <!-- ========== MODALS ========== -->
    
    <!-- Modal: Ajouter utilisateur -->
    <div class="modal" id="addTabModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un utilisateur</div>
            <div class="modal-body">
                <input type="text" class="input" id="newTabName" placeholder="Nom de l'utilisateur" style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Choisir un avatar :</label>
                <div id="avatarPreview" style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 12px;">
                    <span id="avatarPreviewEmoji" style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                <div id="avatarGrid" class="avatar-grid">
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¤')">ğŸ‘¤</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘©')">ğŸ‘©</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¨')">ğŸ‘¨</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘§')">ğŸ‘§</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¦')">ğŸ‘¦</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ§‘')">ğŸ§‘</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘©â€ğŸ¦°')">ğŸ‘©â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¨â€ğŸ¦°')">ğŸ‘¨â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘©â€ğŸ¦±')">ğŸ‘©â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¨â€ğŸ¦±')">ğŸ‘¨â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘©â€ğŸ¦³')">ğŸ‘©â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¨â€ğŸ¦³')">ğŸ‘¨â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ§”')">ğŸ§”</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘´')">ğŸ‘´</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘µ')">ğŸ‘µ</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ§’')">ğŸ§’</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ‘¶')">ğŸ‘¶</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ±')">ğŸ±</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¶')">ğŸ¶</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¦Š')">ğŸ¦Š</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ»')">ğŸ»</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¼')">ğŸ¼</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¦')">ğŸ¦</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¸')">ğŸ¸</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸŒŸ')">ğŸŒŸ</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ’')">ğŸ’</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ”¥')">ğŸ”¥</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('âš¡')">âš¡</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸŒˆ')">ğŸŒˆ</button>
                    <button type="button" class="avatar-btn" onclick="App.selectAvatar('ğŸ¯')">ğŸ¯</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="App.closeModal('addTabModal')">Annuler</button>
                <button class="btn" onclick="App.confirmAddTab()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal: Modifier avatar -->
    <div class="modal" id="changeAvatarModal">
        <div class="modal-content">
            <div class="modal-header">Modifier l'avatar</div>
            <div class="modal-body">
                <input type="hidden" id="changeAvatarUserId">
                <div id="changeAvatarPreview" style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 12px;">
                    <span style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                <div id="changeAvatarGrid" class="avatar-grid"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="App.closeModal('changeAvatarModal')">Annuler</button>
                <button class="btn" onclick="App.confirmChangeAvatar()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ajouter revenu -->
    <div class="modal" id="addIncomeModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un revenu</div>
            <div class="modal-body">
                <input type="text" class="input" id="incomeName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="incomeAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="App.closeModal('addIncomeModal')">Annuler</button>
                <button class="btn" onclick="App.confirmAddIncome()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ajouter dÃ©pense -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter une dÃ©pense</div>
            <div class="modal-body">
                <input type="text" class="input" id="expenseName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="expenseAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="App.closeModal('addExpenseModal')">Annuler</button>
                <button class="btn" onclick="App.confirmAddExpense()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal: Ajouter dÃ©pense commune -->
    <div class="modal" id="addCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ›’ Nouvelle dÃ©pense commune</div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="selectedIconBtn" onclick="App.toggleIconPicker()">
                            <span id="selectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="commonExpenseName" placeholder="Ex: Courses Leclerc" style="flex: 1;">
                    </div>
                    <input type="hidden" id="commonExpenseIcon" value="ğŸ›’">
                </div>
                <div id="iconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="iconPickerGrid"></div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Montant (â‚¬)</label>
                    <input type="number" class="input" id="commonExpenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="commonExpensePaidBy"></select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">ğŸ‘¥ Participants</label>
                    <div id="participantsList" class="participants"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="App.closeModal('addCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="App.confirmAddCommonExpense()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal: Modifier dÃ©pense commune -->
    <div class="modal" id="editCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">âœï¸ Modifier la dÃ©pense</div>
            <div class="modal-body">
                <input type="hidden" id="editExpenseIndex">
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="editSelectedIconBtn" onclick="App.toggleEditIconPicker()">
                            <span id="editSelectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="editCommonExpenseName" style="flex: 1;">
                    </div>
                    <input type="hidden" id="editCommonExpenseIcon" value="ğŸ›’">
                </div>
                <div id="editIconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="editIconPickerGrid"></div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">Montant (â‚¬)</label>
                    <input type="number" class="input" id="editCommonExpenseAmount" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="editCommonExpensePaidBy"></select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label class="form-label">ğŸ‘¥ Participants</label>
                    <div id="editParticipantsList" class="participants"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="App.closeModal('editCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="App.confirmEditCommonExpense()">ğŸ’¾ Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal: Partage -->
    <div class="modal" id="shareModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">ğŸ”— Partager ce groupe</div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">Votre code de groupe unique</p>
                    <div class="share-code" id="shareCode">XXXXX</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-small" onclick="App.copyShareCode()">
                            <span class="material-icons" style="font-size: 1rem;">content_copy</span> Copier
                        </button>
                        <button class="btn btn-small btn-success" onclick="App.copyShareLink()">
                            <span class="material-icons" style="font-size: 1rem;">link</span> Lien
                        </button>
                    </div>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">ğŸ“¥ Rejoindre un groupe</h4>
                    <input type="text" class="input" id="joinCode" placeholder="Code du groupe" style="text-transform: uppercase; text-align: center; margin-bottom: 0.75rem;">
                    <button class="btn" onclick="App.joinGroup()" style="width: 100%;">Rejoindre</button>
                </div>
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">ğŸ’¾ Sauvegarde</h4>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="App.exportToFile()" style="flex: 1;">TÃ©lÃ©charger</button>
                        <button class="btn btn-outline" onclick="App.importFromFile()" style="flex: 1;">Importer</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('shareModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal: Virement -->
    <div class="modal" id="addTransferModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¸ Ajouter un virement</div>
            <div class="modal-body">
                <input type="text" class="input" id="transferDescription" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="transferAmount" placeholder="Montant" step="0.01" style="margin-bottom: 0.75rem;">
                <div style="margin-bottom: 0.75rem;">
                    <label class="form-label">De :</label>
                    <select class="input" id="transferFrom"></select>
                </div>
                <div>
                    <label class="form-label">Vers :</label>
                    <select class="input" id="transferTo"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="App.closeModal('addTransferModal')">Annuler</button>
                <button class="btn" onclick="App.confirmAddTransfer()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal: Calculatrice -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">Calculatrice</div>
            <div class="modal-body">
                <div class="calculator">
                    <div class="calc-display" id="calcDisplay">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn" onclick="App.calc('C')">C</button>
                        <button class="calc-btn" onclick="App.calc('/')">/</button>
                        <button class="calc-btn" onclick="App.calc('*')">Ã—</button>
                        <button class="calc-btn" onclick="App.calc('del')">â†</button>
                        <button class="calc-btn" onclick="App.calc('7')">7</button>
                        <button class="calc-btn" onclick="App.calc('8')">8</button>
                        <button class="calc-btn" onclick="App.calc('9')">9</button>
                        <button class="calc-btn operator" onclick="App.calc('-')">-</button>
                        <button class="calc-btn" onclick="App.calc('4')">4</button>
                        <button class="calc-btn" onclick="App.calc('5')">5</button>
                        <button class="calc-btn" onclick="App.calc('6')">6</button>
                        <button class="calc-btn operator" onclick="App.calc('+')">+</button>
                        <button class="calc-btn" onclick="App.calc('1')">1</button>
                        <button class="calc-btn" onclick="App.calc('2')">2</button>
                        <button class="calc-btn" onclick="App.calc('3')">3</button>
                        <button class="calc-btn" onclick="App.calc('.')">.</button>
                        <button class="calc-btn" onclick="App.calc('0')">0</button>
                        <button class="calc-btn equal" onclick="App.calc('=')">=</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('calculatorModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal: ParamÃ¨tres -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">ParamÃ¨tres</div>
            <div class="modal-body">
                <div style="display: grid; gap: 1rem;">
                    <button class="btn" id="installAppBtn" style="display: none;" onclick="App.installPWA()">
                        <span class="material-icons">install_mobile</span> Installer l'application
                    </button>
                    <button class="btn" onclick="App.togglePinSecurity()">
                        <span class="material-icons">lock</span>
                        <span id="pinButtonText">Activer le code PIN</span>
                    </button>
                    <button class="btn" onclick="App.exportData()">
                        <span class="material-icons">download</span> Exporter les donnÃ©es
                    </button>
                    <button class="btn" onclick="App.exportToPDF()">
                        <span class="material-icons">picture_as_pdf</span> Exporter en PDF
                    </button>
                    <button class="btn" onclick="App.importData()">
                        <span class="material-icons">upload</span> Importer des donnÃ©es
                    </button>
                    <button class="btn" style="background-color: #e11d48;" onclick="App.showDonation()">
                        <span class="material-icons">favorite</span> Soutenir ce projet
                    </button>
                    <button class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="App.clearCache()">
                        <span class="material-icons">cached</span> Vider le cache
                    </button>
                    <button class="btn btn-danger" onclick="App.confirmReset()">
                        <span class="material-icons">delete_forever</span> RÃ©initialiser tout
                    </button>
                    <button class="btn" onclick="App.showAbout()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                        <span class="material-icons">info</span> Ã€ propos
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('settingsModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal: Statistiques -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">insights</span> Statistiques
            </div>
            <div class="modal-body" style="padding: 0;">
                <div style="display: flex; background: var(--bg-tertiary); border-radius: 12px; margin: 1rem; overflow: hidden;">
                    <button class="stats-period-btn active" onclick="App.setStatsPeriod('month')" id="periodMonth">Mois</button>
                    <button class="stats-period-btn" onclick="App.setStatsPeriod('year')" id="periodYear">AnnÃ©e</button>
                    <button class="stats-period-btn" onclick="App.setStatsPeriod('all')" id="periodAll">Tous</button>
                </div>
                <div id="statsNavigation" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <button onclick="App.navigateStats(-1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer;">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span id="statsPeriodLabel" style="font-weight: 600; min-width: 150px; text-align: center;"></span>
                    <button onclick="App.navigateStats(1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer;">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
                <div style="background: var(--bg-secondary); border-radius: 16px; margin: 0 1rem 1rem; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <div id="pieChartContainer" style="width: 150px; height: 150px; flex-shrink: 0;">
                            <svg id="pieChart" viewBox="0 0 100 100" style="width: 100%; height: 100%; transform: rotate(-90deg);"></svg>
                        </div>
                        <div style="flex: 1;">
                            <div id="statsTotal" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--primary);">Total: 0 â‚¬</div>
                            <div id="statsLegend" style="display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.875rem;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin: 0 1rem 1rem;">
                    <select class="input" id="statsUserFilter" onchange="App.updateStats()" style="padding: 0.75rem 1rem;">
                        <option value="all">Pour le groupe</option>
                    </select>
                </div>
                <div id="statsCategoryList" style="margin: 0 1rem 1rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('statsModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal: PIN -->
    <div class="modal" id="pinModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">lock</span>
                <span id="pinTitle">Entrez votre code PIN</span>
            </div>
            <div class="modal-body" style="text-align: center;">
                <div id="pinDisplay" style="font-size: 2rem; letter-spacing: 1rem; margin: 1rem 0;">â—‹â—‹â—‹â—‹</div>
                <div id="pinError" style="color: var(--danger); font-size: 0.875rem; margin-bottom: 1rem; display: none;"></div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 200px; margin: 0 auto;">
                    <button class="pin-btn" onclick="App.pinInput(1)">1</button>
                    <button class="pin-btn" onclick="App.pinInput(2)">2</button>
                    <button class="pin-btn" onclick="App.pinInput(3)">3</button>
                    <button class="pin-btn" onclick="App.pinInput(4)">4</button>
                    <button class="pin-btn" onclick="App.pinInput(5)">5</button>
                    <button class="pin-btn" onclick="App.pinInput(6)">6</button>
                    <button class="pin-btn" onclick="App.pinInput(7)">7</button>
                    <button class="pin-btn" onclick="App.pinInput(8)">8</button>
                    <button class="pin-btn" onclick="App.pinInput(9)">9</button>
                    <button class="pin-btn" onclick="App.pinClear()">C</button>
                    <button class="pin-btn" onclick="App.pinInput(0)">0</button>
                    <button class="pin-btn" onclick="App.pinSubmit()">âœ“</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ã€ propos -->
    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">info</span> Ã€ propos
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">ğŸ’°</div>
                    <h2 style="margin: 0; font-size: 1.5rem;">Gestionnaire de DÃ©penses</h2>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">Version 2.1</p>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">Application PWA gratuite et sans publicitÃ©</p>
                </div>
                <div class="about-section">
                    <h3>ğŸ“± PrÃ©sentation</h3>
                    <p>Application web progressive (PWA) de gestion de dÃ©penses partagÃ©es, inspirÃ©e de Tricount. IdÃ©ale pour les couples, colocataires ou groupes d'amis.</p>
                </div>
                <div class="about-section" style="text-align: center; border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">DÃ©veloppÃ© avec â¤ï¸ par <strong>ActuetMedia</strong></p>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">Â© 2025 - Tous droits rÃ©servÃ©s</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('aboutModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Popup Donation -->
    <div id="donationPopup" class="donation-overlay" style="display: none;">
        <div class="donation-popup">
            <span class="donation-close" onclick="App.closeDonation()">Ã—</span>
            <h3>ğŸ’– Soutenez ce projet</h3>
            <p>Cette application est 100% gratuite et sans publicitÃ©.<br>Si elle vous est utile, un petit don nous aide Ã  continuer ! ğŸ™</p>
            <a href="https://fr.tipeee.com/actuetmedia" target="_blank" class="donation-link">
                <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">favorite</span>
                Me soutenir sur Tipeee ğŸ’–
            </a>
            <p style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.7;">Merci de votre soutien ! â¤ï¸</p>
        </div>
    </div>

    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Application JavaScript -->
    <script>
    /**
     * ============================================
     * GESTIONNAIRE DE DÃ‰PENSES - Application PWA
     * Version 2.1 - RÃ©Ã©criture complÃ¨te
     * ============================================
     */

    // Objet global de l'application
    const App = {
        // ========== Ã‰TAT DE L'APPLICATION ==========
        data: {
            users: {
                'commun': { name: 'Commun', incomes: [], expenses: [] }
            },
            commonExpenses: [],
            transfers: [],
            currentTab: 'dashboard',
            theme: 'dark',
            groupId: null
        },
        
        // Ã‰tat temporaire (non sauvegardÃ©)
        state: {
            currentUser: '',
            currentTab: 'dashboard',
            selectedAvatar: 'ğŸ‘¤',
            avatarToChange: 'ğŸ‘¤',
            userIdToChangeAvatar: null,
            calcExpression: '0',
            fabMenuOpen: false,
            iconPickerVisible: false,
            editIconPickerVisible: false,
            statsCurrentDate: new Date(),
            statsCurrentPeriod: 'month',
            pinCode: '',
            pinMode: 'verify', // 'verify', 'create', 'confirm'
            pinTemp: '',
            deferredPrompt: null
        },
        
        // Configuration
        config: {
            storageKey: 'expenseTrackerData',
            availableAvatars: ['ğŸ‘¤','ğŸ‘©','ğŸ‘¨','ğŸ‘§','ğŸ‘¦','ğŸ§‘','ğŸ‘©â€ğŸ¦°','ğŸ‘¨â€ğŸ¦°','ğŸ‘©â€ğŸ¦±','ğŸ‘¨â€ğŸ¦±','ğŸ‘©â€ğŸ¦³','ğŸ‘¨â€ğŸ¦³','ğŸ§”','ğŸ‘´','ğŸ‘µ','ğŸ§’','ğŸ‘¶','ğŸ±','ğŸ¶','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¦','ğŸ¸','ğŸŒŸ','ğŸ’','ğŸ”¥','âš¡','ğŸŒˆ','ğŸ¯'],
            availableIcons: [
                {icon:'ğŸ›’',label:'Courses'},{icon:'ğŸ ',label:'Logement'},{icon:'ğŸ’§',label:'Eau'},{icon:'âš¡',label:'Ã‰lectricitÃ©'},
                {icon:'ğŸ”¥',label:'Gaz'},{icon:'ğŸ“¶',label:'Internet'},{icon:'ğŸ“±',label:'TÃ©lÃ©phone'},{icon:'ğŸ›¡ï¸',label:'Assurance'},
                {icon:'ğŸ¥',label:'SantÃ©'},{icon:'ğŸ’Š',label:'Pharmacie'},{icon:'ğŸš—',label:'Voiture'},{icon:'â›½',label:'Essence'},
                {icon:'ğŸ…¿ï¸',label:'Parking'},{icon:'ğŸšŒ',label:'Transport'},{icon:'ğŸš†',label:'Train'},{icon:'âœˆï¸',label:'Voyage'},
                {icon:'ğŸ¨',label:'HÃ´tel'},{icon:'ğŸ½ï¸',label:'Restaurant'},{icon:'ğŸ•',label:'Pizza'},{icon:'ğŸ”',label:'Fast-food'},
                {icon:'â˜•',label:'CafÃ©'},{icon:'ğŸ¬',label:'CinÃ©ma'},{icon:'ğŸµ',label:'Musique'},{icon:'ğŸ®',label:'Jeux'},
                {icon:'ğŸ“º',label:'TV'},{icon:'ğŸ’³',label:'CrÃ©dit'},{icon:'ğŸ¦',label:'Banque'},{icon:'ğŸ“‹',label:'ImpÃ´ts'},
                {icon:'ğŸ‘•',label:'VÃªtements'},{icon:'ğŸ›ï¸',label:'Shopping'},{icon:'ğŸ',label:'Cadeau'},{icon:'ğŸ“¦',label:'Colis'},
                {icon:'ğŸ•',label:'Animaux'},{icon:'ğŸ’°',label:'Autre'}
            ],
            chartColors: ['#f59e0b','#ef4444','#ec4899','#8b5cf6','#3b82f6','#10b981','#14b8a6','#6366f1','#f97316','#84cc16','#06b6d4','#a855f7']
        },

        // ========== INITIALISATION ==========
        init: function() {
            console.log('ğŸš€ Initialisation de l\'application...');
            
            // 1. Charger les donnÃ©es
            this.loadData();
            
            // 2. Appliquer le thÃ¨me
            this.applyTheme();
            
            // 3. VÃ©rifier l'import URL
            this.checkUrlImport();
            
            // 4. VÃ©rifier le PIN
            if (this.data.security && this.data.security.pinEnabled) {
                this.showPinModal('verify');
                return; // Attendre la vÃ©rification du PIN
            }
            
            // 5. DÃ©marrer l'application
            this.start();
        },
        
        start: function() {
            console.log('âœ… DÃ©marrage de l\'application');
            
            // Rendre l'interface
            this.render();
            
            // Initialiser les Ã©vÃ©nements
            this.initEvents();
            
            // Initialiser la PWA
            this.initPWA();
            
            // Cacher le loader et afficher l'app
            this.showApp();
            
            // Sauvegardes automatiques
            setInterval(() => this.saveData(), 10000);
            
            console.log('âœ… Application prÃªte');
        },
        
        showApp: function() {
            const loader = document.getElementById('app-loader');
            const app = document.getElementById('app');
            
            if (loader) loader.classList.add('hidden');
            if (app) app.style.display = 'block';
            
            // Supprimer le loader aprÃ¨s l'animation
            setTimeout(() => {
                if (loader) loader.remove();
            }, 300);
        },

        // ========== GESTION DES DONNÃ‰ES ==========
        loadData: function() {
            try {
                const saved = localStorage.getItem(this.config.storageKey);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed && parsed.users) {
                        this.data = { ...this.data, ...parsed };
                        this.state.currentTab = this.data.currentTab || 'dashboard';
                        console.log('âœ… DonnÃ©es chargÃ©es:', Object.keys(this.data.users).length, 'utilisateurs');
                    }
                }
            } catch (e) {
                console.error('âŒ Erreur chargement donnÃ©es:', e);
            }
            
            // Assurer les structures de base
            if (!this.data.users) this.data.users = { 'commun': { name: 'Commun', incomes: [], expenses: [] } };
            if (!this.data.commonExpenses) this.data.commonExpenses = [];
            if (!this.data.transfers) this.data.transfers = [];
            
            // Charger le thÃ¨me
            const savedTheme = localStorage.getItem('preferredTheme');
            if (savedTheme) this.data.theme = savedTheme;
        },
        
        saveData: function() {
            try {
                this.data.currentTab = this.state.currentTab;
                localStorage.setItem(this.config.storageKey, JSON.stringify(this.data));
            } catch (e) {
                console.error('âŒ Erreur sauvegarde:', e);
            }
        },

        // ========== THÃˆME ==========
        applyTheme: function() {
            const theme = this.data.theme || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            document.body.setAttribute('data-theme', theme);
        },
        
        toggleTheme: function() {
            this.data.theme = this.data.theme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('preferredTheme', this.data.theme);
            this.applyTheme();
            this.saveData();
        },

        // ========== RENDU PRINCIPAL ==========
        render: function() {
            this.renderTabs();
            this.renderDashboard();
            this.renderUserTabs();
            this.renderCommonTab();
            this.renderBalance();
            this.renderTransfers();
            this.applyActiveTab(this.state.currentTab);
        },
        
        renderTabs: function() {
            const container = document.getElementById('tabs');
            if (!container) return;
            
            let html = '<button class="tab" onclick="App.switchTab(\'dashboard\')">Tableau de bord</button>';
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId !== 'commun') {
                    html += `<button class="tab" onclick="App.switchTab('${userId}')">${this.data.users[userId].name}</button>`;
                }
            });
            
            html += '<button class="tab" onclick="App.switchTab(\'commun\')">Balance</button>';
            html += '<button class="add-tab" onclick="App.addNewTab()">+</button>';
            
            container.innerHTML = html;
        },
        
        renderDashboard: function() {
            const container = document.getElementById('dashboard-content');
            if (!container) return;
            
            let html = '';
            
            // Utilisateurs (sauf commun)
            Object.keys(this.data.users).forEach(userId => {
                if (userId !== 'commun') {
                    html += this.renderUserCard(userId);
                }
            });
            
            // Commun en dernier
            if (this.data.users.commun) {
                html += this.renderUserCard('commun');
            }
            
            container.innerHTML = html || '<div class="empty-state">Ajoutez des utilisateurs pour commencer</div>';
        },
        
        renderUserCard: function(userId) {
            const user = this.data.users[userId];
            const totalIncome = user.incomes.reduce((sum, item) => sum + item.amount, 0);
            let totalExpense = user.expenses.reduce((sum, item) => sum + item.amount, 0);
            
            let commonShare = 0;
            if (userId === 'commun') {
                totalExpense = this.data.commonExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            } else {
                this.data.commonExpenses.forEach(exp => {
                    if (exp.participants && exp.participants.includes(userId)) {
                        commonShare += exp.amount / exp.participants.length;
                    }
                });
            }
            
            const balance = totalIncome - totalExpense - commonShare;
            const avatar = userId === 'commun' ? 'ğŸ‘¥' : (user.avatar || 'ğŸ‘¤');
            
            let transferInfo = '';
            if (userId !== 'commun') {
                const balances = this.calculateBalance();
                const userBalance = balances[userId] || 0;
                if (userBalance > 0.01) {
                    transferInfo = `<div class="transfer-info" style="color: var(--success);">ğŸ’° +${userBalance.toFixed(2)}â‚¬ Ã  rÃ©cupÃ©rer</div>`;
                } else if (userBalance < -0.01) {
                    transferInfo = `<div class="transfer-info" style="color: var(--danger);">ğŸ’¸ ${userBalance.toFixed(2)}â‚¬ Ã  rembourser</div>`;
                }
            }
            
            return `
                <div class="user-card">
                    <div class="user-card-header">
                        <div class="user-avatar">${avatar}</div>
                        <h3>${user.name}</h3>
                    </div>
                    <div class="user-card-body">
                        <div class="stats-grid">
                            <div class="stat-card income">
                                <div class="stat-icon">ğŸ“ˆ</div>
                                <div class="stat-label">Revenus</div>
                                <div class="stat-value">+${totalIncome.toFixed(2)}â‚¬</div>
                            </div>
                            <div class="stat-card expense">
                                <div class="stat-icon">ğŸ“‰</div>
                                <div class="stat-label">DÃ©penses</div>
                                <div class="stat-value">-${(userId === 'commun' ? totalExpense : totalExpense + commonShare).toFixed(2)}â‚¬</div>
                            </div>
                        </div>
                        <div class="balance-card ${balance >= 0 ? 'positive' : 'negative'}">
                            <div class="balance-label">ğŸ’° Solde disponible</div>
                            <div class="balance-value">${balance >= 0 ? '+' : ''}${balance.toFixed(2)}â‚¬</div>
                            ${transferInfo}
                        </div>
                    </div>
                </div>
            `;
        },
        
        renderUserTabs: function() {
            const content = document.getElementById('content');
            if (!content) return;
            
            // Supprimer les anciens onglets utilisateur
            content.querySelectorAll('.user-tab-content').forEach(el => el.remove());
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId === 'commun') return;
                
                const user = this.data.users[userId];
                const avatar = user.avatar || 'ğŸ‘¤';
                
                const tabContent = document.createElement('div');
                tabContent.id = userId;
                tabContent.className = 'tab-content user-tab-content';
                
                tabContent.innerHTML = `
                    <div class="section user-profile-section">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <button class="user-avatar-btn" onclick="App.changeUserAvatar('${userId}')">
                                <span class="user-avatar-large">${avatar}</span>
                                <span class="avatar-edit-icon">âœï¸</span>
                            </button>
                            <div>
                                <h2 style="margin: 0; font-size: 1.25rem;">${user.name}</h2>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Cliquez sur l'avatar pour le modifier</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Revenus</h2>
                            <button class="btn btn-small" onclick="App.addIncome('${userId}')">+ Ajouter</button>
                        </div>
                        <div class="items-list">${this.renderItems(user.incomes, 'income', userId)}</div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">DÃ©penses</h2>
                            <button class="btn btn-small" onclick="App.addExpense('${userId}')">+ Ajouter</button>
                        </div>
                        <div class="items-list">${this.renderItems(user.expenses, 'expense', userId)}</div>
                    </div>
                    
                    <div class="section" style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-danger" onclick="App.deleteUser('${userId}')">
                            <span class="material-icons">delete_forever</span> Supprimer cet utilisateur
                        </button>
                    </div>
                `;
                
                content.appendChild(tabContent);
            });
        },
        
        renderItems: function(items, type, userId) {
            if (!items || items.length === 0) {
                return `<div class="empty-state"><div class="empty-state-icon">${type === 'income' ? 'ğŸ“ˆ' : 'ğŸ“‰'}</div><div class="empty-state-text">Aucun Ã©lÃ©ment</div></div>`;
            }
            
            const icon = type === 'income' ? 'ğŸ’µ' : 'ğŸ›’';
            return items.map((item, index) => `
                <div class="item ${type}-item">
                    <div class="item-icon ${type}">${icon}</div>
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-meta">${new Date(item.date).toLocaleDateString('fr-FR')}</div>
                    </div>
                    <div class="item-actions">
                        <span class="item-amount ${type}">${type === 'income' ? '+' : '-'}${item.amount.toFixed(2)}â‚¬</span>
                        <button class="btn-delete" onclick="App.deleteItem('${userId}', '${type}s', ${index})">Ã—</button>
                    </div>
                </div>
            `).join('');
        },
        
        renderCommonTab: function() {
            // Revenus communs
            const commonIncomes = document.getElementById('commun-incomes');
            if (commonIncomes) {
                commonIncomes.innerHTML = this.renderItems(this.data.users.commun.incomes, 'income', 'commun');
            }
            
            // DÃ©penses communes
            const commonExpenses = document.getElementById('commun-expenses');
            if (commonExpenses) {
                if (this.data.commonExpenses.length === 0) {
                    commonExpenses.innerHTML = '<div class="empty-state">Aucune dÃ©pense commune</div>';
                } else {
                    commonExpenses.innerHTML = this.data.commonExpenses.map((expense, index) => {
                        const paidByName = expense.paidBy ? (this.data.users[expense.paidBy]?.name || 'Inconnu') : 'Non dÃ©fini';
                        const participantNames = expense.participants ? expense.participants.map(p => this.data.users[p]?.name || 'Inconnu').join(', ') : '';
                        const perPerson = expense.participants && expense.participants.length > 0 ? (expense.amount / expense.participants.length).toFixed(2) : expense.amount.toFixed(2);
                        
                        return `
                            <div class="item expense-item" onclick="App.editCommonExpense(${index})" style="cursor: pointer;">
                                <div class="item-icon expense">${expense.icon || 'ğŸ›’'}</div>
                                <div class="item-info">
                                    <div class="item-name">${expense.name}</div>
                                    <div class="item-meta">ğŸ’³ PayÃ© par <strong>${paidByName}</strong> â€¢ ${perPerson}â‚¬/pers</div>
                                    <div class="item-meta" style="font-size: 0.7rem; opacity: 0.7;">ğŸ‘¥ ${participantNames}</div>
                                </div>
                                <div class="item-actions">
                                    <span class="item-amount expense">${expense.amount.toFixed(2)}â‚¬</span>
                                    <button class="btn-delete" onclick="event.stopPropagation(); App.deleteCommonExpense(${index})">Ã—</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
        },
        
        renderBalance: function() {
            const container = document.getElementById('balance-content');
            if (!container) return;
            
            const userCount = Object.keys(this.data.users).filter(id => id !== 'commun').length;
            
            if (userCount < 2) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem;"><div style="font-size: 3rem; opacity: 0.5;">ğŸ‘¥</div><div>Ajoutez au moins 2 personnes</div></div>`;
                return;
            }
            
            const debts = this.calculateDebts();
            
            if (debts.length === 0) {
                container.innerHTML = `<div style="text-align: center; padding: 2rem;"><div style="font-size: 3rem;">âœ…</div><div style="color: var(--success); font-weight: 600;">Tout est Ã©quilibrÃ© !</div></div>`;
                return;
            }
            
            container.innerHTML = debts.map(debt => {
                const fromName = this.data.users[debt.from]?.name || 'Inconnu';
                const toName = this.data.users[debt.to]?.name || 'Inconnu';
                const fromAvatar = this.data.users[debt.from]?.avatar || fromName.charAt(0).toUpperCase();
                
                return `
                    <div class="debt-card">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="debt-avatar">${fromAvatar}</div>
                            <div>
                                <span style="font-weight: 700; color: var(--danger);">${fromName}</span><br>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">doit payer Ã </span><br>
                                <span style="font-weight: 700; color: var(--success);">${toName}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="debt-amount">${debt.amount.toFixed(2)}â‚¬</div>
                            <button class="btn-paid" onclick="App.markAsPaid('${debt.from}', '${debt.to}', ${debt.amount.toFixed(2)})">âœ… C'est payÃ© !</button>
                        </div>
                    </div>
                `;
            }).join('');
        },
        
        renderTransfers: function() {
            const container = document.getElementById('transfers-list');
            if (!container) return;
            
            if (!this.data.transfers || this.data.transfers.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ’¸</div><div class="empty-state-text">Aucun virement</div></div>';
                return;
            }
            
            container.innerHTML = this.data.transfers.map((transfer, index) => {
                const fromName = this.data.users[transfer.from]?.name || 'Inconnu';
                const toName = this.data.users[transfer.to]?.name || 'Inconnu';
                const isSettlement = transfer.isSettlement === true;
                
                return `
                    <div class="item ${isSettlement ? 'settlement-item' : 'transfer-item'}">
                        <div class="item-icon">${isSettlement ? 'âœ…' : 'ğŸ’¸'}</div>
                        <div class="item-info">
                            <div class="item-name">${transfer.description}</div>
                            <div class="item-meta">${isSettlement ? toName + ' a remboursÃ© ' + fromName : fromName + ' â†’ ' + toName}</div>
                        </div>
                        <div class="item-actions">
                            <span class="item-amount">${transfer.amount.toFixed(2)}â‚¬</span>
                            ${isSettlement 
                                ? `<button class="btn-undo" onclick="App.cancelSettlement(${index})">ğŸ”„</button>`
                                : `<button class="btn-delete" onclick="App.deleteTransfer(${index})">Ã—</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        },

        // ========== NAVIGATION ==========
        switchTab: function(tabId) {
            this.applyActiveTab(tabId);
            this.saveData();
        },
        
        applyActiveTab: function(tabId) {
            // Valider le tabId
            if (!tabId || (tabId !== 'dashboard' && tabId !== 'commun' && !this.data.users[tabId])) {
                tabId = 'dashboard';
            }
            
            this.state.currentTab = tabId;
            this.data.currentTab = tabId;
            
            // Onglets
            document.querySelectorAll('.tab').forEach((tab, index) => {
                tab.classList.remove('active');
                const tabs = ['dashboard', ...Object.keys(this.data.users).filter(id => id !== 'commun'), 'commun'];
                if (tabs[index] === tabId) tab.classList.add('active');
            });
            
            // Contenus
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const activeContent = document.getElementById(tabId);
            if (activeContent) activeContent.classList.add('active');
            
            // FAB
            const fab = document.getElementById('fabButton');
            if (fab) fab.style.display = tabId === 'dashboard' ? 'none' : 'flex';
        },

        // ========== UTILISATEURS ==========
        addNewTab: function() {
            document.getElementById('newTabName').value = '';
            this.state.selectedAvatar = 'ğŸ‘¤';
            document.getElementById('avatarPreviewEmoji').textContent = 'ğŸ‘¤';
            
            // Reset selection
            document.querySelectorAll('#avatarGrid .avatar-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.trim() === 'ğŸ‘¤');
            });
            
            this.openModal('addTabModal');
        },
        
        selectAvatar: function(avatar) {
            this.state.selectedAvatar = avatar;
            document.getElementById('avatarPreviewEmoji').textContent = avatar;
            
            document.querySelectorAll('#avatarGrid .avatar-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.trim() === avatar);
            });
        },
        
        confirmAddTab: function() {
            const name = document.getElementById('newTabName').value.trim();
            if (!name) return alert('Veuillez entrer un nom');
            
            const userId = 'user_' + Date.now();
            this.data.users[userId] = {
                name: name,
                avatar: this.state.selectedAvatar,
                incomes: [],
                expenses: []
            };
            
            this.saveData();
            this.closeModal('addTabModal');
            this.render();
            this.switchTab(userId);
        },
        
        changeUserAvatar: function(userId) {
            this.state.userIdToChangeAvatar = userId;
            this.state.avatarToChange = this.data.users[userId].avatar || 'ğŸ‘¤';
            
            document.getElementById('changeAvatarPreview').innerHTML = `<span style="font-size: 3rem;">${this.state.avatarToChange}</span>`;
            
            const grid = document.getElementById('changeAvatarGrid');
            grid.innerHTML = this.config.availableAvatars.map(avatar => `
                <button type="button" class="avatar-btn ${avatar === this.state.avatarToChange ? 'selected' : ''}" 
                        onclick="App.selectAvatarToChange('${avatar}')">${avatar}</button>
            `).join('');
            
            this.openModal('changeAvatarModal');
        },
        
        selectAvatarToChange: function(avatar) {
            this.state.avatarToChange = avatar;
            document.getElementById('changeAvatarPreview').innerHTML = `<span style="font-size: 3rem;">${avatar}</span>`;
            
            document.querySelectorAll('#changeAvatarGrid .avatar-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.textContent.trim() === avatar);
            });
        },
        
        confirmChangeAvatar: function() {
            if (this.state.userIdToChangeAvatar && this.data.users[this.state.userIdToChangeAvatar]) {
                this.data.users[this.state.userIdToChangeAvatar].avatar = this.state.avatarToChange;
                this.saveData();
                this.closeModal('changeAvatarModal');
                this.render();
                this.notify('Avatar modifiÃ© !', 'success');
            }
        },
        
        deleteUser: function(userId) {
            const userName = this.data.users[userId].name;
            
            // VÃ©rifier les dÃ©penses communes
            const hasCommonExpenses = this.data.commonExpenses.some(exp => exp.participants && exp.participants.includes(userId));
            if (hasCommonExpenses) {
                return alert(`Impossible de supprimer ${userName} car il participe Ã  des dÃ©penses communes.`);
            }
            
            if (confirm(`Supprimer l'utilisateur "${userName}" et toutes ses donnÃ©es ?`)) {
                delete this.data.users[userId];
                if (this.state.currentTab === userId) this.state.currentTab = 'dashboard';
                this.saveData();
                this.render();
            }
        },

        // ========== REVENUS ==========
        addIncome: function(userId) {
            this.state.currentUser = userId;
            document.getElementById('incomeName').value = '';
            document.getElementById('incomeAmount').value = '';
            this.openModal('addIncomeModal');
        },
        
        confirmAddIncome: function() {
            const name = document.getElementById('incomeName').value.trim();
            const amount = parseFloat(document.getElementById('incomeAmount').value);
            
            if (!name || isNaN(amount) || amount <= 0) return alert('Veuillez remplir tous les champs');
            
            this.data.users[this.state.currentUser].incomes.push({
                name, amount, date: new Date().toISOString()
            });
            
            this.saveData();
            this.closeModal('addIncomeModal');
            this.render();
        },

        // ========== DÃ‰PENSES ==========
        addExpense: function(userId) {
            this.state.currentUser = userId;
            document.getElementById('expenseName').value = '';
            document.getElementById('expenseAmount').value = '';
            this.openModal('addExpenseModal');
        },
        
        confirmAddExpense: function() {
            const name = document.getElementById('expenseName').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            
            if (!name || isNaN(amount) || amount <= 0) return alert('Veuillez remplir tous les champs');
            
            this.data.users[this.state.currentUser].expenses.push({
                name, amount, date: new Date().toISOString()
            });
            
            this.saveData();
            this.closeModal('addExpenseModal');
            this.render();
        },

        // ========== DÃ‰PENSES COMMUNES ==========
        addCommonExpense: function() {
            document.getElementById('commonExpenseName').value = '';
            document.getElementById('commonExpenseAmount').value = '';
            document.getElementById('commonExpenseIcon').value = 'ğŸ›’';
            document.getElementById('selectedIconDisplay').textContent = 'ğŸ›’';
            document.getElementById('iconPickerContainer').style.display = 'none';
            this.state.iconPickerVisible = false;
            
            // Remplir les selects
            const paidBy = document.getElementById('commonExpensePaidBy');
            const participants = document.getElementById('participantsList');
            paidBy.innerHTML = '';
            participants.innerHTML = '';
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId === 'commun') return;
                const name = this.data.users[userId].name;
                paidBy.innerHTML += `<option value="${userId}">${name}</option>`;
                participants.innerHTML += `<div class="participant-checkbox"><input type="checkbox" id="participant_${userId}" value="${userId}" checked><label for="participant_${userId}">${name}</label></div>`;
            });
            
            this.openModal('addCommonExpenseModal');
        },
        
        confirmAddCommonExpense: function() {
            const name = document.getElementById('commonExpenseName').value.trim();
            const amount = parseFloat(document.getElementById('commonExpenseAmount').value);
            const paidBy = document.getElementById('commonExpensePaidBy').value;
            const icon = document.getElementById('commonExpenseIcon').value || 'ğŸ›’';
            
            if (!name || isNaN(amount) || amount <= 0) return alert('Veuillez remplir tous les champs');
            if (!paidBy) return alert('Veuillez sÃ©lectionner qui a payÃ©');
            
            const participants = [];
            document.querySelectorAll('#participantsList input:checked').forEach(cb => participants.push(cb.value));
            if (participants.length === 0) return alert('Veuillez sÃ©lectionner au moins un participant');
            
            this.data.commonExpenses.push({
                name, amount, paidBy, participants, icon, date: new Date().toISOString()
            });
            
            this.saveData();
            this.closeModal('addCommonExpenseModal');
            this.render();
            this.notify(`DÃ©pense ajoutÃ©e: ${amount.toFixed(2)}â‚¬`, 'success');
        },
        
        editCommonExpense: function(index) {
            const expense = this.data.commonExpenses[index];
            if (!expense) return;
            
            document.getElementById('editExpenseIndex').value = index;
            document.getElementById('editCommonExpenseName').value = expense.name;
            document.getElementById('editCommonExpenseAmount').value = expense.amount;
            document.getElementById('editCommonExpenseIcon').value = expense.icon || 'ğŸ›’';
            document.getElementById('editSelectedIconDisplay').textContent = expense.icon || 'ğŸ›’';
            document.getElementById('editIconPickerContainer').style.display = 'none';
            this.state.editIconPickerVisible = false;
            
            // Remplir les selects
            const paidBy = document.getElementById('editCommonExpensePaidBy');
            const participants = document.getElementById('editParticipantsList');
            paidBy.innerHTML = '';
            participants.innerHTML = '';
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId === 'commun') return;
                const name = this.data.users[userId].name;
                const isSelected = userId === expense.paidBy;
                const isParticipant = expense.participants && expense.participants.includes(userId);
                paidBy.innerHTML += `<option value="${userId}" ${isSelected ? 'selected' : ''}>${name}</option>`;
                participants.innerHTML += `<div class="participant-checkbox"><input type="checkbox" id="edit_participant_${userId}" value="${userId}" ${isParticipant ? 'checked' : ''}><label for="edit_participant_${userId}">${name}</label></div>`;
            });
            
            this.openModal('editCommonExpenseModal');
        },
        
        confirmEditCommonExpense: function() {
            const index = parseInt(document.getElementById('editExpenseIndex').value);
            const name = document.getElementById('editCommonExpenseName').value.trim();
            const amount = parseFloat(document.getElementById('editCommonExpenseAmount').value);
            const paidBy = document.getElementById('editCommonExpensePaidBy').value;
            const icon = document.getElementById('editCommonExpenseIcon').value || 'ğŸ›’';
            
            if (!name || isNaN(amount) || amount <= 0) return alert('Veuillez remplir tous les champs');
            
            const participants = [];
            document.querySelectorAll('#editParticipantsList input:checked').forEach(cb => participants.push(cb.value));
            if (participants.length === 0) return alert('Veuillez sÃ©lectionner au moins un participant');
            
            this.data.commonExpenses[index] = {
                ...this.data.commonExpenses[index],
                name, amount, paidBy, participants, icon
            };
            
            this.saveData();
            this.closeModal('editCommonExpenseModal');
            this.render();
            this.notify('DÃ©pense modifiÃ©e', 'success');
        },
        
        deleteCommonExpense: function(index) {
            if (confirm('Supprimer cette dÃ©pense commune ?')) {
                this.data.commonExpenses.splice(index, 1);
                this.saveData();
                this.render();
            }
        },
        
        toggleIconPicker: function() {
            this.state.iconPickerVisible = !this.state.iconPickerVisible;
            const container = document.getElementById('iconPickerContainer');
            
            if (this.state.iconPickerVisible) {
                const currentIcon = document.getElementById('commonExpenseIcon').value;
                document.getElementById('iconPickerGrid').innerHTML = this.config.availableIcons.map(item => `
                    <button type="button" class="icon-picker-item ${item.icon === currentIcon ? 'selected' : ''}" 
                            onclick="App.selectIcon('${item.icon}')" title="${item.label}">${item.icon}</button>
                `).join('');
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        },
        
        selectIcon: function(icon) {
            document.getElementById('commonExpenseIcon').value = icon;
            document.getElementById('selectedIconDisplay').textContent = icon;
            this.toggleIconPicker();
        },
        
        toggleEditIconPicker: function() {
            this.state.editIconPickerVisible = !this.state.editIconPickerVisible;
            const container = document.getElementById('editIconPickerContainer');
            
            if (this.state.editIconPickerVisible) {
                const currentIcon = document.getElementById('editCommonExpenseIcon').value;
                document.getElementById('editIconPickerGrid').innerHTML = this.config.availableIcons.map(item => `
                    <button type="button" class="icon-picker-item ${item.icon === currentIcon ? 'selected' : ''}" 
                            onclick="App.selectEditIcon('${item.icon}')" title="${item.label}">${item.icon}</button>
                `).join('');
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        },
        
        selectEditIcon: function(icon) {
            document.getElementById('editCommonExpenseIcon').value = icon;
            document.getElementById('editSelectedIconDisplay').textContent = icon;
            this.toggleEditIconPicker();
        },

        // ========== SUPPRESSION D'Ã‰LÃ‰MENTS ==========
        deleteItem: function(userId, type, index) {
            if (confirm('Supprimer cet Ã©lÃ©ment ?')) {
                this.data.users[userId][type].splice(index, 1);
                this.saveData();
                this.render();
            }
        },

        // ========== VIREMENTS ==========
        addTransfer: function() {
            document.getElementById('transferDescription').value = '';
            document.getElementById('transferAmount').value = '';
            
            const from = document.getElementById('transferFrom');
            const to = document.getElementById('transferTo');
            from.innerHTML = '';
            to.innerHTML = '';
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId === 'commun') return;
                const name = this.data.users[userId].name;
                from.innerHTML += `<option value="${userId}">${name}</option>`;
                to.innerHTML += `<option value="${userId}">${name}</option>`;
            });
            
            this.openModal('addTransferModal');
        },
        
        confirmAddTransfer: function() {
            const description = document.getElementById('transferDescription').value.trim();
            const amount = parseFloat(document.getElementById('transferAmount').value);
            const fromUser = document.getElementById('transferFrom').value;
            const toUser = document.getElementById('transferTo').value;
            
            if (!description) return alert('Veuillez entrer une description');
            if (isNaN(amount) || amount <= 0) return alert('Veuillez entrer un montant valide');
            if (fromUser === toUser) return alert('Personnes diffÃ©rentes requises');
            
            if (!this.data.transfers) this.data.transfers = [];
            
            this.data.transfers.push({
                description, amount, from: fromUser, to: toUser, date: new Date().toISOString()
            });
            
            this.saveData();
            this.closeModal('addTransferModal');
            this.render();
            this.notify('Virement ajoutÃ©', 'success');
        },
        
        deleteTransfer: function(index) {
            if (confirm('Supprimer ce virement ?')) {
                this.data.transfers.splice(index, 1);
                this.saveData();
                this.render();
            }
        },

        // ========== CALCULS BALANCE ==========
        calculateBalance: function() {
            const balances = {};
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId !== 'commun') balances[userId] = 0;
            });
            
            // Virements
            if (this.data.transfers) {
                this.data.transfers.forEach(t => {
                    if (balances[t.from] !== undefined) balances[t.from] -= t.amount;
                    if (balances[t.to] !== undefined) balances[t.to] += t.amount;
                });
            }
            
            // DÃ©penses communes
            this.data.commonExpenses.forEach(exp => {
                if (!exp.participants || exp.participants.length === 0) return;
                const share = exp.amount / exp.participants.length;
                
                if (exp.paidBy && balances[exp.paidBy] !== undefined) {
                    balances[exp.paidBy] += exp.amount;
                }
                
                exp.participants.forEach(p => {
                    if (balances[p] !== undefined) balances[p] -= share;
                });
            });
            
            return balances;
        },
        
        calculateDebts: function() {
            const balances = this.calculateBalance();
            const debts = [];
            const debtors = [];
            const creditors = [];
            
            Object.keys(balances).forEach(userId => {
                const balance = balances[userId];
                if (balance < -0.01) debtors.push({ userId, amount: Math.abs(balance) });
                else if (balance > 0.01) creditors.push({ userId, amount: balance });
            });
            
            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);
            
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const amount = Math.min(debtors[i].amount, creditors[j].amount);
                if (amount > 0.01) {
                    debts.push({ from: debtors[i].userId, to: creditors[j].userId, amount });
                }
                debtors[i].amount -= amount;
                creditors[j].amount -= amount;
                if (debtors[i].amount < 0.01) i++;
                if (creditors[j].amount < 0.01) j++;
            }
            
            return debts;
        },
        
        markAsPaid: function(fromUserId, toUserId, amount) {
            const fromName = this.data.users[fromUserId]?.name || 'Inconnu';
            const toName = this.data.users[toUserId]?.name || 'Inconnu';
            
            if (!confirm(`Confirmer: ${fromName} a payÃ© ${amount.toFixed(2)}â‚¬ Ã  ${toName} ?`)) return;
            
            if (!this.data.transfers) this.data.transfers = [];
            
            this.data.transfers.push({
                description: `Remboursement du ${new Date().toLocaleDateString('fr-FR')}`,
                amount, from: toUserId, to: fromUserId,
                date: new Date().toISOString(),
                isSettlement: true
            });
            
            this.saveData();
            this.render();
            this.notify(`${fromName} a remboursÃ© ${amount.toFixed(2)}â‚¬`, 'success');
        },
        
        cancelSettlement: function(index) {
            if (confirm('Annuler ce remboursement ?')) {
                this.data.transfers.splice(index, 1);
                this.saveData();
                this.render();
            }
        },

        // ========== FAB MENU ==========
        toggleFabMenu: function() {
            this.state.fabMenuOpen = !this.state.fabMenuOpen;
            const menu = document.getElementById('fabMenu');
            const btn = document.getElementById('fabButton');
            if (this.state.fabMenuOpen) {
                menu.classList.add('active');
                btn.classList.add('active');
            } else {
                menu.classList.remove('active');
                btn.classList.remove('active');
            }
        },
        
        closeFabMenu: function() {
            this.state.fabMenuOpen = false;
            document.getElementById('fabMenu')?.classList.remove('active');
            document.getElementById('fabButton')?.classList.remove('active');
        },
        
        quickAddIncome: function() {
            this.closeFabMenu();
            const firstUser = Object.keys(this.data.users).find(id => id !== 'commun');
            if (firstUser) this.addIncome(this.state.currentTab === 'dashboard' || this.state.currentTab === 'commun' ? firstUser : this.state.currentTab);
        },
        
        quickAddExpense: function() {
            this.closeFabMenu();
            if (this.state.currentTab === 'commun') {
                this.addCommonExpense();
            } else {
                const firstUser = Object.keys(this.data.users).find(id => id !== 'commun');
                if (firstUser) this.addExpense(this.state.currentTab === 'dashboard' ? firstUser : this.state.currentTab);
            }
        },

        // ========== CALCULATRICE ==========
        toggleCalculator: function() {
            this.closeFabMenu();
            this.state.calcExpression = '0';
            document.getElementById('calcDisplay').textContent = '0';
            this.openModal('calculatorModal');
        },
        
        calc: function(value) {
            if (value === 'C') {
                this.state.calcExpression = '0';
            } else if (value === 'del') {
                this.state.calcExpression = this.state.calcExpression.length > 1 ? this.state.calcExpression.slice(0, -1) : '0';
            } else if (value === '=') {
                try {
                    this.state.calcExpression = eval(this.state.calcExpression).toString();
                } catch (e) {
                    this.state.calcExpression = 'Erreur';
                }
            } else {
                if (this.state.calcExpression === '0' && value !== '.') {
                    this.state.calcExpression = value;
                } else {
                    this.state.calcExpression += value;
                }
            }
            document.getElementById('calcDisplay').textContent = this.state.calcExpression;
        },

        // ========== MODALS ==========
        openModal: function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
        },
        
        closeModal: function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        },

        // ========== PARTAGE ==========
        getGroupId: function() {
            if (!this.data.groupId) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                this.data.groupId = Array.from({length: 5}, () => chars[Math.floor(Math.random() * chars.length)]).join('');
                this.saveData();
            }
            return this.data.groupId;
        },
        
        openShareModal: function() {
            document.getElementById('shareCode').textContent = this.getGroupId();
            document.getElementById('joinCode').value = '';
            this.openModal('shareModal');
        },
        
        copyShareCode: function() {
            navigator.clipboard.writeText(this.getGroupId()).then(() => this.notify('Code copiÃ© !', 'success'));
        },
        
        copyShareLink: async function() {
            try {
                const minData = { g: this.data.groupId, u: {}, c: [], t: [] };
                
                Object.keys(this.data.users).forEach(userId => {
                    const user = this.data.users[userId];
                    const shortId = userId === 'commun' ? 'c' : userId.replace('user_', 'u');
                    minData.u[shortId] = { n: user.name, a: user.avatar, i: user.incomes || [], e: user.expenses || [] };
                });
                
                this.data.commonExpenses.forEach(exp => {
                    minData.c.push({
                        n: exp.name, a: exp.amount,
                        p: exp.paidBy ? exp.paidBy.replace('user_', 'u') : '',
                        ps: (exp.participants || []).map(p => p.replace('user_', 'u')),
                        ic: exp.icon || 'ğŸ›’'
                    });
                });
                
                (this.data.transfers || []).forEach(t => {
                    minData.t.push({
                        d: t.description, a: t.amount,
                        f: t.from.replace('user_', 'u'),
                        o: t.to.replace('user_', 'u')
                    });
                });
                
                const compressed = btoa(unescape(encodeURIComponent(JSON.stringify(minData))))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
                
                const url = `${location.origin}${location.pathname}?i=${compressed}`;
                await navigator.clipboard.writeText(url);
                this.notify('Lien copiÃ© !', 'success');
            } catch (e) {
                this.notify('Erreur lors de la copie', 'error');
            }
        },
        
        joinGroup: function() {
            const code = document.getElementById('joinCode').value.trim().toUpperCase();
            if (code.length < 5) return alert('Code invalide');
            if (code === this.getGroupId()) return this.notify('Vous Ãªtes dÃ©jÃ  dans ce groupe', 'info');
            alert('Demandez au propriÃ©taire le lien de partage ou le fichier de sauvegarde.');
        },
        
        exportToFile: function() {
            const data = {
                groupId: this.getGroupId(),
                users: this.data.users,
                commonExpenses: this.data.commonExpenses,
                transfers: this.data.transfers || [],
                exportDate: new Date().toISOString(),
                version: '2.1'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `depenses_${this.getGroupId()}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
            this.notify('Fichier tÃ©lÃ©chargÃ©', 'success');
        },
        
        importFromFile: function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!data.users || !data.groupId) return alert('Fichier invalide');
                        
                        if (confirm(`Importer les donnÃ©es du groupe "${data.groupId}" ?`)) {
                            this.data.groupId = data.groupId;
                            this.data.users = data.users;
                            this.data.commonExpenses = data.commonExpenses || [];
                            this.data.transfers = data.transfers || [];
                            this.saveData();
                            this.render();
                            this.closeModal('shareModal');
                            this.notify('DonnÃ©es importÃ©es', 'success');
                        }
                    } catch (e) {
                        alert('Erreur lors de l\'import');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        },
        
        checkUrlImport: function() {
            const params = new URLSearchParams(location.search);
            const compressed = params.get('i');
            if (!compressed) return;
            
            try {
                let base64 = compressed.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) base64 += '=';
                const minData = JSON.parse(decodeURIComponent(escape(atob(base64))));
                
                const importedData = { groupId: minData.g, users: {}, commonExpenses: [], transfers: [] };
                
                Object.keys(minData.u).forEach(shortId => {
                    const userData = minData.u[shortId];
                    const fullId = shortId === 'c' ? 'commun' : shortId.replace('u', 'user_');
                    importedData.users[fullId] = {
                        name: userData.n,
                        avatar: userData.a,
                        incomes: (userData.i || []).map(i => ({ name: i.n || i.name, amount: i.a || i.amount, date: new Date().toISOString() })),
                        expenses: (userData.e || []).map(e => ({ name: e.n || e.name, amount: e.a || e.amount, date: new Date().toISOString() }))
                    };
                });
                
                (minData.c || []).forEach(exp => {
                    importedData.commonExpenses.push({
                        name: exp.n, amount: exp.a,
                        paidBy: exp.p ? exp.p.replace('u', 'user_') : null,
                        participants: (exp.ps || []).map(p => p === 'c' ? 'commun' : p.replace('u', 'user_')),
                        icon: exp.ic || 'ğŸ›’',
                        date: new Date().toISOString()
                    });
                });
                
                (minData.t || []).forEach(t => {
                    importedData.transfers.push({
                        description: t.d, amount: t.a,
                        from: t.f.replace('u', 'user_'),
                        to: t.o.replace('u', 'user_'),
                        date: new Date().toISOString()
                    });
                });
                
                if (confirm(`Importer les donnÃ©es du groupe "${importedData.groupId}" ?`)) {
                    this.data = { ...this.data, ...importedData };
                    this.saveData();
                    this.notify('DonnÃ©es importÃ©es', 'success');
                }
                
                history.replaceState({}, document.title, location.pathname);
            } catch (e) {
                console.error('Erreur import URL:', e);
            }
        },

        // ========== PARAMÃˆTRES ==========
        openSettings: function() {
            this.updatePinButtonText();
            this.openModal('settingsModal');
        },
        
        exportData: function() {
            const blob = new Blob([JSON.stringify(this.data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `depenses_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            this.closeModal('settingsModal');
        },
        
        importData: function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const data = JSON.parse(event.target.result);
                        this.data = data;
                        const theme = localStorage.getItem('preferredTheme') || 'dark';
                        this.data.theme = theme;
                        this.saveData();
                        this.render();
                        this.closeModal('settingsModal');
                        this.notify('DonnÃ©es importÃ©es', 'success');
                    } catch (e) {
                        alert('Erreur lors de l\'import');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        },
        
        exportToPDF: function() {
            if (typeof jspdf === 'undefined' && typeof window.jspdf === 'undefined') {
                return alert('Module PDF non chargÃ©');
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Gestionnaire de DÃ©penses', 20, 20);
            doc.setFontSize(12);
            doc.text(`ExportÃ© le ${new Date().toLocaleDateString('fr-FR')}`, 20, 30);
            
            let y = 50;
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId === 'commun') return;
                const user = this.data.users[userId];
                doc.setFontSize(14);
                doc.text(user.name, 20, y);
                y += 10;
                
                const totalIncome = user.incomes.reduce((s, i) => s + i.amount, 0);
                const totalExpense = user.expenses.reduce((s, e) => s + e.amount, 0);
                
                doc.setFontSize(10);
                doc.text(`Revenus: ${totalIncome.toFixed(2)}â‚¬`, 30, y);
                y += 6;
                doc.text(`DÃ©penses: ${totalExpense.toFixed(2)}â‚¬`, 30, y);
                y += 10;
            });
            
            doc.save(`depenses_${new Date().toISOString().split('T')[0]}.pdf`);
            this.closeModal('settingsModal');
        },
        
        async clearCache() {
            if (!confirm('Vider le cache ? Vos donnÃ©es seront conservÃ©es.')) return;
            
            try {
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const reg of registrations) await reg.unregister();
                }
                if ('caches' in window) {
                    const names = await caches.keys();
                    for (const name of names) await caches.delete(name);
                }
                this.notify('Cache vidÃ© !', 'success');
                setTimeout(() => location.reload(true), 1000);
            } catch (e) {
                alert('Erreur lors du vidage du cache');
            }
        },
        
        async confirmReset() {
            if (!confirm('ATTENTION: Supprimer toutes les donnÃ©es ?')) return;
            if (!confirm('DerniÃ¨re chance ! Tout sera effacÃ©.')) return;
            
            try {
                localStorage.clear();
                sessionStorage.clear();
                if ('serviceWorker' in navigator) {
                    const regs = await navigator.serviceWorker.getRegistrations();
                    for (const r of regs) await r.unregister();
                }
                if ('caches' in window) {
                    const names = await caches.keys();
                    for (const n of names) await caches.delete(n);
                }
                alert('DonnÃ©es supprimÃ©es. L\'application va se recharger.');
                location.href = location.pathname + '?reset=' + Date.now();
            } catch (e) {
                localStorage.clear();
                location.reload(true);
            }
        },
        
        showAbout: function() {
            this.closeModal('settingsModal');
            setTimeout(() => this.openModal('aboutModal'), 100);
        },

        // ========== STATISTIQUES ==========
        showStats: function() {
            const filter = document.getElementById('statsUserFilter');
            filter.innerHTML = '<option value="all">Pour le groupe</option>';
            
            Object.keys(this.data.users).forEach(userId => {
                if (userId !== 'commun') {
                    filter.innerHTML += `<option value="${userId}">${this.data.users[userId].name}</option>`;
                }
            });
            
            this.state.statsCurrentDate = new Date();
            this.state.statsCurrentPeriod = 'month';
            
            document.querySelectorAll('.stats-period-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('periodMonth').classList.add('active');
            
            this.updateStats();
            this.openModal('statsModal');
        },
        
        setStatsPeriod: function(period) {
            this.state.statsCurrentPeriod = period;
            
            document.querySelectorAll('.stats-period-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('period' + period.charAt(0).toUpperCase() + period.slice(1)).classList.add('active');
            
            document.getElementById('statsNavigation').style.display = period === 'all' ? 'none' : 'flex';
            this.updateStats();
        },
        
        navigateStats: function(direction) {
            if (this.state.statsCurrentPeriod === 'month') {
                this.state.statsCurrentDate.setMonth(this.state.statsCurrentDate.getMonth() + direction);
            } else if (this.state.statsCurrentPeriod === 'year') {
                this.state.statsCurrentDate.setFullYear(this.state.statsCurrentDate.getFullYear() + direction);
            }
            this.updateStats();
        },
        
        updateStats: function() {
            const userFilter = document.getElementById('statsUserFilter').value;
            const periodLabel = document.getElementById('statsPeriodLabel');
            
            if (this.state.statsCurrentPeriod === 'month') {
                periodLabel.textContent = this.state.statsCurrentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            } else if (this.state.statsCurrentPeriod === 'year') {
                periodLabel.textContent = this.state.statsCurrentDate.getFullYear().toString();
            } else {
                periodLabel.textContent = 'Toutes les dÃ©penses';
            }
            
            // Collecter les dÃ©penses filtrÃ©es
            const expenses = [];
            
            this.data.commonExpenses.forEach(exp => {
                if (userFilter !== 'all' && (!exp.participants || !exp.participants.includes(userFilter))) return;
                if (!this.isInStatsPeriod(exp.date)) return;
                
                let amount = exp.amount;
                if (userFilter !== 'all' && exp.participants) amount = exp.amount / exp.participants.length;
                
                expenses.push({ name: exp.name, amount, icon: exp.icon });
            });
            
            // Grouper par catÃ©gorie
            const categories = {};
            let total = 0;
            
            expenses.forEach(exp => {
                if (!categories[exp.name]) categories[exp.name] = { name: exp.name, amount: 0, icon: exp.icon || 'ğŸ’°' };
                categories[exp.name].amount += exp.amount;
                total += exp.amount;
            });
            
            const sorted = Object.values(categories).sort((a, b) => b.amount - a.amount);
            
            // Afficher
            document.getElementById('statsTotal').innerHTML = `Total: ${total.toFixed(0)} â‚¬`;
            this.generatePieChart(sorted, total);
            this.generateStatsLegend(sorted);
            this.generateCategoryList(sorted);
        },
        
        isInStatsPeriod: function(dateStr) {
            if (this.state.statsCurrentPeriod === 'all') return true;
            if (!dateStr) return false;
            
            const date = new Date(dateStr);
            if (this.state.statsCurrentPeriod === 'month') {
                return date.getMonth() === this.state.statsCurrentDate.getMonth() &&
                       date.getFullYear() === this.state.statsCurrentDate.getFullYear();
            } else if (this.state.statsCurrentPeriod === 'year') {
                return date.getFullYear() === this.state.statsCurrentDate.getFullYear();
            }
            return true;
        },
        
        generatePieChart: function(categories, total) {
            const svg = document.getElementById('pieChart');
            
            if (categories.length === 0 || total === 0) {
                svg.innerHTML = '<circle cx="50" cy="50" r="45" fill="var(--bg-tertiary)"/><text x="50" y="50" text-anchor="middle" fill="var(--text-secondary)" font-size="8" transform="rotate(90 50 50)">Aucune donnÃ©e</text>';
                return;
            }
            
            let html = '';
            let currentAngle = 0;
            
            categories.forEach((cat, index) => {
                const percentage = cat.amount / total;
                const angle = percentage * 360;
                const color = this.config.chartColors[index % this.config.chartColors.length];
                
                if (categories.length === 1) {
                    html = `<circle cx="50" cy="50" r="45" fill="${color}"/>`;
                } else {
                    const startAngle = currentAngle;
                    const endAngle = currentAngle + angle;
                    const x1 = 50 + 45 * Math.cos((startAngle * Math.PI) / 180);
                    const y1 = 50 + 45 * Math.sin((startAngle * Math.PI) / 180);
                    const x2 = 50 + 45 * Math.cos((endAngle * Math.PI) / 180);
                    const y2 = 50 + 45 * Math.sin((endAngle * Math.PI) / 180);
                    const largeArc = angle > 180 ? 1 : 0;
                    html += `<path d="M 50 50 L ${x1} ${y1} A 45 45 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}"/>`;
                    currentAngle = endAngle;
                }
            });
            
            svg.innerHTML = html;
        },
        
        generateStatsLegend: function(categories) {
            const legend = document.getElementById('statsLegend');
            
            if (categories.length === 0) {
                legend.innerHTML = '<div style="color: var(--text-secondary);">Aucune dÃ©pense</div>';
                return;
            }
            
            legend.innerHTML = categories.slice(0, 5).map((cat, index) => {
                const color = this.config.chartColors[index % this.config.chartColors.length];
                return `<div style="display: flex; align-items: center; gap: 0.5rem;"><div style="width: 10px; height: 10px; border-radius: 50%; background: ${color};"></div><span>${cat.name}</span></div>`;
            }).join('');
            
            if (categories.length > 5) {
                legend.innerHTML += `<div style="color: var(--text-secondary); font-size: 0.75rem;">+ ${categories.length - 5} autres</div>`;
            }
        },
        
        generateCategoryList: function(categories) {
            const list = document.getElementById('statsCategoryList');
            
            if (categories.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucune dÃ©pense</div>';
                return;
            }
            
            list.innerHTML = categories.map((cat, index) => {
                const color = this.config.chartColors[index % this.config.chartColors.length];
                return `
                    <div class="stats-category-item">
                        <div class="stats-category-icon" style="background: ${color}20; color: ${color};">${cat.icon}</div>
                        <div class="stats-category-info"><div class="stats-category-name">${cat.name}</div></div>
                        <div class="stats-category-amount">${cat.amount.toFixed(2)} â‚¬</div>
                    </div>
                `;
            }).join('');
        },

        // ========== PIN SÃ‰CURITÃ‰ ==========
        togglePinSecurity: function() {
            if (this.data.security && this.data.security.pinEnabled) {
                if (confirm('DÃ©sactiver le code PIN ?')) {
                    this.data.security.pinEnabled = false;
                    this.data.security.pin = null;
                    this.saveData();
                    this.updatePinButtonText();
                    this.notify('PIN dÃ©sactivÃ©', 'success');
                }
            } else {
                this.state.pinMode = 'create';
                this.state.pinCode = '';
                this.state.pinTemp = '';
                document.getElementById('pinTitle').textContent = 'CrÃ©er un code PIN';
                document.getElementById('pinDisplay').textContent = 'â—‹â—‹â—‹â—‹';
                document.getElementById('pinError').style.display = 'none';
                this.openModal('pinModal');
            }
        },
        
        showPinModal: function(mode) {
            this.state.pinMode = mode;
            this.state.pinCode = '';
            document.getElementById('pinTitle').textContent = mode === 'verify' ? 'Entrez votre code PIN' : 'CrÃ©er un code PIN';
            document.getElementById('pinDisplay').textContent = 'â—‹â—‹â—‹â—‹';
            document.getElementById('pinError').style.display = 'none';
            this.openModal('pinModal');
        },
        
        updatePinButtonText: function() {
            const btn = document.getElementById('pinButtonText');
            if (btn) {
                btn.textContent = (this.data.security && this.data.security.pinEnabled) ? 'DÃ©sactiver le code PIN' : 'Activer le code PIN';
            }
        },
        
        pinInput: function(digit) {
            if (this.state.pinCode.length < 4) {
                this.state.pinCode += digit;
                const filled = 'â—'.repeat(this.state.pinCode.length);
                const empty = 'â—‹'.repeat(4 - this.state.pinCode.length);
                document.getElementById('pinDisplay').textContent = filled + empty;
            }
        },
        
        pinClear: function() {
            this.state.pinCode = '';
            document.getElementById('pinDisplay').textContent = 'â—‹â—‹â—‹â—‹';
            document.getElementById('pinError').style.display = 'none';
        },
        
        pinSubmit: function() {
            if (this.state.pinCode.length !== 4) return;
            
            if (this.state.pinMode === 'verify') {
                if (this.data.security && this.state.pinCode === this.data.security.pin) {
                    this.closeModal('pinModal');
                    this.start();
                } else {
                    document.getElementById('pinError').textContent = 'Code incorrect';
                    document.getElementById('pinError').style.display = 'block';
                    this.pinClear();
                }
            } else if (this.state.pinMode === 'create') {
                this.state.pinTemp = this.state.pinCode;
                this.state.pinMode = 'confirm';
                this.state.pinCode = '';
                document.getElementById('pinTitle').textContent = 'Confirmez le code PIN';
                document.getElementById('pinDisplay').textContent = 'â—‹â—‹â—‹â—‹';
            } else if (this.state.pinMode === 'confirm') {
                if (this.state.pinCode === this.state.pinTemp) {
                    if (!this.data.security) this.data.security = {};
                    this.data.security.pinEnabled = true;
                    this.data.security.pin = this.state.pinCode;
                    this.saveData();
                    this.closeModal('pinModal');
                    this.updatePinButtonText();
                    this.notify('PIN activÃ©', 'success');
                } else {
                    document.getElementById('pinError').textContent = 'Les codes ne correspondent pas';
                    document.getElementById('pinError').style.display = 'block';
                    this.state.pinMode = 'create';
                    this.state.pinCode = '';
                    document.getElementById('pinTitle').textContent = 'CrÃ©er un code PIN';
                    document.getElementById('pinDisplay').textContent = 'â—‹â—‹â—‹â—‹';
                }
            }
        },

        // ========== DONATION ==========
        showDonation: function() {
            this.closeModal('settingsModal');
            document.getElementById('donationPopup').style.display = 'flex';
        },
        
        closeDonation: function() {
            document.getElementById('donationPopup').style.display = 'none';
        },

        // ========== PWA ==========
        initPWA: function() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('âœ… Service Worker enregistrÃ©');
                        
                        reg.addEventListener('updatefound', () => {
                            const newWorker = reg.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    if (confirm('Nouvelle version disponible ! Mettre Ã  jour ?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => console.error('SW Error:', err));
            }
            
            window.addEventListener('beforeinstallprompt', e => {
                e.preventDefault();
                this.state.deferredPrompt = e;
                const btn = document.getElementById('installAppBtn');
                if (btn) btn.style.display = 'flex';
            });
            
            window.addEventListener('appinstalled', () => {
                this.state.deferredPrompt = null;
                const btn = document.getElementById('installAppBtn');
                if (btn) btn.style.display = 'none';
            });
        },
        
        installPWA: async function() {
            if (!this.state.deferredPrompt) {
                alert('Installation non disponible. Utilisez le menu de votre navigateur.');
                return;
            }
            
            this.state.deferredPrompt.prompt();
            const { outcome } = await this.state.deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                this.notify('Application installÃ©e !', 'success');
                const btn = document.getElementById('installAppBtn');
                if (btn) btn.style.display = 'none';
            }
            
            this.state.deferredPrompt = null;
        },

        // ========== Ã‰VÃ‰NEMENTS ==========
        initEvents: function() {
            // Fermer FAB menu au clic ailleurs
            document.addEventListener('click', e => {
                if (this.state.fabMenuOpen && !e.target.closest('.fab') && !e.target.closest('.fab-menu')) {
                    this.closeFabMenu();
                }
            });
            
            // Bouton retour Android
            window.addEventListener('popstate', () => {
                const activeModal = document.querySelector('.modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Fermer donation popup au clic ailleurs
            document.getElementById('donationPopup')?.addEventListener('click', e => {
                if (e.target.id === 'donationPopup') this.closeDonation();
            });
            
            // Swipe navigation
            let touchStartX = 0;
            const content = document.querySelector('.content');
            if (content) {
                content.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
                content.addEventListener('touchend', e => {
                    const deltaX = e.changedTouches[0].clientX - touchStartX;
                    if (Math.abs(deltaX) > 80) {
                        const tabs = ['dashboard', ...Object.keys(this.data.users).filter(id => id !== 'commun'), 'commun'];
                        const currentIndex = tabs.indexOf(this.state.currentTab);
                        if (deltaX > 0 && currentIndex > 0) this.switchTab(tabs[currentIndex - 1]);
                        else if (deltaX < 0 && currentIndex < tabs.length - 1) this.switchTab(tabs[currentIndex + 1]);
                    }
                }, { passive: true });
            }
        },

        // ========== UTILITAIRES ==========
        notify: function(message, type = 'info') {
            const existing = document.querySelector('.app-notification');
            if (existing) existing.remove();
            
            const colors = { info: '#3b82f6', success: '#10b981', error: '#ef4444', warning: '#f59e0b' };
            
            const notification = document.createElement('div');
            notification.className = 'app-notification';
            notification.style.cssText = `
                position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
                background: ${colors[type]}; color: white; padding: 12px 24px;
                border-radius: 12px; font-weight: 500; z-index: 10000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: slideUp 0.3s ease;
                max-width: 90%; text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    };

    // ========== DÃ‰MARRAGE ==========
    // Attendre que le DOM soit prÃªt
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => App.init());
    } else {
        App.init();
    }
    </script>
</body>
</html>