<!DOCTYPE html>
<html lang="fr">
<head>
<script>
    // Appliquer le thÃ¨me immÃ©diatement pour Ã©viter le flash
    (function() {
        const savedTheme = localStorage.getItem('preferredTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body?.setAttribute('data-theme', savedTheme);
    })();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestionnaire de DÃ©penses</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./images/icon-192.png">
	<link rel="apple-touch-icon" sizes="180x180" href="./images/icon-180.png">
	<link rel="icon" type="image/png" sizes="32x32" href="./images/icon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="./images/icon-16.png">
	<meta name="msapplication-TileColor" content="#2563eb">
	<meta name="msapplication-TileImage" content="./images/icon-144.png">
</head>
<body>
    <div class="header">
    <div class="header-title">
        <h1><span class="material-icons header-icon">savings</span> Gestionnaire de DÃ©penses</h1>
    </div>
    <div class="header-buttons">
        <button class="btn-icon" onclick="openShareModal()" title="Partager">
            <span class="material-icons">share</span>
        </button>
        <button class="btn-icon" onclick="showStats()" title="Statistiques">
            <span class="material-icons">insights</span>
        </button>
        <button class="btn-icon" onclick="toggleCalculator()" title="Calculatrice">
            <span class="material-icons">calculate</span>
        </button>
        <button class="btn-icon" onclick="toggleTheme()" title="Changer le thÃ¨me">
            <span class="material-icons">brightness_6</span>
        </button>
        <button class="btn-icon" onclick="openSettings()" title="ParamÃ¨tres">
            <span class="material-icons">settings</span>
        </button>
    </div>
</div>

    <div class="tabs" id="tabs">
        <button class="tab active" onclick="switchTab('dashboard')">Tableau de bord</button>
        <button class="tab" onclick="switchTab('commun')">Commun</button>
        <button class="add-tab" onclick="addNewTab()">+</button>
    </div>

    <div class="content">
        <!-- Tableau de bord -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard" id="dashboard-content">
                <!-- Les cartes utilisateurs seront gÃ©nÃ©rÃ©es ici -->
            </div>
        </div>

        <!-- Onglet Commun -->
        <div id="commun" class="tab-content">
            <!-- Section Balance : Qui doit combien Ã  qui -->
            <div class="section balance-section">
                <div class="section-header">
                    <h2 class="section-title">âš–ï¸ Balance : Qui doit quoi ?</h2>
                    <button class="btn btn-small" onclick="openShareModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        <span class="material-icons" style="font-size: 1rem;">share</span>
                        Partager
                    </button>
                </div>
                <div id="balance-content" class="items-list">
                    <div class="empty-state">Ajoutez des utilisateurs et des transactions pour voir la balance</div>
                </div>
            </div>

            <!-- Section Virements -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ’¸ Virements entre personnes</h2>
                    <button class="btn btn-small" onclick="addTransfer()">+ Ajouter</button>
                </div>
                <div id="transfers-list" class="items-list">
                    <div class="empty-state">Aucun virement ajoutÃ©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Revenus communs</h2>
                    <button class="btn btn-small" onclick="addIncome('commun')">+ Ajouter</button>
                </div>
                <div id="commun-incomes" class="items-list">
                    <div class="empty-state">Aucun revenu ajoutÃ©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">DÃ©penses communes</h2>
                    <button class="btn btn-small" onclick="addCommonExpense()">+ Ajouter</button>
                </div>
                <div id="commun-expenses" class="items-list">
                    <div class="empty-state">Aucune dÃ©pense ajoutÃ©e</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB menu pour actions rapides -->
    <button class="fab" id="fabButton" onclick="toggleFabMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    
    <div class="fab-menu" id="fabMenu">
        <button class="fab-item" onclick="quickAddIncome()">
            <span class="fab-label">ğŸ’µ Ajouter un revenu</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </div>
        </button>
        <button class="fab-item" onclick="quickAddExpense()">
            <span class="fab-label">ğŸ›’ Ajouter une dÃ©pense</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M5 12h14"/>
                </svg>
            </div>
        </button>
        <button class="fab-item" onclick="toggleCalculator()">
            <span class="fab-label">ğŸ§® Calculatrice</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                    <circle cx="8" cy="12" r="1" fill="white"/>
                    <circle cx="12" cy="12" r="1" fill="white"/>
                    <circle cx="16" cy="12" r="1" fill="white"/>
                    <circle cx="8" cy="16" r="1" fill="white"/>
                    <circle cx="12" cy="16" r="1" fill="white"/>
                    <circle cx="16" cy="16" r="1" fill="white"/>
                </svg>
            </div>
        </button>
    </div>

    <!-- Modal pour ajouter un onglet -->
    <div class="modal" id="addTabModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un utilisateur</div>
            <div class="modal-body">
                <input type="text" class="input" id="newTabName" placeholder="Nom de l'utilisateur" style="margin-bottom: 1rem;">
                
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Choisir un avatar :</label>
                <div id="avatarPreview" style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 12px;">
                    <span id="avatarPreviewEmoji" style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                
                <!-- Grille d'avatars en dur dans le HTML -->
                <div id="avatarGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 12px; max-height: 200px; overflow-y: auto;">
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¤')">ğŸ‘¤</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©')">ğŸ‘©</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨')">ğŸ‘¨</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘§')">ğŸ‘§</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¦')">ğŸ‘¦</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§‘')">ğŸ§‘</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦°')">ğŸ‘©â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦°')">ğŸ‘¨â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦±')">ğŸ‘©â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦±')">ğŸ‘¨â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦³')">ğŸ‘©â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦³')">ğŸ‘¨â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§”')">ğŸ§”</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘´')">ğŸ‘´</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘µ')">ğŸ‘µ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§’')">ğŸ§’</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¶')">ğŸ‘¶</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ±')">ğŸ±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¶')">ğŸ¶</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¦Š')">ğŸ¦Š</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ»')">ğŸ»</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¼')">ğŸ¼</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¦')">ğŸ¦</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¸')">ğŸ¸</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸŒŸ')">ğŸŒŸ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ’')">ğŸ’</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ”¥')">ğŸ”¥</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('âš¡')">âš¡</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸŒˆ')">ğŸŒˆ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¯')">ğŸ¯</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTabModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTab()">Ajouter</button>
            </div>
        </div>
    </div>

<!-- Modal pour modifier l'avatar d'un utilisateur -->
    <div class="modal" id="changeAvatarModal">
        <div class="modal-content">
            <div class="modal-header">Modifier l'avatar</div>
            <div class="modal-body">
                <input type="hidden" id="changeAvatarUserId">
                <div class="avatar-preview" id="changeAvatarPreview" style="text-align: center; margin-bottom: 1rem;">
                    <span style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                <div class="avatar-grid" id="changeAvatarGrid">
                    <!-- Les avatars seront gÃ©nÃ©rÃ©s par JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('changeAvatarModal')">Annuler</button>
                <button class="btn" onclick="confirmChangeAvatar()">Enregistrer</button>
            </div>
        </div>
    </div>
	
    <!-- Modal pour ajouter un revenu -->
    <div class="modal" id="addIncomeModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un revenu</div>
            <div class="modal-body">
                <input type="text" class="input" id="incomeName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="incomeAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addIncomeModal')">Annuler</button>
                <button class="btn" onclick="confirmAddIncome()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une dÃ©pense -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter une dÃ©pense</div>
            <div class="modal-body">
                <input type="text" class="input" id="expenseName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="expenseAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddExpense()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une dÃ©pense commune -->
    <div class="modal" id="addCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ›’ Nouvelle dÃ©pense commune</div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="selectedIconBtn" onclick="toggleIconPicker()">
                            <span id="selectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="commonExpenseName" placeholder="Ex: Courses Leclerc" style="flex: 1;">
                    </div>
                    <input type="hidden" id="commonExpenseIcon" value="ğŸ›’">
                </div>
                
                <!-- SÃ©lecteur d'icÃ´nes -->
                <div id="iconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="iconPickerGrid">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Montant (â‚¬)</label>
                    <input type="number" class="input" id="commonExpenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="commonExpensePaidBy">
                        <!-- Rempli dynamiquement -->
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ‘¥ Participants (qui partage cette dÃ©pense)</label>
                    <div id="participantsList" class="participants">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddCommonExpense()">Ajouter</button>
            </div>
        </div>
    </div>

<!-- Modal pour modifier une dÃ©pense commune -->
    <div class="modal" id="editCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">âœï¸ Modifier la dÃ©pense</div>
            <div class="modal-body">
                <input type="hidden" id="editExpenseIndex">
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="editSelectedIconBtn" onclick="toggleEditIconPicker()">
                            <span id="editSelectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="editCommonExpenseName" placeholder="Ex: Courses Leclerc" style="flex: 1;">
                    </div>
                    <input type="hidden" id="editCommonExpenseIcon" value="ğŸ›’">
                </div>
                
                <!-- SÃ©lecteur d'icÃ´nes pour modification -->
                <div id="editIconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="editIconPickerGrid">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Montant (â‚¬)</label>
                    <input type="number" class="input" id="editCommonExpenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="editCommonExpensePaidBy">
                        <!-- Rempli dynamiquement -->
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ‘¥ Participants</label>
                    <div id="editParticipantsList" class="participants">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmEditCommonExpense()">ğŸ’¾ Enregistrer</button>
            </div>
        </div>
    </div>
	
<!-- Modal de partage -->
    <div class="modal" id="shareModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">ğŸ”— Partager ce groupe</div>
            <div class="modal-body">
                
                <!-- Section 1 : Code du groupe -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                        Votre code de groupe unique
                    </p>
                    <div class="share-code" id="shareCode">XXXXX</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-small" onclick="copyShareCode()">
                            <span class="material-icons" style="font-size: 1rem;">content_copy</span>
                            Copier le code
                        </button>
                        <button class="btn btn-small btn-success" onclick="copyShareLink()">
                            <span class="material-icons" style="font-size: 1rem;">link</span>
                            Copier le lien
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.75rem;">
                        ğŸ’¡ Le lien permet d'importer directement les donnÃ©es
                    </p>
                </div>
                
                <!-- Section 2 : Rejoindre un groupe -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ“¥</span> Rejoindre un groupe
                    </h4>
                    <input type="text" class="input" id="joinCode" placeholder="Entrez le code du groupe" style="text-transform: uppercase; letter-spacing: 0.1em; text-align: center; margin-bottom: 0.75rem;">
                    <button class="btn" onclick="joinGroup()" style="width: 100%;">
                        <span class="material-icons">group_add</span>
                        Rejoindre
                    </button>
                </div>
                
                <!-- Section 3 : Export/Import fichier -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ’¾</span> Sauvegarde fichier
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 1rem;">
                        Exportez vos donnÃ©es dans un fichier ou importez depuis un fichier
                    </p>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="exportToFile()" style="flex: 1;">
                            <span class="material-icons">download</span>
                            TÃ©lÃ©charger
                        </button>
                        <button class="btn btn-outline" onclick="importFromFile()" style="flex: 1;">
                            <span class="material-icons">upload</span>
                            Importer
                        </button>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('shareModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>
	
    <!-- Modal pour ajouter un virement -->
    <div class="modal" id="addTransferModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¸ Ajouter un virement</div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                    Un virement reprÃ©sente de l'argent qu'une personne a sur son compte mais qui appartient Ã  quelqu'un d'autre.
                </p>
                <input type="text" class="input" id="transferDescription" placeholder="Description (ex: Salaire avancÃ©)" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="transferAmount" placeholder="Montant" step="0.01" style="margin-bottom: 0.75rem;">
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">De :</label>
                    <select class="input" id="transferFrom" style="margin-bottom: 0.75rem;">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </select>
                </div>
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Vers (Ã  qui appartient l'argent) :</label>
                    <select class="input" id="transferTo">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTransferModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTransfer()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal calculatrice -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">Calculatrice</div>
            <div class="modal-body">
                <div class="calculator">
                    <div class="calc-display" id="calcDisplay">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn" onclick="clearCalc()">C</button>
                        <button class="calc-btn" onclick="appendToCalc('/')">/</button>
                        <button class="calc-btn" onclick="appendToCalc('*')">Ã—</button>
                        <button class="calc-btn" onclick="deleteLastCalc()">â†</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('7')">7</button>
                        <button class="calc-btn" onclick="appendToCalc('8')">8</button>
                        <button class="calc-btn" onclick="appendToCalc('9')">9</button>
                        <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('4')">4</button>
                        <button class="calc-btn" onclick="appendToCalc('5')">5</button>
                        <button class="calc-btn" onclick="appendToCalc('6')">6</button>
                        <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('1')">1</button>
                        <button class="calc-btn" onclick="appendToCalc('2')">2</button>
                        <button class="calc-btn" onclick="appendToCalc('3')">3</button>
                        <button class="calc-btn" onclick="appendToCalc('.')">.</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('0')">0</button>
                        <button class="calc-btn equal" onclick="calculateResult()">=</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('calculatorModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal paramÃ¨tres -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">ParamÃ¨tres</div>
            <div class="modal-body">
    <div style="display: grid; gap: 1rem;">
        <!-- Bouton d'installation (visible seulement si non installÃ©) -->
        <button class="btn" id="installAppBtn" style="background-color: #2563eb; display: none;" onclick="installApp()">
            <span class="material-icons">install_mobile</span>
            Installer l'application
        </button>
		<button class="btn" onclick="togglePinSecurity()">
			<span class="material-icons">lock</span>
			<span id="pinButtonText">Activer le code PIN</span>
		</button>
        <button class="btn" onclick="exportData()">
            <span class="material-icons">download</span>
            Exporter les donnÃ©es
        </button>
		<button class="btn" onclick="exportToPDF()">
            <span class="material-icons">picture_as_pdf</span>
            Exporter en PDF
        </button>
        <button class="btn" onclick="importData()">
            <span class="material-icons">upload</span>
            Importer des donnÃ©es
        </button>
        <button class="btn" style="background-color: #e11d48;" onclick="showDonationPopup()">
            <span class="material-icons">favorite</span>
            Soutenir ce projet gratuit
        </button>
        <button class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="clearCacheAndReload()">
            <span class="material-icons">cached</span>
            Vider le cache (mise Ã  jour)
        </button>
        <button class="btn btn-danger" onclick="confirmReset()">
            <span class="material-icons">delete_forever</span>
            RÃ©initialiser tout
        </button>
        <button class="btn" onclick="showAbout()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
            <span class="material-icons">info</span>
            Ã€ propos
        </button>
    </div>
</div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('settingsModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal statistiques -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">insights</span>
                Statistiques
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Filtres pÃ©riode -->
                <div style="display: flex; background: var(--bg-tertiary); border-radius: 12px; margin: 1rem; overflow: hidden;">
                    <button class="stats-period-btn active" onclick="setStatsPeriod('month')" id="periodMonth">Mois</button>
                    <button class="stats-period-btn" onclick="setStatsPeriod('year')" id="periodYear">AnnÃ©e</button>
                    <button class="stats-period-btn" onclick="setStatsPeriod('all')" id="periodAll">Tous</button>
                </div>
                
                <!-- Navigation mois/annÃ©e -->
                <div id="statsNavigation" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <button onclick="navigateStats(-1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span id="statsPeriodLabel" style="font-weight: 600; min-width: 150px; text-align: center;">dÃ©cembre 2025</span>
                    <button onclick="navigateStats(1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
                
                <!-- Graphique et total -->
                <div style="background: var(--bg-secondary); border-radius: 16px; margin: 0 1rem 1rem; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <!-- Graphique camembert -->
                        <div id="pieChartContainer" style="width: 150px; height: 150px; flex-shrink: 0;">
                            <svg id="pieChart" viewBox="0 0 100 100" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                <!-- GÃ©nÃ©rÃ© dynamiquement -->
                            </svg>
                        </div>
                        <!-- LÃ©gende -->
                        <div style="flex: 1;">
                            <div id="statsTotal" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--primary);">Total: 0 â‚¬</div>
                            <div id="statsLegend" style="display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.875rem;">
                                <!-- GÃ©nÃ©rÃ© dynamiquement -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtre groupe/utilisateur -->
                <div style="margin: 0 1rem 1rem;">
                    <select class="input" id="statsUserFilter" onchange="updateStats()" style="padding: 0.75rem 1rem;">
                        <option value="all">Pour le groupe</option>
                        <!-- Options gÃ©nÃ©rÃ©es dynamiquement -->
                    </select>
                </div>
                
                <!-- Liste des dÃ©penses par catÃ©gorie -->
                <div id="statsCategoryList" style="margin: 0 1rem 1rem;">
                    <!-- GÃ©nÃ©rÃ© dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('statsModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    <script src="js/boot.js"></script>
    <script>
    // Ã‰tat global de l'application
	let currentTab = 'dashboard';
	
	// Fonction de notification
    function showNotification(message, type = 'info') {
        // Supprimer une notification existante
        const existing = document.querySelector('.app-notification');
        if (existing) existing.remove();
        
        const notification = document.createElement('div');
        notification.className = 'app-notification';
        
        // Couleurs selon le type
        let bgColor = '#3b82f6'; // info (bleu)
        if (type === 'success') bgColor = '#10b981'; // vert
        if (type === 'error') bgColor = '#ef4444'; // rouge
        if (type === 'warning') bgColor = '#f59e0b'; // orange
        
        notification.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: ${bgColor};
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
            max-width: 90%;
            text-align: center;
        `;
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // DisparaÃ®t aprÃ¨s 3 secondes
        setTimeout(() => {
            notification.style.animation = 'slideDown 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
	
    let appData = {
        users: {
            'commun': {
                name: 'Commun',
                incomes: [],
                expenses: []
            }
        },
        commonExpenses: [],
        transfers: [], // Nouveau : virements entre personnes
        currentTab: 'dashboard',
        theme: 'dark'
    };

    // Variables globales
    let currentUser = '';
    let calcExpression = '0';
    let confirmCallback = null;
    let actionCount = 0;
	
	// Liste des avatars disponibles
    const availableAvatars = [
        'ğŸ‘¤', 'ğŸ‘©', 'ğŸ‘¨', 'ğŸ‘§', 'ğŸ‘¦', 'ğŸ§‘', 
        'ğŸ‘©â€ğŸ¦°', 'ğŸ‘¨â€ğŸ¦°', 'ğŸ‘©â€ğŸ¦±', 'ğŸ‘¨â€ğŸ¦±', 'ğŸ‘©â€ğŸ¦³', 'ğŸ‘¨â€ğŸ¦³',
        'ğŸ§”', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ§’', 'ğŸ‘¶', 'ğŸ±',
        'ğŸ¶', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¦', 'ğŸ¸',
        'ğŸŒŸ', 'ğŸ’', 'ğŸ”¥', 'âš¡', 'ğŸŒˆ', 'ğŸ¯'
    ];
    
    // Avatar sÃ©lectionnÃ© pour nouvel utilisateur
    let selectedAvatar = 'ğŸ‘¤';
	
    let sessionStart = Date.now();

    // Fonction d'initialisation principale
    function initializeApp() {
        console.log('ğŸš€ Initialisation de l\'application...');
        
        // Appliquer le thÃ¨me sauvegardÃ©
        const preferredTheme = localStorage.getItem('preferredTheme') || 
                              document.body.getAttribute('data-theme') || 
                              'dark';
        
        document.body.setAttribute('data-theme', preferredTheme);
        document.documentElement.setAttribute('data-theme', preferredTheme);
        
        // Charger les donnÃ©es
        loadData();
        
        // Forcer la synchronisation du thÃ¨me
        if (appData.theme !== preferredTheme) {
            appData.theme = preferredTheme;
        }
        
        checkUrlImport();
        initSecurity();
        syncTheme();
        initPWA();
        
        // RENDU PRINCIPAL
        renderApp();
        console.log('âœ… renderApp() exÃ©cutÃ©');
        
        initDonation();
        
        // Masquer le FAB au dÃ©marrage si on est sur le tableau de bord
        const fabButton = document.getElementById('fabButton');
        if (fabButton && appData.currentTab === 'dashboard') {
            fabButton.style.display = 'none';
        }
        
        // Surcharge de exportData pour le tracking
        const originalExportData = window.exportData || exportData;
        window.exportData = function() {
            originalExportData();
            trackUserAction();
            
            if (!localStorage.getItem('exportDonationSuggested')) {
                setTimeout(() => {
                    if (confirm('âœ… DonnÃ©es exportÃ©es avec succÃ¨s !\n\nCette application vous fait gagner du temps ?\nConsidÃ©rez un petit don pour nous aider Ã  la maintenir gratuite ! ğŸ’–')) {
                        showDonationPopup();
                    }
                    localStorage.setItem('exportDonationSuggested', 'true');
                }, 500);
            }
        };
        
        // Sauvegarde automatique
        setInterval(saveData, 5000);
        
        console.log('âœ… Application initialisÃ©e avec succÃ¨s');
    }

// ========== NAVIGATION PAR SWIPE ==========
    
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    const minSwipeDistance = 80;
    const maxVerticalDistance = 100;
    
    // Obtenir la liste ordonnÃ©e des onglets
    function getTabsOrder() {
        const tabs = ['dashboard'];
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                tabs.push(userId);
            }
        }
        tabs.push('commun');
        return tabs;
    }
    
    // Naviguer vers l'onglet prÃ©cÃ©dent
    function goToPreviousTab() {
        const tabs = getTabsOrder();
        const currentIndex = tabs.indexOf(currentTab);
        if (currentIndex > 0) {
            const newTab = tabs[currentIndex - 1];
            switchTab(newTab);
            showSwipeIndicator('â—€', 'left');
        }
    }
    
    // Naviguer vers l'onglet suivant
    function goToNextTab() {
        const tabs = getTabsOrder();
        const currentIndex = tabs.indexOf(currentTab);
        if (currentIndex < tabs.length - 1) {
            const newTab = tabs[currentIndex + 1];
            switchTab(newTab);
            showSwipeIndicator('â–¶', 'right');
        }
    }
    
    // Afficher un indicateur de swipe
    function showSwipeIndicator(symbol, direction) {
        const existing = document.querySelector('.swipe-indicator');
        if (existing) existing.remove();
        
        const indicator = document.createElement('div');
        indicator.className = 'swipe-indicator';
        indicator.textContent = symbol;
        indicator.style.cssText = `
            position: fixed;
            top: 50%;
            ${direction === 'left' ? 'left: 20px' : 'right: 20px'};
            transform: translateY(-50%);
            font-size: 2rem;
            color: var(--primary);
            background: var(--bg-secondary);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            animation: swipeFade 0.4s ease-out forwards;
            pointer-events: none;
        `;
        document.body.appendChild(indicator);
        setTimeout(() => indicator.remove(), 400);
    }
    
    // Gestionnaires tactiles
    function handleTouchStart(e) {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
    }
    
    function handleTouchEnd(e) {
        touchEndX = e.changedTouches[0].clientX;
        touchEndY = e.changedTouches[0].clientY;
        
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;
        
        if (Math.abs(deltaX) > minSwipeDistance && Math.abs(deltaY) < maxVerticalDistance) {
            if (deltaX > 0) {
                goToPreviousTab();
            } else {
                goToNextTab();
            }
        }
    }
    
    // Initialiser le swipe aprÃ¨s le chargement du DOM
    function initSwipe() {
        const contentArea = document.querySelector('.content');
        if (contentArea) {
            contentArea.addEventListener('touchstart', handleTouchStart, { passive: true });
            contentArea.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
    }
    
    // Appeler l'initialisation quand le DOM est prÃªt
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSwipe);
    } else {
        initSwipe();
    }
	
    // Fonctions de gestion des donnÃ©es
    function loadData() {
    try {
        const saved = localStorage.getItem('expenseTrackerData');
        if (saved) {
            const parsedData = JSON.parse(saved);
            
            // VÃ©rifier que les donnÃ©es sont valides
            if (parsedData && parsedData.users) {
                appData = parsedData;
                // Synchroniser currentTab avec les donnÃ©es chargÃ©es
                currentTab = appData.currentTab || 'dashboard';
                console.log('âœ… DonnÃ©es chargÃ©es:', Object.keys(appData.users).length, 'utilisateurs');
            } else {
                console.warn('âš ï¸ DonnÃ©es invalides, utilisation des donnÃ©es par dÃ©faut');
            }
        }
        
        // S'assurer que les structures de base existent
        if (!appData.users) appData.users = { 'commun': { name: 'Commun', incomes: [], expenses: [] } };
        if (!appData.commonExpenses) appData.commonExpenses = [];
        if (!appData.transfers) appData.transfers = [];
        
    } catch (error) {
        console.error('âŒ Erreur chargement donnÃ©es:', error);
        // En cas d'erreur, garder les donnÃ©es par dÃ©faut
    }
    
    // Charger le thÃ¨me prÃ©fÃ©rÃ© de l'utilisateur
    const preferredTheme = localStorage.getItem('preferredTheme');
    if (preferredTheme) {
        appData.theme = preferredTheme;
        document.body.setAttribute('data-theme', preferredTheme);
    } else {
        // Si pas de prÃ©fÃ©rence sauvegardÃ©e, utiliser le thÃ¨me actuel du body ou dark par dÃ©faut
        const currentBodyTheme = document.body.getAttribute('data-theme') || 'dark';
        appData.theme = currentBodyTheme;
        localStorage.setItem('preferredTheme', currentBodyTheme);
    }
}

    function saveData() {
        localStorage.setItem('expenseTrackerData', JSON.stringify(appData));
    }

// VÃ©rifier et corriger l'affichage vide (version simplifiÃ©e)
    function checkAndFixEmptyDisplay() {
        // Cette fonction est maintenant gÃ©rÃ©e par boot.js
        // GardÃ©e pour compatibilitÃ© avec le code existant
        const dashboardContent = document.getElementById('dashboard-content');
        if (dashboardContent && dashboardContent.innerHTML.trim() === '') {
            console.log('ğŸ”„ checkAndFixEmptyDisplay: re-rendu...');
            loadData();
            renderApp();
        }
    }
	
    // Fonctions de donation
    function trackUserAction() {
        actionCount++;
        const sessionTime = Date.now() - sessionStart;
        
        // AprÃ¨s 10 actions ou 5 minutes d'utilisation dans la session
        if ((actionCount >= 10 || sessionTime > 300000) && !sessionStorage.getItem('donationShownThisSession')) {
            const lastPrompt = localStorage.getItem('lastDonationPrompt');
            const hoursSinceLastPrompt = lastPrompt ? 
                (Date.now() - parseInt(lastPrompt)) / (1000 * 60 * 60) : 999;
            
            // Ne pas montrer si dÃ©jÃ  montrÃ© dans les derniÃ¨res 24h
            if (hoursSinceLastPrompt > 24) {
                showDonationPopup();
                sessionStorage.setItem('donationShownThisSession', 'true');
                localStorage.setItem('lastDonationPrompt', Date.now());
            }
        }
    }

    function showDonationPopup() {
        const popup = document.getElementById('donationPopup');
        if (popup) {
            popup.style.display = 'flex';
        }
    }

    function closeDonationPopup() {
        const popup = document.getElementById('donationPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    function initDonation() {
    const donationPopup = document.getElementById('donationPopup');
    if (donationPopup) {
        donationPopup.addEventListener('click', (e) => {
            if (e.target === donationPopup) {
                closeDonationPopup();
            }
        });
    }
    
    const firstUse = localStorage.getItem('firstUse');
    if (!firstUse) {
        localStorage.setItem('firstUse', Date.now());
        
        // Pour les nouveaux utilisateurs : popup aprÃ¨s 10 minutes d'utilisation
        setTimeout(() => {
            if (!sessionStorage.getItem('donationShownThisSession')) {
                showDonationPopup();
                sessionStorage.setItem('donationShownThisSession', 'true');
                localStorage.setItem('lastDonationPrompt', Date.now());
            }
        }, 600000); // 10 minutes
        return;
    }
    
    // Pour les utilisateurs rÃ©guliers : systÃ¨me existant
    const daysSinceFirstUse = (Date.now() - parseInt(firstUse)) / (1000 * 60 * 60 * 24);
    const lastDonationPrompt = localStorage.getItem('lastDonationPrompt');
    const daysSinceLastPrompt = lastDonationPrompt ? 
        (Date.now() - parseInt(lastDonationPrompt)) / (1000 * 60 * 60 * 24) : 999;
    
    // AprÃ¨s 3 jours puis tous les 30 jours
    if (daysSinceFirstUse >= 3 && daysSinceLastPrompt >= 30) {
        setTimeout(() => {
            showDonationPopup();
            localStorage.setItem('lastDonationPrompt', Date.now());
        }, 60000); // 1 minute aprÃ¨s ouverture
    }
}

    // Variable pour stocker l'onglet Ã  restaurer
    let tabToRestoreAfterRender = null;
    
    // Fonctions de rendu
    function renderApp(forceTab = null) {
        // Sauvegarder l'onglet actif AVANT le rendu
        tabToRestoreAfterRender = forceTab || currentTab || appData.currentTab || 'dashboard';
        
        renderTabs();
        renderDashboard();
        renderUserTabs();
        renderCommonTab();
        renderBalance();
        renderTransfers();
        updatePinButtonText();
        
        // Restaurer l'onglet APRÃˆS le rendu
        applyActiveTab(tabToRestoreAfterRender);
    }
    
    // Fonction pour appliquer visuellement l'onglet actif
    function applyActiveTab(tabId) {
        // S'assurer que tabId est valide
        if (!tabId || (tabId !== 'dashboard' && tabId !== 'commun' && !appData.users[tabId])) {
            tabId = 'dashboard';
        }
        
        // Mettre Ã  jour les variables globales
        currentTab = tabId;
        appData.currentTab = tabId;
        
        // DÃ©sactiver tous les boutons d'onglets
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Activer le bon bouton d'onglet
        const allTabs = document.querySelectorAll('.tab');
        allTabs.forEach(tab => {
            const tabText = tab.textContent;
            if (tabId === 'dashboard' && tabText === 'Tableau de bord') {
                tab.classList.add('active');
            } else if (tabId === 'commun' && tabText === 'Balance') {
                tab.classList.add('active');
            } else if (appData.users[tabId] && tabText === appData.users[tabId].name) {
                tab.classList.add('active');
            }
        });
        
        // DÃ©sactiver tous les contenus
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Activer le bon contenu
        const activeContent = document.getElementById(tabId);
        if (activeContent) {
            activeContent.classList.add('active');
        }
        
        // GÃ©rer le FAB
        const fabButton = document.getElementById('fabButton');
        if (fabButton) {
            fabButton.style.display = (tabId === 'dashboard') ? 'none' : 'flex';
        }
    }

// Faire dÃ©filer les onglets pour montrer l'onglet actif
    function scrollTabIntoView(tabId) {
        const tabsContainer = document.getElementById('tabs');
        if (!tabsContainer) return;
        
        const allTabs = tabsContainer.querySelectorAll('.tab');
        let activeTab = null;
        
        allTabs.forEach(tab => {
            const tabText = tab.textContent;
            if (tabId === 'dashboard' && tabText === 'Tableau de bord') {
                activeTab = tab;
            } else if (tabId === 'commun' && tabText === 'Balance') {
                activeTab = tab;
            } else if (appData.users[tabId] && tabText === appData.users[tabId].name) {
                activeTab = tab;
            }
        });
        
        if (activeTab) {
            const tabRect = activeTab.getBoundingClientRect();
            const containerRect = tabsContainer.getBoundingClientRect();
            const scrollLeft = activeTab.offsetLeft - (containerRect.width / 2) + (tabRect.width / 2);
            
            tabsContainer.scrollTo({
                left: Math.max(0, scrollLeft),
                behavior: 'smooth'
            });
        }
    }
	
    function renderTabs() {
        const container = document.getElementById('tabs');
        container.innerHTML = '';
        
        // Onglet Tableau de bord (toujours en premier)
        const dashboardTab = document.createElement('button');
        dashboardTab.className = 'tab';
        dashboardTab.textContent = 'Tableau de bord';
        dashboardTab.onclick = () => switchTab('dashboard');
        container.appendChild(dashboardTab);
        
        // Onglets des utilisateurs
        Object.keys(appData.users).forEach(userId => {
            if (userId === 'commun') return;
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.textContent = appData.users[userId].name;
            tab.onclick = () => switchTab(userId);
            container.appendChild(tab);
        });
        
        // Onglet Balance (anciennement Commun)
        const communTab = document.createElement('button');
        communTab.className = 'tab';
        communTab.textContent = 'Balance';
        communTab.onclick = () => switchTab('commun');
        container.appendChild(communTab);
        
        // Bouton ajouter utilisateur
        const addBtn = document.createElement('button');
        addBtn.className = 'add-tab';
        addBtn.textContent = '+';
        addBtn.onclick = () => openModal('addTabModal');
        container.appendChild(addBtn);
    }

    function renderDashboard() {
        const container = document.getElementById('dashboard-content');
        container.innerHTML = '';
        
        // D'abord, afficher tous les utilisateurs (sauf Commun)
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                renderUserCard(userId, container);
            }
        }
        
        // Ensuite, afficher Commun en dernier
        if (appData.users.commun) {
            renderUserCard('commun', container);
        }
    }
    
    function renderUserCard(userId, container) {
        const user = appData.users[userId];
        const totalIncome = user.incomes.reduce((sum, item) => sum + item.amount, 0);
        let totalExpense = user.expenses.reduce((sum, item) => sum + item.amount, 0);
        
        // Pour la carte "Commun", utiliser le total exact des dÃ©penses communes
        if (userId === 'commun') {
            // Calculer le total exact sans arrondi intermÃ©diaire
            const totalCommon = appData.commonExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            totalExpense = totalCommon;
        }
        
        // Calculer la part des dÃ©penses communes pour les utilisateurs
        let commonShare = 0;
        if (userId !== 'commun') {
            appData.commonExpenses.forEach(expense => {
                if (expense.participants.includes(userId)) {
                    commonShare += expense.amount / expense.participants.length;
                }
            });
        }
        
        const balance = totalIncome - totalExpense - commonShare;
        const isPositive = balance >= 0;
        
        // GÃ©nÃ©rer l'avatar (personnalisÃ© ou par dÃ©faut)
        const avatar = userId === 'commun' ? 'ğŸ‘¥' : (user.avatar || 'ğŸ‘¤');
        
        // Info dette : utiliser calculateBalance() pour cohÃ©rence avec la section Balance
        let transferInfo = '';
        if (userId !== 'commun') {
            const allBalances = calculateBalance();
            const userDebtBalance = allBalances[userId] || 0;
            
            // Seuil pour Ã©viter les erreurs d'arrondi
            if (userDebtBalance > 0.01) {
                transferInfo = `<div class="transfer-info" style="color: var(--success);">ğŸ’° +${userDebtBalance.toFixed(2)}â‚¬ Ã  rÃ©cupÃ©rer</div>`;
            } else if (userDebtBalance < -0.01) {
                transferInfo = `<div class="transfer-info" style="color: var(--danger);">ğŸ’¸ ${userDebtBalance.toFixed(2)}â‚¬ Ã  rembourser</div>`;
            }
        }
        
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
            <div class="user-card-header">
                <div class="user-avatar">${avatar}</div>
                <h3>${user.name}</h3>
            </div>
            <div class="user-card-body">
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <div class="stat-label">Revenus</div>
                        <div class="stat-value">+${totalIncome.toFixed(2)}â‚¬</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-icon">ğŸ“‰</div>
                        <div class="stat-label">DÃ©penses</div>
                        <div class="stat-value">-${userId === 'commun' ? totalExpense.toFixed(2) : (totalExpense + commonShare).toFixed(2)}â‚¬</div>
                    </div>
                </div>
                <div class="balance-card ${isPositive ? 'positive' : 'negative'}">
                    <div class="balance-label">ğŸ’° Solde disponible</div>
                    <div class="balance-value">${balance >= 0 ? '+' : ''}${balance.toFixed(2)}â‚¬</div>
                    ${transferInfo}
                </div>
            </div>
        `;
        container.appendChild(card);
    }

    function renderUserTabs() {
        // CrÃ©er les contenus d'onglets pour chaque utilisateur
        const content = document.querySelector('.content');
        
        // Supprimer les anciens onglets utilisateurs
        document.querySelectorAll('.user-tab-content').forEach(el => el.remove());
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const tabContent = document.createElement('div');
                tabContent.id = userId;
                tabContent.className = 'tab-content user-tab-content';
                
                const userAvatar = appData.users[userId].avatar || 'ğŸ‘¤';
                
                tabContent.innerHTML = `
                    <div class="section user-profile-section">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <button class="user-avatar-btn" onclick="changeUserAvatar('${userId}')" title="Modifier l'avatar">
                                <span class="user-avatar-large">${userAvatar}</span>
                                <span class="avatar-edit-icon">âœï¸</span>
                            </button>
                            <div>
                                <h2 style="margin: 0; font-size: 1.25rem;">${appData.users[userId].name}</h2>
                                <span style="font-size: 0.75rem; color: var(--text-secondary);">Cliquez sur l'avatar pour le modifier</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Revenus</h2>
                            <button class="btn btn-small" onclick="addIncome('${userId}')">+ Ajouter</button>
                        </div>
                        <div id="${userId}-incomes" class="items-list">
                            ${renderItems(appData.users[userId].incomes, 'income', userId)}
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">DÃ©penses</h2>
                            <button class="btn btn-small" onclick="addExpense('${userId}')">+ Ajouter</button>
                        </div>
                        <div id="${userId}-expenses" class="items-list">
                            ${renderItems(appData.users[userId].expenses, 'expense', userId)}
                        </div>
                    </div>
                    
                    <div class="section" style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-danger" onclick="deleteUser('${userId}')">
                            <span class="material-icons">delete_forever</span>
                            Supprimer cet utilisateur
                        </button>
                    </div>
                `;
                
                content.appendChild(tabContent);
            }
        }
    }

    function renderCommonTab() {
        // Rendu des revenus communs
        const commonIncomes = document.getElementById('commun-incomes');
        commonIncomes.innerHTML = renderItems(appData.users.commun.incomes, 'income', 'commun');
        
        // Rendu des dÃ©penses communes
        const commonExpenses = document.getElementById('commun-expenses');
        if (appData.commonExpenses.length === 0) {
            commonExpenses.innerHTML = '<div class="empty-state">Aucune dÃ©pense commune ajoutÃ©e</div>';
        } else {
            commonExpenses.innerHTML = appData.commonExpenses.map((expense, index) => {
                const paidByName = expense.paidBy ? (appData.users[expense.paidBy]?.name || 'Inconnu') : 'Non dÃ©fini';
                const participantNames = expense.participants.map(p => appData.users[p]?.name || 'Inconnu').join(', ');
                const perPerson = expense.participants.length > 0 
                    ? (expense.amount / expense.participants.length).toFixed(2) 
                    : expense.amount.toFixed(2);
                
                return `
                    <div class="item expense-item" onclick="editCommonExpense(${index})" style="cursor: pointer;">
                        <div class="item-icon expense">${expense.icon || 'ğŸ›’'}</div>
                        <div class="item-info">
                            <div class="item-name">${expense.name}</div>
                            <div class="item-meta">
                                ğŸ’³ PayÃ© par <strong>${paidByName}</strong> â€¢ ${perPerson}â‚¬/pers
                            </div>
                            <div class="item-meta" style="font-size: 0.7rem; opacity: 0.7;">
                                ğŸ‘¥ ${participantNames}
                            </div>
                        </div>
                        <div class="item-actions">
                            <span class="item-amount expense">${expense.amount.toFixed(2)}â‚¬</span>
                            <button class="btn-edit" onclick="event.stopPropagation(); editCommonExpense(${index})" title="Modifier">âœï¸</button>
                            <button class="btn-delete" onclick="event.stopPropagation(); deleteCommonExpense(${index})" title="Supprimer">Ã—</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
    }

    function renderItems(items, type, userId) {
        if (items.length === 0) {
            const icon = type === 'income' ? 'ğŸ“ˆ' : 'ğŸ“‰';
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">${icon}</div>
                    <div class="empty-state-text">Aucun Ã©lÃ©ment ajoutÃ©</div>
                </div>
            `;
        }
        
        const icon = type === 'income' ? 'ğŸ’µ' : 'ğŸ›’';
        const itemClass = type === 'income' ? 'income-item' : 'expense-item';
        
        return items.map((item, index) => `
            <div class="item ${itemClass}">
                <div class="item-icon ${type}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-meta">${new Date(item.date).toLocaleDateString('fr-FR')}</div>
                </div>
                <div class="item-actions">
                    <span class="item-amount ${type}">${type === 'income' ? '+' : '-'}${item.amount.toFixed(2)}â‚¬</span>
                    <button class="btn-delete" onclick="deleteItem('${userId}', '${type}s', ${index})">Ã—</button>
                </div>
            </div>
        `).join('');
    }

    // Gestion des onglets
    function switchTab(tabId) {
        applyActiveTab(tabId);
        saveData();
        scrollTabIntoView(tabId);
    }

    function addNewTab() {
        document.getElementById('newTabName').value = '';
        selectedAvatar = 'ğŸ‘¤';
        
        // Mettre Ã  jour la prÃ©visualisation
        document.getElementById('avatarPreviewEmoji').textContent = 'ğŸ‘¤';
        
        // RÃ©initialiser la sÃ©lection visuelle
        document.querySelectorAll('#avatarGrid .avatar-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.textContent.trim() === 'ğŸ‘¤') {
                btn.classList.add('selected');
            }
        });
        
        openModal('addTabModal');
    }
    
    function selectAvatar(avatar) {
        selectedAvatar = avatar;
        
        // Mettre Ã  jour la prÃ©visualisation
        document.getElementById('avatarPreviewEmoji').textContent = avatar;
        
        // Mettre Ã  jour la sÃ©lection visuelle
        document.querySelectorAll('#avatarGrid .avatar-btn').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.textContent.trim() === avatar) {
                btn.classList.add('selected');
            }
        });
    }

// ========== MODIFICATION D'AVATAR UTILISATEUR ==========
    
    let avatarToChange = 'ğŸ‘¤';
    let userIdToChangeAvatar = null;
    
    function changeUserAvatar(userId) {
        userIdToChangeAvatar = userId;
        avatarToChange = appData.users[userId].avatar || 'ğŸ‘¤';
        
        // GÃ©nÃ©rer la grille d'avatars
        const grid = document.getElementById('changeAvatarGrid');
        grid.innerHTML = availableAvatars.map(avatar => `
            <button type="button" class="avatar-option ${avatar === avatarToChange ? 'selected' : ''}" 
                    onclick="selectAvatarToChange('${avatar}')">${avatar}</button>
        `).join('');
        
        // Mettre Ã  jour la prÃ©visualisation
        document.getElementById('changeAvatarPreview').innerHTML = `<span style="font-size: 3rem;">${avatarToChange}</span>`;
        
        openModal('changeAvatarModal');
    }
    
    function selectAvatarToChange(avatar) {
        avatarToChange = avatar;
        
        // Mettre Ã  jour la prÃ©visualisation
        document.getElementById('changeAvatarPreview').innerHTML = `<span style="font-size: 3rem;">${avatar}</span>`;
        
        // Mettre Ã  jour les classes de sÃ©lection
        document.querySelectorAll('#changeAvatarGrid .avatar-option').forEach(btn => {
            btn.classList.remove('selected');
            if (btn.textContent === avatar) {
                btn.classList.add('selected');
            }
        });
    }
    
    function confirmChangeAvatar() {
        if (userIdToChangeAvatar && appData.users[userIdToChangeAvatar]) {
            appData.users[userIdToChangeAvatar].avatar = avatarToChange;
            saveData();
            closeModal('changeAvatarModal');
            renderApp(userIdToChangeAvatar);
            showNotification('âœ… Avatar modifiÃ© !', 'success');
        }
    }
	
    function confirmAddTab() {
        const name = document.getElementById('newTabName').value.trim();
        if (name) {
            const userId = 'user_' + Date.now();
            appData.users[userId] = {
                name: name,
                avatar: selectedAvatar, // Sauvegarder l'avatar choisi
                incomes: [],
                expenses: []
            };
            saveData();
            closeModal('addTabModal');
            renderApp(userId);
        }
    }

    // Gestion des revenus
    function addIncome(userId) {
        currentUser = userId;
        document.getElementById('incomeName').value = '';
        document.getElementById('incomeAmount').value = '';
        openModal('addIncomeModal');
    }

    function confirmAddIncome() {
        const name = document.getElementById('incomeName').value.trim();
        const amount = parseFloat(document.getElementById('incomeAmount').value);
        
        if (name && amount > 0) {
            const savedTab = currentTab; // Sauvegarder l'onglet actuel
            appData.users[currentUser].incomes.push({
                name: name,
                amount: amount,
                date: new Date().toISOString()
            });
            saveData();
            closeModal('addIncomeModal');
            renderApp(savedTab); // Passer l'onglet Ã  restaurer
            trackUserAction();
        }
    }

    // Gestion des dÃ©penses
    function addExpense(userId) {
        currentUser = userId;
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        openModal('addExpenseModal');
    }

    function confirmAddExpense() {
        const name = document.getElementById('expenseName').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        
        if (name && amount > 0) {
            const savedTab = currentTab;
            appData.users[currentUser].expenses.push({
                name: name,
                amount: amount,
                date: new Date().toISOString()
            });
            saveData();
            closeModal('addExpenseModal');
            renderApp(savedTab);
            trackUserAction();
        }
    }

    // Gestion des dÃ©penses communes
    function addCommonExpense() {
        document.getElementById('commonExpenseName').value = '';
        document.getElementById('commonExpenseAmount').value = '';
        
        // RÃ©initialiser l'icÃ´ne par dÃ©faut
        document.getElementById('commonExpenseIcon').value = 'ğŸ›’';
        document.getElementById('selectedIconDisplay').textContent = 'ğŸ›’';
        document.getElementById('iconPickerContainer').style.display = 'none';
        iconPickerVisible = false;
        
        // GÃ©nÃ©rer la liste "PayÃ© par"
        const paidBySelect = document.getElementById('commonExpensePaidBy');
        paidBySelect.innerHTML = '';
        
        // GÃ©nÃ©rer la liste des participants
        const participantsList = document.getElementById('participantsList');
        participantsList.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const userName = appData.users[userId].name;
                
                // Option pour "PayÃ© par"
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = userName;
                paidBySelect.appendChild(option);
                
                // Checkbox pour participants (cochÃ©s par dÃ©faut)
                const checkbox = document.createElement('div');
                checkbox.className = 'participant-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="participant_${userId}" value="${userId}" checked>
                    <label for="participant_${userId}">${userName}</label>
                `;
                participantsList.appendChild(checkbox);
            }
        }
        
        openModal('addCommonExpenseModal');
    }

    function confirmAddCommonExpense() {
        const name = document.getElementById('commonExpenseName').value.trim();
        const amount = parseFloat(document.getElementById('commonExpenseAmount').value);
        const paidBy = document.getElementById('commonExpensePaidBy').value;
        
        if (!name || isNaN(amount) || amount <= 0) {
            alert('Veuillez remplir tous les champs correctement');
            return;
        }
        
        if (!paidBy) {
            alert('Veuillez sÃ©lectionner qui a payÃ©');
            return;
        }
        
        const participants = [];
        document.querySelectorAll('#participantsList input[type="checkbox"]:checked').forEach(checkbox => {
            participants.push(checkbox.value);
        });
        
        if (participants.length === 0) {
            alert('Veuillez sÃ©lectionner au moins un participant');
            return;
        }
        
        const savedTab = currentTab;
        const icon = document.getElementById('commonExpenseIcon').value || 'ğŸ›’';
        
        appData.commonExpenses.push({
            name: name,
            amount: amount,
            paidBy: paidBy,
            participants: participants,
            icon: icon,
            date: new Date().toISOString()
        });
        
        saveData();
        closeModal('addCommonExpenseModal');
        renderApp(savedTab);
        trackUserAction();
        
        const paidByName = appData.users[paidBy]?.name || 'Inconnu';
        const perPerson = (amount / participants.length).toFixed(2);
        showSuccessMessage(`${paidByName} a payÃ© ${amount.toFixed(2)}â‚¬ (${perPerson}â‚¬/pers)`);
    }

    // Suppression d'un utilisateur
    function deleteUser(userId) {
        const userName = appData.users[userId].name;
        confirmCallback = () => {
            // VÃ©rifier si l'utilisateur participe Ã  des dÃ©penses communes
            const participatesInCommon = appData.commonExpenses.some(expense => 
                expense.participants.includes(userId)
            );
            
            if (participatesInCommon) {
                alert(`Impossible de supprimer ${userName} car il/elle participe Ã  des dÃ©penses communes. Retirez d'abord sa participation aux dÃ©penses communes.`);
                return;
            }
            
            // Supprimer l'utilisateur
            delete appData.users[userId];
            
            // Si on Ã©tait sur cet onglet, retourner au tableau de bord
            if (appData.currentTab === userId) {
                appData.currentTab = 'dashboard';
            }
            
            saveData();
            renderApp();
        };
        showConfirm(`ÃŠtes-vous sÃ»r de vouloir supprimer l'utilisateur "${userName}" et toutes ses donnÃ©es ?`);
    }

    // Suppression d'Ã©lÃ©ments
    function deleteItem(userId, type, index) {
        confirmCallback = () => {
            appData.users[userId][type].splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('ÃŠtes-vous sÃ»r de vouloir supprimer cet Ã©lÃ©ment ?');
    }

// ========== GESTION DES VIREMENTS ==========
    
    // Ouvrir le modal d'ajout de virement
    function addTransfer() {
        document.getElementById('transferDescription').value = '';
        document.getElementById('transferAmount').value = '';
        
        // GÃ©nÃ©rer les listes dÃ©roulantes
        const transferFrom = document.getElementById('transferFrom');
        const transferTo = document.getElementById('transferTo');
        transferFrom.innerHTML = '';
        transferTo.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const option1 = document.createElement('option');
                option1.value = userId;
                option1.textContent = appData.users[userId].name;
                transferFrom.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = userId;
                option2.textContent = appData.users[userId].name;
                transferTo.appendChild(option2);
            }
        }
        
        openModal('addTransferModal');
    }
    
    // Confirmer l'ajout d'un virement
    function confirmAddTransfer() {
        const description = document.getElementById('transferDescription').value.trim();
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const fromUser = document.getElementById('transferFrom').value;
        const toUser = document.getElementById('transferTo').value;
        
        if (!description) {
            alert('Veuillez entrer une description');
            return;
        }
        if (!amount || amount <= 0) {
            alert('Veuillez entrer un montant valide');
            return;
        }
        if (fromUser === toUser) {
            alert('La personne source et destination doivent Ãªtre diffÃ©rentes');
            return;
        }
        
        const savedTab = currentTab;
        
        if (!appData.transfers) {
            appData.transfers = [];
        }
        
        appData.transfers.push({
            description: description,
            amount: amount,
            from: fromUser,
            to: toUser,
            date: new Date().toISOString()
        });
        
        saveData();
        closeModal('addTransferModal');
        renderApp(savedTab);
        trackUserAction();
        showSuccessMessage('Virement ajoutÃ© !');
    }
    
    // Supprimer un virement
    function deleteTransfer(index) {
        confirmCallback = () => {
            appData.transfers.splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce virement ?');
    }
    
    // Calculer la balance entre tous les utilisateurs
    function calculateBalance() {
        const balances = {}; // { "userId": montant } positif = doit recevoir, nÃ©gatif = doit payer
        
        // Initialiser les balances Ã  0 pour chaque utilisateur
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                balances[userId] = 0;
            }
        }
        
        // 1. Prendre en compte les virements
        if (appData.transfers) {
            appData.transfers.forEach(transfer => {
                balances[transfer.from] -= transfer.amount;
                balances[transfer.to] += transfer.amount;
            });
        }
        
        // 2. Prendre en compte les dÃ©penses communes (avec "PayÃ© par")
        appData.commonExpenses.forEach(expense => {
            const paidBy = expense.paidBy;
            const participants = expense.participants || [];
            const amount = expense.amount;
            
            if (participants.length === 0) return;
            
            const sharePerPerson = amount / participants.length;
            
            // Le payeur a avancÃ© tout le montant (il doit recevoir)
            if (paidBy && balances[paidBy] !== undefined) {
                balances[paidBy] += amount;
            }
            
            // Chaque participant doit sa part (il doit payer)
            participants.forEach(participantId => {
                if (balances[participantId] !== undefined) {
                    balances[participantId] -= sharePerPerson;
                }
            });
        });
        
        return balances;
    }
    
    // Calculer "qui doit combien Ã  qui" Ã  partir des balances
    function calculateDebts() {
        const balances = calculateBalance();
        const debts = []; // { from: userId, to: userId, amount: number }
        
        // SÃ©parer les dÃ©biteurs et crÃ©diteurs
        const debtors = []; // Ceux qui doivent de l'argent (balance nÃ©gative)
        const creditors = []; // Ceux qui doivent recevoir de l'argent (balance positive)
        
        for (const userId in balances) {
            const balance = balances[userId];
            if (balance < -0.01) { // Seuil pour Ã©viter les erreurs d'arrondi
                debtors.push({ userId, amount: Math.abs(balance) });
            } else if (balance > 0.01) {
                creditors.push({ userId, amount: balance });
            }
        }
        
        // Algorithme simple pour minimiser les transactions
        debtors.sort((a, b) => b.amount - a.amount);
        creditors.sort((a, b) => b.amount - a.amount);
        
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            
            const amount = Math.min(debtor.amount, creditor.amount);
            
            if (amount > 0.01) {
                debts.push({
                    from: debtor.userId,
                    to: creditor.userId,
                    amount: amount
                });
            }
            
            debtor.amount -= amount;
            creditor.amount -= amount;
            
            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }
        
        return debts;
    }
    
    // Afficher la section Balance
    function renderBalance() {
        const container = document.getElementById('balance-content');
        if (!container) return;
        
        const userCount = Object.keys(appData.users).filter(id => id !== 'commun').length;
        
        if (userCount < 2) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">ğŸ‘¥</div>
                    <div style="font-weight: 600; color: var(--text-primary);">Ajoutez des participants</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Il faut au moins 2 personnes pour calculer la balance</div>
                </div>
            `;
            return;
        }
        
        const debts = calculateDebts();
        
        if (debts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
                    <div style="font-weight: 600; color: var(--success); font-size: 1.125rem;">Tout est Ã©quilibrÃ© !</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Personne ne doit d'argent Ã  personne</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = debts.map(debt => {
            const fromName = appData.users[debt.from]?.name || 'Inconnu';
            const toName = appData.users[debt.to]?.name || 'Inconnu';
            const fromAvatar = appData.users[debt.from]?.avatar || fromName.charAt(0).toUpperCase();
            
            return `
                <div class="debt-card">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div class="debt-avatar">${fromAvatar}</div>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span style="font-weight: 700; color: var(--danger);">${fromName}</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">doit payer Ã </span>
                            <span style="font-weight: 700; color: var(--success);">${toName}</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.5rem;">
                        <div class="debt-amount">${debt.amount.toFixed(2)}â‚¬</div>
                        <button class="btn-paid" onclick="markAsPaid('${debt.from}', '${debt.to}', ${debt.amount.toFixed(2)})">
                            âœ… C'est payÃ© !
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }
    
	// Marquer une dette comme payÃ©e
    function markAsPaid(fromUserId, toUserId, amount) {
        const fromName = appData.users[fromUserId]?.name || 'Inconnu';
        const toName = appData.users[toUserId]?.name || 'Inconnu';
        
        const confirmed = confirm(
            `âœ… Confirmer le remboursement ?\n\n` +
            `${fromName} a payÃ© ${amount.toFixed(2)}â‚¬ Ã  ${toName}\n\n` +
            `Un virement sera crÃ©Ã© pour Ã©quilibrer les comptes.`
        );
        
        if (!confirmed) return;
        
        // Initialiser le tableau des virements s'il n'existe pas
        if (!appData.transfers) {
            appData.transfers = [];
        }
        
        // CrÃ©er un virement de remboursement
        const today = new Date();
        const dateStr = today.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        appData.transfers.push({
            description: `Remboursement du ${dateStr}`,
            amount: amount,
            from: toUserId,  // InversÃ© : celui qui reÃ§oit l'argent le "dÃ©tient"
            to: fromUserId,   // Celui qui a payÃ© rÃ©cupÃ¨re son dÃ»
            date: today.toISOString(),
            isSettlement: true  // Marquer comme remboursement
        });
        
        saveData();
        renderApp();
        showNotification(`âœ… ${fromName} a remboursÃ© ${amount.toFixed(2)}â‚¬ Ã  ${toName}`, 'success');
    }
    
    // Annuler un remboursement (rÃ©activer la dette)
    function cancelSettlement(index) {
        const transfer = appData.transfers[index];
        if (!transfer) return;
        
        const confirmed = confirm(
            `ğŸ”„ Annuler ce remboursement ?\n\n` +
            `"${transfer.description}" - ${transfer.amount.toFixed(2)}â‚¬\n\n` +
            `La dette sera rÃ©activÃ©e.`
        );
        
        if (!confirmed) return;
        
        appData.transfers.splice(index, 1);
        saveData();
        renderApp();
        showNotification('ğŸ”„ Remboursement annulÃ©, dette rÃ©activÃ©e', 'info');
    }
	
    // Afficher la liste des virements
    function renderTransfers() {
        const container = document.getElementById('transfers-list');
        if (!container) return;
        
        if (!appData.transfers || appData.transfers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’¸</div>
                    <div class="empty-state-text">Aucun virement ajoutÃ©</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = appData.transfers.map((transfer, index) => {
            const fromName = appData.users[transfer.from]?.name || 'Inconnu';
            const toName = appData.users[transfer.to]?.name || 'Inconnu';
            const isSettlement = transfer.isSettlement === true;
            
            // IcÃ´ne et style diffÃ©rent pour les remboursements
            const icon = isSettlement ? 'âœ…' : 'ğŸ’¸';
            const itemClass = isSettlement ? 'item settlement-item' : 'item transfer-item';
            const metaText = isSettlement 
                ? `${toName} a remboursÃ© ${fromName}`
                : `${fromName} dÃ©tient l'argent de ${toName}`;
            
            return `
                <div class="${itemClass}">
                    <div class="item-icon ${isSettlement ? 'settlement' : 'transfer'}">${icon}</div>
                    <div class="item-info">
                        <div class="item-name">${transfer.description}</div>
                        <div class="item-meta">${metaText}</div>
                        ${isSettlement ? `<div class="item-meta" style="font-size: 0.7rem; color: var(--success);">Cliquez sur ğŸ”„ pour annuler</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <span class="item-amount ${isSettlement ? 'settlement' : 'transfer'}">${transfer.amount.toFixed(2)}â‚¬</span>
                        ${isSettlement 
                            ? `<button class="btn-undo" onclick="cancelSettlement(${index})" title="Annuler le remboursement">ğŸ”„</button>`
                            : `<button class="btn-delete" onclick="deleteTransfer(${index})">Ã—</button>`
                        }
                    </div>
                </div>
            `;
        }).join('');
    }
	
	// ========== SYSTÃˆME DE PARTAGE ==========
    
    // GÃ©nÃ©rer ou rÃ©cupÃ©rer l'ID du groupe
    function getGroupId() {
        if (!appData.groupId) {
            appData.groupId = generateGroupCode();
            saveData();
        }
        return appData.groupId;
    }
    
    // GÃ©nÃ©rer un code de groupe unique (5 caractÃ¨res)
    function generateGroupCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 5; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
    
    // Ouvrir le modal de partage
    function openShareModal() {
        const code = getGroupId();
        document.getElementById('shareCode').textContent = code;
        document.getElementById('joinCode').value = '';
        openModal('shareModal');
    }
    
    // Copier le code de partage
    function copyShareCode() {
        const code = document.getElementById('shareCode').textContent;
        copyToClipboard(code, 'Code copiÃ© ! ğŸ“‹');
    }
    
    // Compresser une chaÃ®ne (algorithme LZ simple)
    function compressData(data) {
        try {
            const jsonString = JSON.stringify(data);
            // Encodage simple avec compression basique
            const compressed = btoa(unescape(encodeURIComponent(jsonString)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
            return compressed;
        } catch (e) {
            console.error('Erreur compression:', e);
            return null;
        }
    }
    
    // DÃ©compresser une chaÃ®ne
    function decompressData(compressed) {
        try {
            // Restaurer les caractÃ¨res base64
            let base64 = compressed
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            // Ajouter le padding si nÃ©cessaire
            while (base64.length % 4) {
                base64 += '=';
            }
            const jsonString = decodeURIComponent(escape(atob(base64)));
            return JSON.parse(jsonString);
        } catch (e) {
            console.error('Erreur dÃ©compression:', e);
            return null;
        }
    }
    
    // Copier le lien de partage
    async function copyShareLink() {
        try {
            // CrÃ©er une structure de donnÃ©es minimale
            const minimalData = {
                g: appData.groupId,
                u: {},
                c: [],
                t: []
            };
            
            // Utilisateurs (avec clÃ©s courtes)
            for (const userId in appData.users) {
                const user = appData.users[userId];
                const shortId = userId === 'commun' ? 'c' : userId.replace('user_', 'u');
                minimalData.u[shortId] = {
                    n: user.name,
                    i: user.incomes || [],
                    e: user.expenses || []
                };
            }
            
            // DÃ©penses communes (avec clÃ©s courtes)
            appData.commonExpenses.forEach(exp => {
                minimalData.c.push({
                    n: exp.name,
                    a: exp.amount,
                    p: exp.paidBy ? exp.paidBy.replace('user_', 'u') : '',
                    ps: exp.participants.map(p => p.replace('user_', 'u')),
                    ic: exp.icon || 'ğŸ›’'
                });
            });
            
            // Transferts (avec clÃ©s courtes)
            appData.transfers.forEach(t => {
                minimalData.t.push({
                    d: t.description,
                    a: t.amount,
                    f: t.from.replace('user_', 'u'),
                    o: t.to.replace('user_', 'u')
                });
            });
            
            // Compresser en base64
            const jsonStr = JSON.stringify(minimalData);
            const compressed = btoa(unescape(encodeURIComponent(jsonStr)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
            
            const longUrl = `${window.location.origin}${window.location.pathname}?i=${compressed}`;
            
            // Essayer de raccourcir avec is.gd
            showNotification('â³ CrÃ©ation du lien court...', 'info');
            
            try {
                const response = await fetch(`https://is.gd/create.php?format=json&url=${encodeURIComponent(longUrl)}`);
                const data = await response.json();
                
                if (data.shorturl) {
                    await navigator.clipboard.writeText(data.shorturl);
                    showNotification('âœ… Lien court copiÃ© ! ' + data.shorturl, 'success');
                    return;
                }
            } catch (e) {
                console.log('Raccourcissement Ã©chouÃ©, utilisation du lien long');
            }
            
            // Si le raccourcissement Ã©choue, utiliser le lien long
            if (longUrl.length > 2000) {
                showNotification('âš ï¸ Lien trop long. Essayez de rÃ©duire les donnÃ©es.', 'error');
                return;
            }
            
            await navigator.clipboard.writeText(longUrl);
            showNotification(`âœ… Lien copiÃ© (${longUrl.length} car.)`, 'success');
            
        } catch (error) {
            console.error('Erreur partage:', error);
            showNotification('âŒ Erreur lors de la crÃ©ation du lien', 'error');
        }
    }
    
    // Fonction utilitaire pour copier dans le presse-papier
    function copyToClipboard(text, successMessage) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage(successMessage);
            }).catch(() => {
                fallbackCopy(text, successMessage);
            });
        } else {
            fallbackCopy(text, successMessage);
        }
    }
    
    // Fallback pour copier sur les anciens navigateurs
    function fallbackCopy(text, successMessage) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showSuccessMessage(successMessage);
        } catch (err) {
            alert('Erreur lors de la copie. Copiez manuellement : ' + text);
        }
        document.body.removeChild(textArea);
    }
    
    // Exporter les donnÃ©es dans un fichier
    function exportToFile() {
        const dataToExport = {
            groupId: getGroupId(),
            users: appData.users,
            commonExpenses: appData.commonExpenses,
            transfers: appData.transfers || [],
            exportDate: new Date().toISOString(),
            version: '2.0'
        };
        
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `depenses_${getGroupId()}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccessMessage('Fichier tÃ©lÃ©chargÃ© ! ğŸ“¥');
    }
    
    // Importer les donnÃ©es depuis un fichier
    function importFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // VÃ©rifier que c'est un fichier valide
                    if (!importedData.users || !importedData.groupId) {
                        alert('âŒ Fichier invalide.\n\nCe fichier ne contient pas de donnÃ©es de dÃ©penses valides.');
                        return;
                    }
                    
                    const userCount = Object.keys(importedData.users).filter(id => id !== 'commun').length;
                    const expenseCount = (importedData.commonExpenses || []).length;
                    const transferCount = (importedData.transfers || []).length;
                    
                    if (confirm(`ğŸ“¦ Importer les donnÃ©es du groupe "${importedData.groupId}" ?\n\n` +
                               `â€¢ ${userCount} utilisateur(s)\n` +
                               `â€¢ ${expenseCount} dÃ©pense(s) commune(s)\n` +
                               `â€¢ ${transferCount} virement(s)\n\n` +
                               `âš ï¸ Cela remplacera vos donnÃ©es actuelles.`)) {
                        mergeImportedData(importedData);
                        showSuccessMessage('DonnÃ©es importÃ©es ! âœ…');
                        closeModal('shareModal');
                    }
                } catch (error) {
                    alert('âŒ Erreur lors de l\'import.\n\nLe fichier est corrompu ou invalide.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // Rejoindre un groupe avec un code
    function joinGroup() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        
        if (!code || code.length < 5) {
            alert('âš ï¸ Code invalide\n\nEntrez un code de 5 caractÃ¨res.');
            return;
        }
        
        // VÃ©rifier si c'est le mÃªme groupe
        if (code === getGroupId()) {
            showSuccessMessage('Vous Ãªtes dÃ©jÃ  dans ce groupe ! ğŸ‘');
            return;
        }
        
        // Informer l'utilisateur comment synchroniser
        alert(`ğŸ“² Pour rejoindre le groupe "${code}" :\n\n` +
              `1. Demandez au propriÃ©taire du groupe de vous envoyer :\n` +
              `   â€¢ Le lien de partage (bouton "Copier le lien")\n` +
              `   â€¢ Ou le fichier de sauvegarde (bouton "TÃ©lÃ©charger")\n\n` +
              `2. Ouvrez le lien reÃ§u\n` +
              `   Ou importez le fichier (bouton "Importer")\n\n` +
              `ğŸ’¡ Le propriÃ©taire du groupe a le code "${getGroupId()}"`);
    }
    
    // Fusionner les donnÃ©es importÃ©es
    function mergeImportedData(importedData) {
        appData.groupId = importedData.groupId;
        appData.users = importedData.users;
        appData.commonExpenses = importedData.commonExpenses || [];
        appData.transfers = importedData.transfers || [];
        
        saveData();
        renderApp();
    }
    
    // VÃ©rifier s'il y a des donnÃ©es Ã  importer dans l'URL
    function checkUrlImport() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Nouveau format compressÃ© (paramÃ¨tre 'i')
        const compressedData = urlParams.get('i');
        // Ancien format (paramÃ¨tre 'import')
        const legacyData = urlParams.get('import');
        
        let importedData = null;
        
        if (compressedData) {
            // Nouveau format compressÃ©
            const minData = decompressData(compressedData);
            if (minData) {
                // Reconstruire les donnÃ©es complÃ¨tes
                importedData = {
                    groupId: minData.g,
                    users: {},
                    commonExpenses: [],
                    transfers: []
                };
                
                // Reconstruire les utilisateurs
                for (const shortId in minData.u) {
                    const userData = minData.u[shortId];
                    const fullId = shortId === 'c' ? 'commun' : shortId.replace('u', 'user_');
                    importedData.users[fullId] = {
                        name: userData.n,
                        incomes: (userData.i || []).map(i => ({ 
                            name: i.n, 
                            amount: i.a, 
                            date: new Date().toISOString() 
                        })),
                        expenses: (userData.e || []).map(e => ({ 
                            name: e.n, 
                            amount: e.a, 
                            date: new Date().toISOString() 
                        }))
                    };
                }
                
                // Reconstruire les dÃ©penses communes
                importedData.commonExpenses = (minData.c || []).map(exp => ({
                    name: exp.n,
                    amount: exp.a,
                    paidBy: exp.p ? exp.p.replace('u', 'user_') : null,
                    participants: exp.ps.map(p => p === 'c' ? 'commun' : p.replace('u', 'user_')),
                    icon: exp.ic || 'ğŸ›’',
                    date: new Date().toISOString()
                }));
                
                // Reconstruire les virements
                importedData.transfers = (minData.t || []).map(t => ({
                    description: t.d,
                    amount: t.a,
                    from: t.f.replace('u', 'user_'),
                    to: t.o.replace('u', 'user_'),
                    date: new Date().toISOString()
                }));
            }
        } else if (legacyData) {
            // Ancien format base64 standard
            try {
                const jsonString = decodeURIComponent(escape(atob(legacyData)));
                importedData = JSON.parse(jsonString);
            } catch (e) {
                console.error('Erreur parsing ancien format:', e);
            }
        }
        
        if (importedData) {
            try {
                const userCount = Object.keys(importedData.users).filter(id => id !== 'commun').length;
                const expenseCount = (importedData.commonExpenses || []).length;
                
                if (confirm(`ğŸ“¦ Importer les donnÃ©es du groupe "${importedData.groupId}" ?\n\n` +
                           `â€¢ ${userCount} utilisateur(s)\n` +
                           `â€¢ ${expenseCount} dÃ©pense(s) commune(s)\n\n` +
                           `âš ï¸ Cela remplacera vos donnÃ©es actuelles.`)) {
                    mergeImportedData(importedData);
                    showSuccessMessage('DonnÃ©es importÃ©es depuis le lien ! âœ…');
                }
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                console.error('Erreur import URL:', error);
            }
        }
    }
	
	// ========== MODIFICATION DES DÃ‰PENSES ==========
    
    let editIconPickerVisible = false;
    
    // Ouvrir le modal de modification d'une dÃ©pense commune
    function editCommonExpense(index) {
        const expense = appData.commonExpenses[index];
        if (!expense) return;
        
        // Stocker l'index
        document.getElementById('editExpenseIndex').value = index;
        
        // Remplir les champs
        document.getElementById('editCommonExpenseName').value = expense.name;
        document.getElementById('editCommonExpenseAmount').value = expense.amount;
        document.getElementById('editCommonExpenseIcon').value = expense.icon || 'ğŸ›’';
        document.getElementById('editSelectedIconDisplay').textContent = expense.icon || 'ğŸ›’';
        
        // Masquer le sÃ©lecteur d'icÃ´nes
        document.getElementById('editIconPickerContainer').style.display = 'none';
        editIconPickerVisible = false;
        
        // GÃ©nÃ©rer la liste "PayÃ© par"
        const paidBySelect = document.getElementById('editCommonExpensePaidBy');
        paidBySelect.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = appData.users[userId].name;
                if (userId === expense.paidBy) {
                    option.selected = true;
                }
                paidBySelect.appendChild(option);
            }
        }
        
        // GÃ©nÃ©rer la liste des participants
        const participantsList = document.getElementById('editParticipantsList');
        participantsList.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const userName = appData.users[userId].name;
                const isParticipant = expense.participants.includes(userId);
                
                const checkbox = document.createElement('div');
                checkbox.className = 'participant-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="edit_participant_${userId}" value="${userId}" ${isParticipant ? 'checked' : ''}>
                    <label for="edit_participant_${userId}">${userName}</label>
                `;
                participantsList.appendChild(checkbox);
            }
        }
        
        openModal('editCommonExpenseModal');
    }
    
    // Toggle du sÃ©lecteur d'icÃ´nes pour modification
    function toggleEditIconPicker() {
        const container = document.getElementById('editIconPickerContainer');
        editIconPickerVisible = !editIconPickerVisible;
        
        if (editIconPickerVisible) {
            const grid = document.getElementById('editIconPickerGrid');
            const currentIcon = document.getElementById('editCommonExpenseIcon').value;
            
            grid.innerHTML = availableIcons.map(item => `
                <button type="button" 
                        class="icon-picker-item ${item.icon === currentIcon ? 'selected' : ''}" 
                        onclick="selectEditIcon('${item.icon}')"
                        title="${item.label}">
                    ${item.icon}
                </button>
            `).join('');
            
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }
    
    // SÃ©lectionner une icÃ´ne pour modification
    function selectEditIcon(icon) {
        document.getElementById('editCommonExpenseIcon').value = icon;
        document.getElementById('editSelectedIconDisplay').textContent = icon;
        
        document.querySelectorAll('#editIconPickerGrid .icon-picker-item').forEach(item => {
            item.classList.remove('selected');
            if (item.textContent.trim() === icon) {
                item.classList.add('selected');
            }
        });
        
        toggleEditIconPicker();
    }
    
    // Confirmer la modification d'une dÃ©pense commune
    function confirmEditCommonExpense() {
        const index = parseInt(document.getElementById('editExpenseIndex').value);
        const name = document.getElementById('editCommonExpenseName').value.trim();
        const amount = parseFloat(document.getElementById('editCommonExpenseAmount').value);
        const paidBy = document.getElementById('editCommonExpensePaidBy').value;
        const icon = document.getElementById('editCommonExpenseIcon').value || 'ğŸ›’';
        
        if (!name || isNaN(amount) || amount <= 0) {
            alert('Veuillez remplir tous les champs correctement');
            return;
        }
        
        if (!paidBy) {
            alert('Veuillez sÃ©lectionner qui a payÃ©');
            return;
        }
        
        const participants = [];
        document.querySelectorAll('#editParticipantsList input[type="checkbox"]:checked').forEach(checkbox => {
            participants.push(checkbox.value);
        });
        
        if (participants.length === 0) {
            alert('Veuillez sÃ©lectionner au moins un participant');
            return;
        }
        
        const savedTab = currentTab;
        
        appData.commonExpenses[index] = {
            ...appData.commonExpenses[index],
            name: name,
            amount: amount,
            paidBy: paidBy,
            participants: participants,
            icon: icon,
            modifiedDate: new Date().toISOString()
        };
        
        saveData();
        closeModal('editCommonExpenseModal');
        renderApp(savedTab);
        showNotification('âœ… DÃ©pense modifiÃ©e !', 'success');
    }
	
    function deleteCommonExpense(index) {
        confirmCallback = () => {
            appData.commonExpenses.splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette dÃ©pense commune ?');
    }

    // Menu FAB
    let fabMenuOpen = false;
    
    function toggleFabMenu() {
        fabMenuOpen = !fabMenuOpen;
        const fabMenu = document.getElementById('fabMenu');
        const fabButton = document.getElementById('fabButton');
        
        if (fabMenuOpen) {
            fabMenu.classList.add('active');
            fabButton.classList.add('active');
        } else {
            fabMenu.classList.remove('active');
            fabButton.classList.remove('active');
        }
    }
    
    function closeFabMenu() {
        fabMenuOpen = false;
        document.getElementById('fabMenu').classList.remove('active');
        document.getElementById('fabButton').classList.remove('active');
    }

    // Ajout rapide de revenu
    function quickAddIncome() {
        closeFabMenu();
        if (appData.currentTab === 'dashboard' || appData.currentTab === 'commun') {
            // Si on est sur le tableau de bord ou commun, utiliser le premier utilisateur
            const firstUser = Object.keys(appData.users).find(id => id !== 'commun');
            if (firstUser) {
                addIncome(firstUser);
            }
        } else {
            addIncome(appData.currentTab);
        }
    }

    // Ajout rapide de dÃ©pense
    function quickAddExpense() {
        closeFabMenu();
        if (appData.currentTab === 'commun') {
            addCommonExpense();
        } else if (appData.currentTab === 'dashboard') {
            // Si on est sur le tableau de bord, utiliser le premier utilisateur
            const firstUser = Object.keys(appData.users).find(id => id !== 'commun');
            if (firstUser) {
                addExpense(firstUser);
            }
        } else {
            addExpense(appData.currentTab);
        }
    }

    // Fermer le menu FAB en cliquant ailleurs
    document.addEventListener('click', (e) => {
        if (fabMenuOpen && !e.target.closest('.fab') && !e.target.closest('.fab-menu')) {
            closeFabMenu();
        }
    });

    // Calculatrice
    function toggleCalculator() {
        closeFabMenu();
        openModal('calculatorModal');
    }

    function appendToCalc(value) {
        if (calcExpression === '0' && value !== '.') {
            calcExpression = value;
        } else {
            calcExpression += value;
        }
        updateCalcDisplay();
    }

    function clearCalc() {
        calcExpression = '0';
        updateCalcDisplay();
    }

    function deleteLastCalc() {
        if (calcExpression.length > 1) {
            calcExpression = calcExpression.slice(0, -1);
        } else {
            calcExpression = '0';
        }
        updateCalcDisplay();
    }

    function calculateResult() {
        try {
            const result = eval(calcExpression);
            calcExpression = result.toString();
            updateCalcDisplay();
        } catch (e) {
            document.getElementById('calcDisplay').textContent = 'Erreur';
            calcExpression = '0';
        }
    }

    function updateCalcDisplay() {
        const display = document.getElementById('calcDisplay');
        display.textContent = calcExpression;
        
        // Ajuster la taille du texte si nÃ©cessaire
        if (calcExpression.length > 15) {
            display.style.fontSize = '1rem';
        } else if (calcExpression.length > 10) {
            display.style.fontSize = '1.25rem';
        } else {
            display.style.fontSize = '1.5rem';
        }
    }

    // Gestion du clavier pour la calculatrice
    function handleCalculatorKeyboard(e) {
        const modal = document.getElementById('calculatorModal');
        if (!modal.classList.contains('active')) return;
        
        e.preventDefault();
        
        // Chiffres
        if (e.key >= '0' && e.key <= '9') {
            appendToCalc(e.key);
        }
        // OpÃ©rateurs
        else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
            appendToCalc(e.key);
        }
        // Point dÃ©cimal
        else if (e.key === '.' || e.key === ',') {
            appendToCalc('.');
        }
        // Ã‰gal
        else if (e.key === 'Enter' || e.key === '=') {
            calculateResult();
        }
        // Effacer
        else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
            clearCalc();
        }
        // Supprimer dernier caractÃ¨re
        else if (e.key === 'Backspace') {
            deleteLastCalc();
        }
    }

    // Ajouter l'Ã©couteur d'Ã©vÃ©nements au chargement
    document.addEventListener('keydown', handleCalculatorKeyboard);

    // ThÃ¨me
function toggleTheme() {
    // Obtenir le thÃ¨me actuel du body (source de vÃ©ritÃ©)
    const currentTheme = document.body.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    console.log('Toggle theme:', currentTheme, '->', newTheme); // Debug
    
    // Appliquer le nouveau thÃ¨me
    document.body.setAttribute('data-theme', newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
    appData.theme = newTheme;
    
    // Sauvegarder le choix du thÃ¨me
    localStorage.setItem('preferredTheme', newTheme);
    saveData();
}

// Fonction pour synchroniser le thÃ¨me
function syncTheme() {
    const bodyTheme = document.body.getAttribute('data-theme');
    const savedTheme = localStorage.getItem('preferredTheme');
    const appTheme = appData.theme;
    
    // Si tous ne sont pas synchronisÃ©s, utiliser la prÃ©fÃ©rence sauvegardÃ©e
    if (savedTheme && (bodyTheme !== savedTheme || appTheme !== savedTheme)) {
        document.body.setAttribute('data-theme', savedTheme);
        document.documentElement.setAttribute('data-theme', savedTheme);
        appData.theme = savedTheme;
        console.log('Theme synchronized to:', savedTheme);
    }
}

    // ParamÃ¨tres
	// Afficher la page Ã€ propos
    function showAbout() {
        // Fermer le modal paramÃ¨tres sans utiliser history.back()
        document.getElementById('settingsModal').classList.remove('active');
        document.body.style.overflow = '';
        
        // Ouvrir le modal Ã€ propos aprÃ¨s un court dÃ©lai
        setTimeout(() => {
            openModal('aboutModal');
        }, 100);
    }
	
    function openSettings() {
		updatePinButtonText();
        openModal('settingsModal');
    }

    function exportData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `depenses_export_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        closeModal('settingsModal');
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
    try {
        const data = JSON.parse(event.target.result);
        appData = data;
        
        // Conserver le thÃ¨me prÃ©fÃ©rÃ© de l'utilisateur
        const preferredTheme = localStorage.getItem('preferredTheme') || 'dark';
        appData.theme = preferredTheme;
        document.body.setAttribute('data-theme', preferredTheme);
        
        saveData();
        renderApp();
        closeModal('settingsModal');
        alert('DonnÃ©es importÃ©es avec succÃ¨s !');
    } catch (error) {
        alert('Erreur lors de l\'importation des donnÃ©es');
    }
};
                reader.readAsText(file);
            }
        };
        input.click();
    }

// Vider le cache et recharger l'application
    async function clearCacheAndReload() {
        const confirmed = confirm(
            'ğŸ”„ Vider le cache de l\'application ?\n\n' +
            'â€¢ Cela forcera le tÃ©lÃ©chargement de la derniÃ¨re version\n' +
            'â€¢ Vos donnÃ©es (dÃ©penses, utilisateurs) seront CONSERVÃ‰ES\n' +
            'â€¢ L\'application va se recharger\n\n' +
            'Continuer ?'
        );
        
        if (!confirmed) return;
        
        try {
            // 1. DÃ©sinscrire tous les Service Workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    console.log('Service Worker dÃ©sinscrit');
                }
            }
            
            // 2. Vider tous les caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    console.log('Cache supprimÃ©:', cacheName);
                }
            }
            
            // 3. Message de succÃ¨s
            showSuccessMessage('Cache vidÃ© ! Rechargement...');
            
            // 4. Recharger la page aprÃ¨s un court dÃ©lai
            setTimeout(() => {
                window.location.reload(true);
            }, 1000);
            
        } catch (error) {
            console.error('Erreur lors du vidage du cache:', error);
            alert('âŒ Erreur lors du vidage du cache.\n\nEssayez de vider manuellement le cache de votre navigateur.');
        }
    }
    
    // RÃ©initialisation complÃ¨te (supprime aussi les donnÃ©es)
    async function fullReset() {
        const confirmed = confirm(
            'âš ï¸ ATTENTION : RÃ©initialisation complÃ¨te !\n\n' +
            'Cela va supprimer :\n' +
            'â€¢ Toutes vos donnÃ©es (dÃ©penses, utilisateurs)\n' +
            'â€¢ Le cache de l\'application\n' +
            'â€¢ Tous les paramÃ¨tres\n\n' +
            'Cette action est IRRÃ‰VERSIBLE !\n\n' +
            'ÃŠtes-vous vraiment sÃ»r ?'
        );
        
        if (!confirmed) return;
        
        // Double confirmation
        const doubleConfirm = confirm('ğŸš¨ DerniÃ¨re chance !\n\nTout sera dÃ©finitivement effacÃ©.\n\nConfirmer la suppression ?');
        if (!doubleConfirm) return;
        
        try {
            // 1. RÃ©initialiser appData en mÃ©moire
            appData = {
                users: {
                    'commun': {
                        name: 'Commun',
                        incomes: [],
                        expenses: []
                    }
                },
                commonExpenses: [],
                transfers: [],
                currentTab: 'dashboard',
                theme: 'dark'
            };
            
            // 2. Supprimer TOUTES les clÃ©s du localStorage
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                keysToRemove.push(localStorage.key(i));
            }
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log('SupprimÃ© localStorage:', key);
            });
            
            // 3. Vider sessionStorage
            sessionStorage.clear();
            console.log('sessionStorage vidÃ©');
            
            // 4. DÃ©sinscrire les Service Workers
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                    console.log('Service Worker dÃ©sinscrit');
                }
            }
            
            // 5. Vider tous les caches
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                    await caches.delete(cacheName);
                    console.log('Cache supprimÃ©:', cacheName);
                }
            }
            
            // 6. Vider IndexedDB si utilisÃ©
            if ('indexedDB' in window) {
                const databases = await indexedDB.databases?.() || [];
                for (const db of databases) {
                    if (db.name) {
                        indexedDB.deleteDatabase(db.name);
                        console.log('IndexedDB supprimÃ©:', db.name);
                    }
                }
            }
            
            console.log('âœ… RÃ©initialisation complÃ¨te effectuÃ©e');
            
            // 7. Message et rechargement forcÃ©
            alert('âœ… Toutes les donnÃ©es ont Ã©tÃ© supprimÃ©es !\n\nL\'application va se recharger.');
            
            // Forcer le rechargement sans cache
            window.location.href = window.location.pathname + '?reset=' + Date.now();
            
        } catch (error) {
            console.error('Erreur lors de la rÃ©initialisation:', error);
            
            // Plan B : forcer quand mÃªme
            localStorage.clear();
            sessionStorage.clear();
            alert('RÃ©initialisation effectuÃ©e. L\'application va se recharger.');
            window.location.reload(true);
        }
    }
	
    function confirmReset() {
        fullReset();
    }

    // Gestion des modals avec historique
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        // EmpÃªcher le scroll du body
        document.body.style.overflow = 'hidden';
        // Ajouter un Ã©tat Ã  l'historique pour gÃ©rer le bouton retour
        history.pushState({ modal: modalId }, '');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        // RÃ©activer le scroll du body
        document.body.style.overflow = '';
        // Si on ferme manuellement, on recule dans l'historique
        if (history.state && history.state.modal === modalId) {
            history.back();
        }
    }

    function showConfirm(message) {
        const confirmMessageElement = document.getElementById('confirmMessage');
        if (confirmMessageElement) {
            confirmMessageElement.textContent = message;
            document.getElementById('confirmButton').onclick = () => {
                if (confirmCallback) confirmCallback();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        } else {
            // Fallback si l'Ã©lÃ©ment n'existe pas
            if (confirm(message) && confirmCallback) {
                confirmCallback();
            }
        }
    }

    // Gestion du bouton retour sur Android
    window.addEventListener('popstate', (e) => {
        const activeModal = document.querySelector('.modal.active');
        if (activeModal) {
            activeModal.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // ========== STATISTIQUES AVANCÃ‰ES ==========
    
    let statsCurrentDate = new Date();
    let statsCurrentPeriod = 'month'; // 'month', 'year', 'all'
    
    // Couleurs pour le graphique
    const chartColors = [
        '#f59e0b', // Orange
        '#ef4444', // Rouge
        '#ec4899', // Rose
        '#8b5cf6', // Violet
        '#3b82f6', // Bleu
        '#10b981', // Vert
        '#14b8a6', // Teal
        '#6366f1', // Indigo
        '#f97316', // Orange foncÃ©
        '#84cc16', // Lime
        '#06b6d4', // Cyan
        '#a855f7', // Purple
    ];
    
	// Liste des icÃ´nes disponibles pour le sÃ©lecteur
    const availableIcons = [
        { icon: 'ğŸ›’', label: 'Courses' },
        { icon: 'ğŸ ', label: 'Logement' },
        { icon: 'ğŸ’§', label: 'Eau' },
        { icon: 'âš¡', label: 'Ã‰lectricitÃ©' },
        { icon: 'ğŸ”¥', label: 'Gaz' },
        { icon: 'ğŸ“¶', label: 'Internet' },
        { icon: 'ğŸ“±', label: 'TÃ©lÃ©phone' },
        { icon: 'ğŸ›¡ï¸', label: 'Assurance' },
        { icon: 'ğŸ¥', label: 'SantÃ©' },
        { icon: 'ğŸ’Š', label: 'Pharmacie' },
        { icon: 'ğŸ‘¨â€âš•ï¸', label: 'MÃ©decin' },
        { icon: 'ğŸš—', label: 'Voiture' },
        { icon: 'â›½', label: 'Essence' },
        { icon: 'ğŸ…¿ï¸', label: 'Parking' },
        { icon: 'ğŸšŒ', label: 'Transport' },
        { icon: 'ğŸš†', label: 'Train' },
        { icon: 'âœˆï¸', label: 'Voyage' },
        { icon: 'ğŸ¨', label: 'HÃ´tel' },
        { icon: 'ğŸ½ï¸', label: 'Restaurant' },
        { icon: 'ğŸ•', label: 'Pizza' },
        { icon: 'ğŸ”', label: 'Fast-food' },
        { icon: 'â˜•', label: 'CafÃ©' },
        { icon: 'ğŸ¬', label: 'CinÃ©ma' },
        { icon: 'ğŸµ', label: 'Musique' },
        { icon: 'ğŸ®', label: 'Jeux' },
        { icon: 'ğŸ“º', label: 'TV' },
        { icon: 'ğŸ’³', label: 'CrÃ©dit' },
        { icon: 'ğŸ¦', label: 'Banque' },
        { icon: 'ğŸ“‹', label: 'ImpÃ´ts' },
        { icon: 'ğŸ‘•', label: 'VÃªtements' },
        { icon: 'ğŸ›ï¸', label: 'Shopping' },
        { icon: 'ğŸ', label: 'Cadeau' },
        { icon: 'ğŸ“¦', label: 'Colis' },
        { icon: 'ğŸ•', label: 'Animaux' },
        { icon: 'ğŸ™', label: 'Octopus' },
        { icon: 'ğŸ’°', label: 'Autre' }
    ];
    
    let iconPickerVisible = false;
    
    // Afficher/masquer le sÃ©lecteur d'icÃ´nes
    function toggleIconPicker() {
        const container = document.getElementById('iconPickerContainer');
        iconPickerVisible = !iconPickerVisible;
        
        if (iconPickerVisible) {
            // GÃ©nÃ©rer la grille d'icÃ´nes
            const grid = document.getElementById('iconPickerGrid');
            const currentIcon = document.getElementById('commonExpenseIcon').value;
            
            grid.innerHTML = availableIcons.map(item => `
                <button type="button" 
                        class="icon-picker-item ${item.icon === currentIcon ? 'selected' : ''}" 
                        onclick="selectIcon('${item.icon}')"
                        title="${item.label}">
                    ${item.icon}
                </button>
            `).join('');
            
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }
    
    // SÃ©lectionner une icÃ´ne
    function selectIcon(icon) {
        document.getElementById('commonExpenseIcon').value = icon;
        document.getElementById('selectedIconDisplay').textContent = icon;
        
        // Mettre Ã  jour la sÃ©lection visuelle
        document.querySelectorAll('.icon-picker-item').forEach(item => {
            item.classList.remove('selected');
            if (item.textContent.trim() === icon) {
                item.classList.add('selected');
            }
        });
        
        // Fermer le sÃ©lecteur
        toggleIconPicker();
    }
	
    // IcÃ´nes par mot-clÃ© dans le nom de la dÃ©pense
    const categoryIcons = {
        'loyer': 'ğŸ ',
        'charge': 'ğŸ ',
        'Ã©lectricitÃ©': 'âš¡',
        'edf': 'âš¡',
        'gaz': 'ğŸ”¥',
        'eau': 'ğŸ’§',
        'internet': 'ğŸ“¶',
        'freebox': 'ğŸ“¶',
        'box': 'ğŸ“¶',
        'tÃ©lÃ©phone': 'ğŸ“±',
        'mobile': 'ğŸ“±',
        'sfr': 'ğŸ“±',
        'orange': 'ğŸ“±',
        'bouygues': 'ğŸ“±',
        'assurance': 'ğŸ›¡ï¸',
        'mutuelle': 'ğŸ¥',
        'santÃ©': 'ğŸ¥',
        'mÃ©decin': 'ğŸ‘¨â€âš•ï¸',
        'pharmacie': 'ğŸ’Š',
        'courses': 'ğŸ›’',
        'supermarchÃ©': 'ğŸ›’',
        'leclerc': 'ğŸ›’',
        'carrefour': 'ğŸ›’',
        'auchan': 'ğŸ›’',
        'lidl': 'ğŸ›’',
        'restaurant': 'ğŸ½ï¸',
        'resto': 'ğŸ½ï¸',
        'pizza': 'ğŸ•',
        'mcdo': 'ğŸ”',
        'essence': 'â›½',
        'carburant': 'â›½',
        'voiture': 'ğŸš—',
        'auto': 'ğŸš—',
        'parking': 'ğŸ…¿ï¸',
        'transport': 'ğŸšŒ',
        'train': 'ğŸš†',
        'sncf': 'ğŸš†',
        'avion': 'âœˆï¸',
        'voyage': 'âœˆï¸',
        'hÃ´tel': 'ğŸ¨',
        'netflix': 'ğŸ¬',
        'spotify': 'ğŸµ',
        'amazon': 'ğŸ“¦',
        'abonnement': 'ğŸ“‹',
        'crÃ©dit': 'ğŸ’³',
        'banque': 'ğŸ¦',
        'impÃ´t': 'ğŸ“‹',
        'taxe': 'ğŸ“‹',
        'vÃªtement': 'ğŸ‘•',
        'shopping': 'ğŸ›ï¸',
        'cadeau': 'ğŸ',
        'octopus': 'ğŸ™',
        'default': 'ğŸ’°'
    };
    
    function getIconForExpense(name) {
        const lowerName = name.toLowerCase();
        for (const [keyword, icon] of Object.entries(categoryIcons)) {
            if (lowerName.includes(keyword)) {
                return icon;
            }
        }
        return categoryIcons.default;
    }
    
    function showStats() {
        // Remplir le filtre utilisateur
        const userFilter = document.getElementById('statsUserFilter');
        userFilter.innerHTML = '<option value="all">Pour le groupe</option>';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const option = document.createElement('option');
                option.value = userId;
                option.textContent = appData.users[userId].name;
                userFilter.appendChild(option);
            }
        }
        
        // RÃ©initialiser la date Ã  aujourd'hui
        statsCurrentDate = new Date();
        statsCurrentPeriod = 'month';
        
        // Mettre Ã  jour les boutons de pÃ©riode
        document.querySelectorAll('.stats-period-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('periodMonth').classList.add('active');
        
        updateStats();
        openModal('statsModal');
    }
    
    function setStatsPeriod(period) {
        statsCurrentPeriod = period;
        
        // Mettre Ã  jour les boutons
        document.querySelectorAll('.stats-period-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('period' + period.charAt(0).toUpperCase() + period.slice(1)).classList.add('active');
        
        // Afficher/masquer la navigation
        const nav = document.getElementById('statsNavigation');
        if (period === 'all') {
            nav.style.display = 'none';
        } else {
            nav.style.display = 'flex';
        }
        
        updateStats();
    }
    
    function navigateStats(direction) {
        if (statsCurrentPeriod === 'month') {
            statsCurrentDate.setMonth(statsCurrentDate.getMonth() + direction);
        } else if (statsCurrentPeriod === 'year') {
            statsCurrentDate.setFullYear(statsCurrentDate.getFullYear() + direction);
        }
        updateStats();
    }
    
    function updateStats() {
        const userFilter = document.getElementById('statsUserFilter').value;
        
        // Mettre Ã  jour le label de pÃ©riode
        const periodLabel = document.getElementById('statsPeriodLabel');
        if (statsCurrentPeriod === 'month') {
            periodLabel.textContent = statsCurrentDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
        } else if (statsCurrentPeriod === 'year') {
            periodLabel.textContent = statsCurrentDate.getFullYear().toString();
        } else {
            periodLabel.textContent = 'Toutes les dÃ©penses';
        }
        
        // Filtrer les dÃ©penses
        const expenses = getFilteredExpenses(userFilter);
        
        // Grouper par nom (catÃ©gorie)
        const categories = {};
        let total = 0;
        
        expenses.forEach(exp => {
            const name = exp.name;
            if (!categories[name]) {
                categories[name] = {
                    name: name,
                    amount: 0,
                    icon: exp.icon || getIconForExpense(name)
                };
            }
            categories[name].amount += exp.amount;
            total += exp.amount;
        });
        
        // Convertir en tableau et trier par montant dÃ©croissant
        const sortedCategories = Object.values(categories).sort((a, b) => b.amount - a.amount);
        
        // Mettre Ã  jour le total
        document.getElementById('statsTotal').innerHTML = `<span style="text-decoration: underline;">Total: ${total.toFixed(0)} â‚¬</span>`;
        
        // GÃ©nÃ©rer le graphique camembert
        generatePieChart(sortedCategories, total);
        
        // GÃ©nÃ©rer la lÃ©gende
        generateLegend(sortedCategories, total);
        
        // GÃ©nÃ©rer la liste des catÃ©gories
        generateCategoryList(sortedCategories);
    }
    
    function getFilteredExpenses(userFilter) {
        let expenses = [];
        
        // Collecter les dÃ©penses communes
        appData.commonExpenses.forEach(exp => {
            // VÃ©rifier le filtre utilisateur
            if (userFilter !== 'all' && !exp.participants.includes(userFilter)) {
                return;
            }
            
            // VÃ©rifier la pÃ©riode
            if (!isInPeriod(exp.date)) {
                return;
            }
            
            // Si filtre utilisateur, ne prendre que sa part
            let amount = exp.amount;
            if (userFilter !== 'all') {
                amount = exp.amount / exp.participants.length;
            }
            
            expenses.push({
                name: exp.name,
                amount: amount,
                date: exp.date,
                icon: exp.icon
            });
        });
        
        // Collecter les dÃ©penses personnelles
        for (const userId in appData.users) {
            if (userId === 'commun') continue;
            
            // Si filtre utilisateur actif, ne prendre que ses dÃ©penses
            if (userFilter !== 'all' && userFilter !== userId) continue;
            
            const user = appData.users[userId];
            user.expenses.forEach(exp => {
                if (!isInPeriod(exp.date)) return;
                
                expenses.push({
                    name: exp.name,
                    amount: exp.amount,
                    date: exp.date
                });
            });
        }
        
        return expenses;
    }
    
    function isInPeriod(dateStr) {
        if (statsCurrentPeriod === 'all') return true;
        if (!dateStr) return false;
        
        const date = new Date(dateStr);
        
        if (statsCurrentPeriod === 'month') {
            return date.getMonth() === statsCurrentDate.getMonth() &&
                   date.getFullYear() === statsCurrentDate.getFullYear();
        } else if (statsCurrentPeriod === 'year') {
            return date.getFullYear() === statsCurrentDate.getFullYear();
        }
        
        return true;
    }
    
    function generatePieChart(categories, total) {
        const svg = document.getElementById('pieChart');
        
        if (categories.length === 0 || total === 0) {
            svg.innerHTML = `
                <circle cx="50" cy="50" r="45" fill="var(--bg-tertiary)" />
                <text x="50" y="50" text-anchor="middle" dominant-baseline="middle" fill="var(--text-secondary)" font-size="8" transform="rotate(90 50 50)">Aucune donnÃ©e</text>
            `;
            return;
        }
        
        let html = '';
        let currentAngle = 0;
        
        categories.forEach((cat, index) => {
            const percentage = cat.amount / total;
            const angle = percentage * 360;
            const color = chartColors[index % chartColors.length];
            
            // CrÃ©er un arc de cercle
            const startAngle = currentAngle;
            const endAngle = currentAngle + angle;
            
            const x1 = 50 + 45 * Math.cos((startAngle * Math.PI) / 180);
            const y1 = 50 + 45 * Math.sin((startAngle * Math.PI) / 180);
            const x2 = 50 + 45 * Math.cos((endAngle * Math.PI) / 180);
            const y2 = 50 + 45 * Math.sin((endAngle * Math.PI) / 180);
            
            const largeArc = angle > 180 ? 1 : 0;
            
            if (categories.length === 1) {
                // Si une seule catÃ©gorie, dessiner un cercle complet
                html += `<circle cx="50" cy="50" r="45" fill="${color}" />`;
            } else {
                html += `<path d="M 50 50 L ${x1} ${y1} A 45 45 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" />`;
            }
            
            currentAngle = endAngle;
        });
        
        svg.innerHTML = html;
    }
    
    function generateLegend(categories, total) {
        const legend = document.getElementById('statsLegend');
        
        if (categories.length === 0) {
            legend.innerHTML = '<div style="color: var(--text-secondary);">Aucune dÃ©pense</div>';
            return;
        }
        
        // Limiter Ã  5 catÃ©gories dans la lÃ©gende
        const displayCategories = categories.slice(0, 5);
        
        legend.innerHTML = displayCategories.map((cat, index) => {
            const color = chartColors[index % chartColors.length];
            return `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 10px; height: 10px; border-radius: 50%; background: ${color}; flex-shrink: 0;"></div>
                    <span style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${cat.name}</span>
                </div>
            `;
        }).join('');
        
        if (categories.length > 5) {
            legend.innerHTML += `<div style="color: var(--text-secondary); font-size: 0.75rem;">+ ${categories.length - 5} autres</div>`;
        }
    }
    
    function generateCategoryList(categories) {
        const list = document.getElementById('statsCategoryList');
        
        if (categories.length === 0) {
            list.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">ğŸ“Š</div>
                    <div>Aucune dÃ©pense pour cette pÃ©riode</div>
                </div>
            `;
            return;
        }
        
        list.innerHTML = categories.map((cat, index) => {
            const color = chartColors[index % chartColors.length];
            return `
                <div class="stats-category-item">
                    <div class="stats-category-icon" style="background: ${color}20; color: ${color};">
                        ${cat.icon}
                    </div>
                    <div class="stats-category-info">
                        <div class="stats-category-name">${cat.name}</div>
                    </div>
                    <div class="stats-category-amount" style="color: var(--text-primary);">
                        ${cat.amount.toFixed(2).replace('.', ',')} â‚¬
                    </div>
                </div>
            `;
        }).join('');
    }

// Mettre Ã  jour le texte du bouton PIN dans les paramÃ¨tres
    function updatePinButtonText() {
        const btn = document.getElementById('pinButtonText');
        if (btn) {
            // Assurez-vous que appData.security existe avant d'essayer d'y accÃ©der
            btn.textContent = (appData.security && appData.security.pinEnabled) ? 
                'DÃ©sactiver le code PIN' : 'Activer le code PIN';
        }
    }
	
// PWA et installation amÃ©liorÃ©e
function initPWA() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('Service Worker enregistrÃ© avec succÃ¨s:', registration);
                
                // VÃ©rifier les mises Ã  jour
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Nouveau service worker disponible
                            if (confirm('Une nouvelle version est disponible ! Voulez-vous mettre Ã  jour ?')) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Erreur Service Worker:', error);
            });
    }
    
    // DÃ©tection de l'installation PWA
    let deferredPrompt;
    const installBtn = document.getElementById('installAppBtn');
    
    // VÃ©rifier si l'app n'est pas dÃ©jÃ  installÃ©e
    const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone || 
                       document.referrer.includes('android-app://');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('Installation disponible');
        
        // Afficher le bouton d'installation dans les paramÃ¨tres
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
        
        // Ajouter un bouton d'installation dans le header
        addInstallButtonToHeader();
        
        // VÃ©rifier si l'utilisateur a dÃ©jÃ  refusÃ© rÃ©cemment
        const lastDeclined = localStorage.getItem('installDeclined');
        const hoursSinceDeclined = lastDeclined ? 
            (Date.now() - parseInt(lastDeclined)) / (1000 * 60 * 60) : 999;
        
        // Montrer la banniÃ¨re immÃ©diatement si :
        // - L'utilisateur n'a jamais refusÃ©
        // - Ou il a refusÃ© il y a plus de 24 heures
        if (!lastDeclined || hoursSinceDeclined > 24) {
            // Attendre 2 secondes pour que la page soit bien chargÃ©e
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallBanner();
                }
            }, 2000);
        }
    });
    
    // Gestionnaire d'installation
    window.installApp = async () => {
        if (!deferredPrompt) {
            // Si pas de prompt, essayer de montrer des instructions personnalisÃ©es
            showManualInstallInstructions();
            return;
        }
        
        hideInstallBanner();
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('Installation acceptÃ©e');
            removeInstallButton();
            if (installBtn) {
                installBtn.style.display = 'none';
            }
            // Montrer un message de succÃ¨s
            showSuccessMessage('Application installÃ©e avec succÃ¨s ! ğŸ‰');
            // Marquer comme installÃ©e
            localStorage.setItem('pwaInstalled', 'true');
        } else {
            // Enregistrer le refus avec timestamp
            localStorage.setItem('installDeclined', Date.now());
        }
        
        deferredPrompt = null;
    };
    
    // DÃ©tecter si l'app est installÃ©e
    window.addEventListener('appinstalled', () => {
        console.log('PWA installÃ©e avec succÃ¨s');
        hideInstallBanner();
        removeInstallButton();
        if (installBtn) {
            installBtn.style.display = 'none';
        }
        localStorage.setItem('pwaInstalled', 'true');
    });
    
    // VÃ©rifier si on est en mode standalone
    if (isInstalled) {
        console.log('App lancÃ©e en mode standalone');
        localStorage.setItem('pwaInstalled', 'true');
    }
}

// Ajouter un bouton d'installation dans le header
function addInstallButtonToHeader() {
    // VÃ©rifier si le bouton existe dÃ©jÃ 
    if (document.getElementById('headerInstallBtn')) return;
    
    const headerButtons = document.querySelector('.header-buttons');
    if (!headerButtons) return;
    
    const installButton = document.createElement('button');
    installButton.id = 'headerInstallBtn';
    installButton.className = 'btn-icon install-pulse';
    installButton.onclick = installApp;
    installButton.title = 'Installer l\'application';
    installButton.innerHTML = '<span class="material-icons">install_mobile</span>';
    
    // Ajouter le bouton au dÃ©but des boutons du header
    headerButtons.insertBefore(installButton, headerButtons.firstChild);
}

// Retirer le bouton d'installation
function removeInstallButton() {
    const btn = document.getElementById('headerInstallBtn');
    if (btn) btn.remove();
}

// BanniÃ¨re d'installation amÃ©liorÃ©e
function showInstallBanner() {
    const existingBanner = document.getElementById('installBanner');
    if (existingBanner) return;
    
    const banner = document.createElement('div');
    banner.id = 'installBanner';
    banner.innerHTML = `
        <div style="
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(139, 92, 246, 0.4);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            z-index: 1000;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: min(calc(100vw - 2rem), 500px);
            width: 100%;
        ">
            <div style="
                background: rgba(255, 255, 255, 0.2);
                border-radius: 16px;
                padding: 1rem;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.3);
            ">
                <span class="material-icons" style="font-size: 2.5rem; display: block;">install_mobile</span>
            </div>
            <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 0.375rem; font-size: 1.25rem;">Installer l'application</strong>
                <span style="font-size: 0.9375rem; opacity: 0.95; line-height: 1.4;">Ajoutez l'app Ã  votre Ã©cran d'accueil pour un accÃ¨s rapide et hors ligne âš¡</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch; min-width: 100px;">
                <button onclick="installApp()" style="
                    background: white;
					color: #8b5cf6;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 12px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 1rem;
                    transition: all 0.2s;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    white-space: nowrap;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">Installer</button>
                <button onclick="dismissInstallBanner()" style="
                    background: transparent;
                    color: rgba(255,255,255,0.9);
                    border: none;
                    padding: 0.5rem;
                    cursor: pointer;
                    font-size: 0.875rem;
                    transition: opacity 0.2s;
                    text-decoration: underline;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Non merci</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(banner);
}

// Fonction pour masquer la banniÃ¨re avec possibilitÃ© de la rÃ©afficher plus tard
function dismissInstallBanner() {
    hideInstallBanner();
    // Enregistrer un refus "lÃ©ger" (24h avant de re-proposer)
    localStorage.setItem('installDeclined', Date.now());
}

function hideInstallBanner() {
    const banner = document.getElementById('installBanner');
    if (banner) {
        banner.style.animation = 'bounceOut 0.4s ease-in';
        setTimeout(() => banner.remove(), 400);
    }
}

// Instructions manuelles pour les navigateurs non supportÃ©s
function showManualInstallInstructions() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    let instructions = '';
    
    if (isIOS) {
        instructions = `
            <h3>ğŸ“± Installation sur iOS</h3>
            <ol style="text-align: left; margin: 1rem 0;">
                <li>Appuyez sur le bouton <strong>Partager</strong> <span style="font-size: 1.2rem;">â¬†ï¸</span></li>
                <li>Faites dÃ©filer et appuyez sur <strong>"Sur l'Ã©cran d'accueil"</strong></li>
                <li>Appuyez sur <strong>"Ajouter"</strong></li>
            </ol>
        `;
    } else if (isAndroid) {
        instructions = `
            <h3>ğŸ“± Installation sur Android</h3>
            <p>Essayez d'utiliser Chrome ou Edge pour installer cette application.</p>
            <ol style="text-align: left; margin: 1rem 0;">
                <li>Ouvrez le menu du navigateur (3 points)</li>
                <li>Appuyez sur <strong>"Installer l'application"</strong></li>
            </ol>
        `;
    } else {
        instructions = `
            <h3>ğŸ’» Installation sur ordinateur</h3>
            <p>Cette application peut Ãªtre installÃ©e depuis Chrome, Edge ou Brave.</p>
            <p>Cherchez l'icÃ´ne d'installation dans la barre d'adresse.</p>
        `;
    }
    
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        " onclick="if(event.target === this) this.remove()">
            <div style="
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 2rem;
                border-radius: 20px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            ">
                ${instructions}
                <button onclick="this.closest('div').parentElement.remove()" style="
                    margin-top: 1rem;
                    background: var(--primary);
                    color: white;
                    border: none;
                    padding: 0.75rem 2rem;
                    border-radius: 10px;
                    font-weight: 600;
                    cursor: pointer;
                ">Compris</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Message de succÃ¨s
function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        z-index: 10000;
        animation: slideInDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 600;
        font-size: 1.125rem;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutUp 0.4s ease-in';
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}

    // ========== EXPOSER LES FONCTIONS POUR BOOT.JS ==========
    // CRITIQUE : Sans ceci, boot.js ne peut pas trouver les fonctions !
    window.initializeApp = initializeApp;
    window.loadData = loadData;
    window.renderApp = renderApp;
    window.checkAndFixEmptyDisplay = checkAndFixEmptyDisplay;
    window.showSuccessMessage = showSuccessMessage;
    window.showNotification = showNotification;
    
    // ========== INITIALISATION DIRECTE (SANS DÃ‰PENDRE DE BOOT.JS) ==========
    // Cette initialisation se fait IMMÃ‰DIATEMENT Ã  la fin du parsing du script
    (function directInit() {
        console.log('ğŸ“Œ Initialisation directe...');
        
        // Fonction d'init robuste
        function doInit() {
            try {
                // Marquer comme initialisÃ© pour Ã©viter double init
                if (window.__APP_INITIALIZED__) {
                    console.log('âš ï¸ App dÃ©jÃ  initialisÃ©e');
                    return;
                }
                
                console.log('ğŸš€ Lancement initializeApp()...');
                initializeApp();
                window.__APP_INITIALIZED__ = true;
                
                // Marquer boot.js comme terminÃ© aussi
                if (window.__BOOT__) {
                    window.__BOOT__.completed = true;
                }
                
                console.log('âœ… Initialisation directe rÃ©ussie !');
            } catch(e) {
                console.error('âŒ Erreur initialisation:', e);
            }
        }
        
        // Attendre que le DOM soit vraiment prÃªt
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', doInit);
        } else {
            // DOM dÃ©jÃ  prÃªt - init immÃ©diate
            doInit();
        }
        
        // Backup : si toujours pas initialisÃ© aprÃ¨s 500ms
        setTimeout(() => {
            if (!window.__APP_INITIALIZED__) {
                console.log('âš ï¸ Backup init aprÃ¨s 500ms...');
                doInit();
            }
        }, 500);
        
        // Gestion du rÃ©veil de l'app (pageshow)
        window.addEventListener('pageshow', (event) => {
            console.log('ğŸ“± Pageshow, persisted:', event.persisted);
            
            setTimeout(() => {
                const dashboard = document.getElementById('dashboard-content');
                const isEmpty = !dashboard || dashboard.innerHTML.trim() === '';
                
                if (isEmpty) {
                    console.log('ğŸ”„ Ã‰cran vide dÃ©tectÃ©, re-rendu...');
                    try {
                        loadData();
                        renderApp();
                    } catch(e) {
                        console.error('Erreur re-rendu:', e);
                        doInit();
                    }
                }
            }, 100);
        });
        
        // Gestion visibilitychange
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                setTimeout(() => {
                    const dashboard = document.getElementById('dashboard-content');
                    const isEmpty = !dashboard || dashboard.innerHTML.trim() === '';
                    
                    if (isEmpty && window.__APP_INITIALIZED__) {
                        console.log('ğŸ”„ RÃ©veil avec Ã©cran vide, re-rendu...');
                        try {
                            loadData();
                            renderApp();
                        } catch(e) {
                            console.error('Erreur re-rendu:', e);
                        }
                    }
                }, 200);
            }
        });
    })();
    
	</script>
	<!-- Popup de donation -->
	<div id="donationPopup" class="donation-overlay" style="display: none;">
    <div class="donation-popup">
        <span class="donation-close" onclick="closeDonationPopup()">Ã—</span>
        <h3>ğŸ’– Soutenez ce projet</h3>
        <p>Cette application est 100% gratuite et sans publicitÃ©.<br>
        Si elle vous est utile, un petit don nous aide Ã  continuer ! ğŸ™</p>
        <a href="https://fr.tipeee.com/actuetmedia" target="_blank" class="donation-link">
    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">favorite</span>
    Me soutenir sur Tipeee ğŸ’–
	</a>
        <p style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.7;">
            Merci de votre soutien ! â¤ï¸
        </p>
    </div>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="js/pdf-export.js"></script>
	<script src="js/security.js"></script>
	<!-- Modal de sÃ©curitÃ© PIN -->
	<div class="modal" id="pinModal">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <span class="material-icons" style="margin-right: 0.5rem;">lock</span>
            <span id="pinTitle">Entrez votre code PIN</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div id="pinDisplay" style="font-size: 2rem; letter-spacing: 1rem; margin: 1rem 0;">
                â—‹â—‹â—‹â—‹
            </div>
            <div id="pinError" style="color: var(--danger); font-size: 0.875rem; margin-bottom: 1rem; display: none;"></div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 200px; margin: 0 auto;">
                <button class="pin-btn" onclick="addPinDigit(1)">1</button>
                <button class="pin-btn" onclick="addPinDigit(2)">2</button>
                <button class="pin-btn" onclick="addPinDigit(3)">3</button>
                <button class="pin-btn" onclick="addPinDigit(4)">4</button>
                <button class="pin-btn" onclick="addPinDigit(5)">5</button>
                <button class="pin-btn" onclick="addPinDigit(6)">6</button>
                <button class="pin-btn" onclick="addPinDigit(7)">7</button>
                <button class="pin-btn" onclick="addPinDigit(8)">8</button>
                <button class="pin-btn" onclick="addPinDigit(9)">9</button>
                <button class="pin-btn" onclick="clearPin()">C</button>
                <button class="pin-btn" onclick="addPinDigit(0)">0</button>
                <button class="pin-btn" onclick="submitPin()">âœ“</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ã€ propos -->
    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">info</span>
                Ã€ propos
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
                
                <!-- En-tÃªte app -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">ğŸ’°</div>
                    <h2 style="margin: 0; font-size: 1.5rem;">Gestionnaire de DÃ©penses</h2>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">Version 2.0</p>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">Application PWA gratuite et sans publicitÃ©</p>
                </div>
                
                <!-- Description -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ“± PrÃ©sentation</h3>
                    <p>Application web progressive (PWA) de gestion de dÃ©penses partagÃ©es, inspirÃ©e de Tricount. IdÃ©ale pour les couples, colocataires ou groupes d'amis souhaitant gÃ©rer leurs finances communes.</p>
                </div>
                
                <!-- FonctionnalitÃ©s principales -->
                <div class="about-section">
                    <h3 class="about-title">âœ¨ FonctionnalitÃ©s principales</h3>
                    <div class="about-features">
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ </span>
                            <div>
                                <strong>Tableau de bord</strong>
                                <p>Vue d'ensemble des finances de chaque membre</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">âš–ï¸</span>
                            <div>
                                <strong>Balance automatique</strong>
                                <p>Calcul "Qui doit quoi Ã  qui" avec minimisation des transactions</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ’³</span>
                            <div>
                                <strong>DÃ©penses communes</strong>
                                <p>SystÃ¨me "PayÃ© par" avec sÃ©lection des participants</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ“Š</span>
                            <div>
                                <strong>Statistiques</strong>
                                <p>Graphique camembert, filtres par pÃ©riode et par personne</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ”—</span>
                            <div>
                                <strong>Partage facile</strong>
                                <p>Lien court gÃ©nÃ©rÃ© automatiquement pour partager le groupe</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ”’</span>
                            <div>
                                <strong>SÃ©curitÃ©</strong>
                                <p>Code PIN optionnel, donnÃ©es stockÃ©es localement</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ“´</span>
                            <div>
                                <strong>Mode hors ligne</strong>
                                <p>Fonctionne sans connexion internet</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ¨</span>
                            <div>
                                <strong>ThÃ¨mes</strong>
                                <p>Mode sombre et mode clair</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Autres fonctionnalitÃ©s -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ› ï¸ Autres fonctionnalitÃ©s</h3>
                    <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 1.5rem;">
                        <li>ğŸ’¸ Gestion des virements entre personnes</li>
                        <li>ğŸ§® Calculatrice intÃ©grÃ©e</li>
                        <li>ğŸ“„ Export PDF des donnÃ©es</li>
                        <li>ğŸ’¾ Sauvegarde/restauration JSON</li>
                        <li>ğŸ“± Installation sur l'Ã©cran d'accueil</li>
                        <li>âœï¸ Modification des dÃ©penses</li>
                        <li>ğŸ·ï¸ 36 icÃ´nes pour catÃ©goriser les dÃ©penses</li>
                    </ul>
                </div>
                
                <!-- ConfidentialitÃ© -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ” ConfidentialitÃ©</h3>
                    <p>Vos donnÃ©es restent sur votre appareil. Aucune information n'est envoyÃ©e Ã  un serveur externe. L'application fonctionne entiÃ¨rement en local.</p>
                </div>
                
                <!-- Contact -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ“§ Contact</h3>
                    <p>Une question, une suggestion ou un bug Ã  signaler ?</p>
                    <a href="mailto:contact@actuetmedia.fr" class="about-contact-btn">
                        <span class="material-icons">email</span>
                        contact@actuetmedia.fr
                    </a>
                </div>
                
                <!-- CrÃ©dits -->
                <div class="about-section" style="text-align: center; border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        DÃ©veloppÃ© avec â¤ï¸ par <strong>ActuetMedia</strong>
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                        Â© 2025 - Tous droits rÃ©servÃ©s
                    </p>
                    <button class="btn btn-small" onclick="showDonationPopup(); closeModal('aboutModal');" style="margin-top: 1rem; background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);">
                        <span class="material-icons" style="font-size: 1rem;">favorite</span>
                        Soutenir ce projet gratuit
                    </button>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('aboutModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>
	
<!-- Scripts iOS -->
<script src="js/ios-fixes.js"></script>
<script src="js/ios-install.js"></script>
</body>
</html>