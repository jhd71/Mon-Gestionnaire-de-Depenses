<!DOCTYPE html>
<html lang="fr">
<head>
<script>
    // Appliquer le th√®me imm√©diatement pour √©viter le flash
    (function() {
        const savedTheme = localStorage.getItem('preferredTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.body?.setAttribute('data-theme', savedTheme);
    })();
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestionnaire de D√©penses</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./images/icon-192.png">
	<link rel="apple-touch-icon" sizes="180x180" href="./images/icon-180.png">
	<link rel="icon" type="image/png" sizes="32x32" href="./images/icon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="./images/icon-16.png">
	<meta name="msapplication-TileColor" content="#2563eb">
	<meta name="msapplication-TileImage" content="./images/icon-144.png">
</head>
<body>
    <div class="header">
        <h1>Gestionnaire de D√©penses üí∞</h1>
        <div class="header-buttons">
            <button class="btn-icon" onclick="openShareModal()" title="Partager">
                <span class="material-icons">share</span>
            </button>
            <button class="btn-icon" onclick="showStats()" title="Statistiques">
                <span class="material-icons">insights</span>
            </button>
            <button class="btn-icon" onclick="toggleCalculator()" title="Calculatrice">
                <span class="material-icons">calculate</span>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="Changer le th√®me">
                <span class="material-icons">brightness_6</span>
            </button>
            <button class="btn-icon" onclick="openSettings()" title="Param√®tres">
                <span class="material-icons">settings</span>
            </button>
        </div>
    </div>

    <div class="tabs" id="tabs">
        <button class="tab active" onclick="switchTab('dashboard')">Tableau de bord</button>
        <button class="tab" onclick="switchTab('commun')">Commun</button>
        <button class="add-tab" onclick="addNewTab()">+</button>
    </div>

    <div class="content">
        <!-- Tableau de bord -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard" id="dashboard-content">
                <!-- Les cartes utilisateurs seront g√©n√©r√©es ici -->
            </div>
        </div>

        <!-- Onglet Commun -->
        <div id="commun" class="tab-content">
            <!-- Section Balance : Qui doit combien √† qui -->
            <div class="section balance-section">
                <div class="section-header">
                    <h2 class="section-title">‚öñÔ∏è Balance : Qui doit quoi ?</h2>
                    <button class="btn btn-small" onclick="openShareModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        <span class="material-icons" style="font-size: 1rem;">share</span>
                        Partager
                    </button>
                </div>
                <div id="balance-content" class="items-list">
                    <div class="empty-state">Ajoutez des utilisateurs et des transactions pour voir la balance</div>
                </div>
            </div>

            <!-- Section Virements -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">üí∏ Virements entre personnes</h2>
                    <button class="btn btn-small" onclick="addTransfer()">+ Ajouter</button>
                </div>
                <div id="transfers-list" class="items-list">
                    <div class="empty-state">Aucun virement ajout√©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Revenus communs</h2>
                    <button class="btn btn-small" onclick="addIncome('commun')">+ Ajouter</button>
                </div>
                <div id="commun-incomes" class="items-list">
                    <div class="empty-state">Aucun revenu ajout√©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">D√©penses communes</h2>
                    <button class="btn btn-small" onclick="addCommonExpense()">+ Ajouter</button>
                </div>
                <div id="commun-expenses" class="items-list">
                    <div class="empty-state">Aucune d√©pense ajout√©e</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB menu pour actions rapides -->
    <button class="fab" id="fabButton" onclick="toggleFabMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    
    <div class="fab-menu" id="fabMenu">
        <button class="fab-item" onclick="quickAddIncome()" title="Ajouter un revenu">
            <span class="fab-label">Revenu</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 2v20M17 7l-5-5-5 5M17 17l-5-5-5 5"/>
            </svg>
        </button>
        <button class="fab-item" onclick="quickAddExpense()" title="Ajouter une d√©pense">
            <span class="fab-label">D√©pense</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <path d="M12 2v20M7 7l5 5 5-5M7 17l5-5 5 5"/>
            </svg>
        </button>
        <button class="fab-item" onclick="toggleCalculator()" title="Calculatrice">
            <span class="fab-label">Calculer</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                <line x1="8" y1="6" x2="16" y2="6"></line>
                <line x1="8" y1="10" x2="16" y2="10"></line>
            </svg>
        </button>
    </div>

    <!-- Modal pour ajouter un onglet -->
    <div class="modal" id="addTabModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un utilisateur</div>
            <div class="modal-body">
                <input type="text" class="input" id="newTabName" placeholder="Nom de l'utilisateur">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTabModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTab()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter un revenu -->
    <div class="modal" id="addIncomeModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un revenu</div>
            <div class="modal-body">
                <input type="text" class="input" id="incomeName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="incomeAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addIncomeModal')">Annuler</button>
                <button class="btn" onclick="confirmAddIncome()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une d√©pense -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter une d√©pense</div>
            <div class="modal-body">
                <input type="text" class="input" id="expenseName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="expenseAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddExpense()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une d√©pense commune -->
    <div class="modal" id="addCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter une d√©pense commune</div>
            <div class="modal-body">
                <input type="text" class="input" id="commonExpenseName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="commonExpenseAmount" placeholder="Montant total" step="0.01">
                <div style="margin-top: 1rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Participants :</label>
                    <div class="participants" id="participantsList">
                        <!-- Les participants seront g√©n√©r√©s ici -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddCommonExpense()">Ajouter</button>
            </div>
        </div>
    </div>

<!-- Modal de partage -->
    <div class="modal" id="shareModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">üîó Partager ce groupe</div>
            <div class="modal-body">
                
                <!-- Section 1 : Code du groupe -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                        Votre code de groupe unique
                    </p>
                    <div class="share-code" id="shareCode">XXXXX</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-small" onclick="copyShareCode()">
                            <span class="material-icons" style="font-size: 1rem;">content_copy</span>
                            Copier le code
                        </button>
                        <button class="btn btn-small btn-success" onclick="copyShareLink()">
                            <span class="material-icons" style="font-size: 1rem;">link</span>
                            Copier le lien
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.75rem;">
                        üí° Le lien permet d'importer directement les donn√©es
                    </p>
                </div>
                
                <!-- Section 2 : Rejoindre un groupe -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üì•</span> Rejoindre un groupe
                    </h4>
                    <input type="text" class="input" id="joinCode" placeholder="Entrez le code du groupe" style="text-transform: uppercase; letter-spacing: 0.1em; text-align: center; margin-bottom: 0.75rem;">
                    <button class="btn" onclick="joinGroup()" style="width: 100%;">
                        <span class="material-icons">group_add</span>
                        Rejoindre
                    </button>
                </div>
                
                <!-- Section 3 : Export/Import fichier -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>üíæ</span> Sauvegarde fichier
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 1rem;">
                        Exportez vos donn√©es dans un fichier ou importez depuis un fichier
                    </p>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="exportToFile()" style="flex: 1;">
                            <span class="material-icons">download</span>
                            T√©l√©charger
                        </button>
                        <button class="btn btn-outline" onclick="importFromFile()" style="flex: 1;">
                            <span class="material-icons">upload</span>
                            Importer
                        </button>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('shareModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>
	
    <!-- Modal pour ajouter un virement -->
    <div class="modal" id="addTransferModal">
        <div class="modal-content">
            <div class="modal-header">üí∏ Ajouter un virement</div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                    Un virement repr√©sente de l'argent qu'une personne a sur son compte mais qui appartient √† quelqu'un d'autre.
                </p>
                <input type="text" class="input" id="transferDescription" placeholder="Description (ex: Salaire avanc√©)" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="transferAmount" placeholder="Montant" step="0.01" style="margin-bottom: 0.75rem;">
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">De :</label>
                    <select class="input" id="transferFrom" style="margin-bottom: 0.75rem;">
                        <!-- G√©n√©r√© dynamiquement -->
                    </select>
                </div>
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Vers (√† qui appartient l'argent) :</label>
                    <select class="input" id="transferTo">
                        <!-- G√©n√©r√© dynamiquement -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTransferModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTransfer()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal calculatrice -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">Calculatrice</div>
            <div class="modal-body">
                <div class="calculator">
                    <div class="calc-display" id="calcDisplay">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn" onclick="clearCalc()">C</button>
                        <button class="calc-btn" onclick="appendToCalc('/')">/</button>
                        <button class="calc-btn" onclick="appendToCalc('*')">√ó</button>
                        <button class="calc-btn" onclick="deleteLastCalc()">‚Üê</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('7')">7</button>
                        <button class="calc-btn" onclick="appendToCalc('8')">8</button>
                        <button class="calc-btn" onclick="appendToCalc('9')">9</button>
                        <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('4')">4</button>
                        <button class="calc-btn" onclick="appendToCalc('5')">5</button>
                        <button class="calc-btn" onclick="appendToCalc('6')">6</button>
                        <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('1')">1</button>
                        <button class="calc-btn" onclick="appendToCalc('2')">2</button>
                        <button class="calc-btn" onclick="appendToCalc('3')">3</button>
                        <button class="calc-btn" onclick="appendToCalc('.')">.</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('0')">0</button>
                        <button class="calc-btn equal" onclick="calculateResult()">=</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('calculatorModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal param√®tres -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">Param√®tres</div>
            <div class="modal-body">
    <div style="display: grid; gap: 1rem;">
        <!-- Bouton d'installation (visible seulement si non install√©) -->
        <button class="btn" id="installAppBtn" style="background-color: #2563eb; display: none;" onclick="installApp()">
            <span class="material-icons">install_mobile</span>
            Installer l'application
        </button>
		<button class="btn" onclick="togglePinSecurity()">
			<span class="material-icons">lock</span>
			<span id="pinButtonText">Activer le code PIN</span>
		</button>
        <button class="btn" onclick="exportData()">
            <span class="material-icons">download</span>
            Exporter les donn√©es
        </button>
		<button class="btn" onclick="exportToPDF()">
            <span class="material-icons">picture_as_pdf</span>
            Exporter en PDF
        </button>
        <button class="btn" onclick="importData()">
            <span class="material-icons">upload</span>
            Importer des donn√©es
        </button>
        <button class="btn" style="background-color: #e11d48;" onclick="showDonationPopup()">
            <span class="material-icons">favorite</span>
            Soutenir ce projet gratuit
        </button>
        <button class="btn btn-danger" onclick="confirmReset()">
            <span class="material-icons">delete_forever</span>
            R√©initialiser tout
        </button>
    </div>
</div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('settingsModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal statistiques -->
    <div class="modal" id="statsModal">
        <div class="modal-content">
            <div class="modal-header">Statistiques globales</div>
            <div class="modal-body">
                <div id="statsContent" style="display: grid; gap: 1rem;">
                    <!-- Le contenu sera g√©n√©r√© dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('statsModal')">Fermer</button>
            </div>
        </div>
    </div>

    <script>
    // √âtat global de l'application
	let currentTab = 'dashboard';
    let appData = {
        users: {
            'commun': {
                name: 'Commun',
                incomes: [],
                expenses: []
            }
        },
        commonExpenses: [],
        transfers: [], // Nouveau : virements entre personnes
        currentTab: 'dashboard',
        theme: 'dark'
    };

    // Variables globales
    let currentUser = '';
    let calcExpression = '0';
    let confirmCallback = null;
    let actionCount = 0;
    let sessionStart = Date.now();

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
    // Appliquer le th√®me sauvegard√© ou celui d√©j√† d√©fini par le script du head
    const preferredTheme = localStorage.getItem('preferredTheme') || 
                          document.body.getAttribute('data-theme') || 
                          'dark';
    
    document.body.setAttribute('data-theme', preferredTheme);
    document.documentElement.setAttribute('data-theme', preferredTheme);
    
    // Forcer la synchronisation du th√®me apr√®s le chargement des donn√©es
    if (appData.theme !== preferredTheme) {
        appData.theme = preferredTheme;
        saveData();
    }
    
    loadData();
    checkUrlImport();
	initSecurity();
	syncTheme();
    initPWA();
    renderApp();
    initDonation();
        
        // Masquer le FAB au d√©marrage si on est sur le tableau de bord
        if (appData.currentTab === 'dashboard') {
            document.getElementById('fabButton').style.display = 'none';
        }
        
        // Surcharge de exportData pour le tracking
        const originalExportData = exportData;
        window.exportData = function() {
            originalExportData();
            trackUserAction();
            
            // Message contextuel apr√®s export (seulement une fois)
            if (!localStorage.getItem('exportDonationSuggested')) {
                setTimeout(() => {
                    if (confirm('‚úÖ Donn√©es export√©es avec succ√®s !\n\nCette application vous fait gagner du temps ?\nConsid√©rez un petit don pour nous aider √† la maintenir gratuite ! üíñ')) {
                        showDonationPopup();
                    }
                    localStorage.setItem('exportDonationSuggested', 'true');
                }, 500);
            }
        };
        
        setInterval(saveData, 5000); // Sauvegarde automatique toutes les 5 secondes
    });

    // Fonctions de gestion des donn√©es
    function loadData() {
    const saved = localStorage.getItem('expenseTrackerData');
    if (saved) {
        appData = JSON.parse(saved);
    }
    
    // Charger le th√®me pr√©f√©r√© de l'utilisateur
    const preferredTheme = localStorage.getItem('preferredTheme');
    if (preferredTheme) {
        appData.theme = preferredTheme;
        document.body.setAttribute('data-theme', preferredTheme);
    } else {
        // Si pas de pr√©f√©rence sauvegard√©e, utiliser le th√®me actuel du body ou dark par d√©faut
        const currentBodyTheme = document.body.getAttribute('data-theme') || 'dark';
        appData.theme = currentBodyTheme;
        localStorage.setItem('preferredTheme', currentBodyTheme);
    }
}

    function saveData() {
        localStorage.setItem('expenseTrackerData', JSON.stringify(appData));
    }

    // Fonctions de donation
    function trackUserAction() {
        actionCount++;
        const sessionTime = Date.now() - sessionStart;
        
        // Apr√®s 10 actions ou 5 minutes d'utilisation dans la session
        if ((actionCount >= 10 || sessionTime > 300000) && !sessionStorage.getItem('donationShownThisSession')) {
            const lastPrompt = localStorage.getItem('lastDonationPrompt');
            const hoursSinceLastPrompt = lastPrompt ? 
                (Date.now() - parseInt(lastPrompt)) / (1000 * 60 * 60) : 999;
            
            // Ne pas montrer si d√©j√† montr√© dans les derni√®res 24h
            if (hoursSinceLastPrompt > 24) {
                showDonationPopup();
                sessionStorage.setItem('donationShownThisSession', 'true');
                localStorage.setItem('lastDonationPrompt', Date.now());
            }
        }
    }

    function showDonationPopup() {
        const popup = document.getElementById('donationPopup');
        if (popup) {
            popup.style.display = 'flex';
        }
    }

    function closeDonationPopup() {
        const popup = document.getElementById('donationPopup');
        if (popup) {
            popup.style.display = 'none';
        }
    }

    function initDonation() {
    const donationPopup = document.getElementById('donationPopup');
    if (donationPopup) {
        donationPopup.addEventListener('click', (e) => {
            if (e.target === donationPopup) {
                closeDonationPopup();
            }
        });
    }
    
    const firstUse = localStorage.getItem('firstUse');
    if (!firstUse) {
        localStorage.setItem('firstUse', Date.now());
        
        // Pour les nouveaux utilisateurs : popup apr√®s 10 minutes d'utilisation
        setTimeout(() => {
            if (!sessionStorage.getItem('donationShownThisSession')) {
                showDonationPopup();
                sessionStorage.setItem('donationShownThisSession', 'true');
                localStorage.setItem('lastDonationPrompt', Date.now());
            }
        }, 600000); // 10 minutes
        return;
    }
    
    // Pour les utilisateurs r√©guliers : syst√®me existant
    const daysSinceFirstUse = (Date.now() - parseInt(firstUse)) / (1000 * 60 * 60 * 24);
    const lastDonationPrompt = localStorage.getItem('lastDonationPrompt');
    const daysSinceLastPrompt = lastDonationPrompt ? 
        (Date.now() - parseInt(lastDonationPrompt)) / (1000 * 60 * 60 * 24) : 999;
    
    // Apr√®s 3 jours puis tous les 30 jours
    if (daysSinceFirstUse >= 3 && daysSinceLastPrompt >= 30) {
        setTimeout(() => {
            showDonationPopup();
            localStorage.setItem('lastDonationPrompt', Date.now());
        }, 60000); // 1 minute apr√®s ouverture
    }
}

    // Fonctions de rendu
    function renderApp() {
        renderTabs();
        renderDashboard();
        renderUserTabs();
        renderCommonTab();
        renderBalance();
        renderTransfers();
        updatePinButtonText();
    }

    function renderTabs() {
        const container = document.getElementById('tabs');
        container.innerHTML = '';
        
        // Onglet Tableau de bord (toujours en premier)
        const dashboardTab = document.createElement('button');
        dashboardTab.className = 'tab' + (currentTab === 'dashboard' ? ' active' : '');
        dashboardTab.textContent = 'Tableau de bord';
        dashboardTab.onclick = () => switchTab('dashboard');
        container.appendChild(dashboardTab);
        
        // Onglets des utilisateurs
        Object.keys(appData.users).forEach(userId => {
            if (userId === 'commun') return;
            const tab = document.createElement('button');
            tab.className = 'tab' + (currentTab === userId ? ' active' : '');
            tab.textContent = appData.users[userId].name;
            tab.onclick = () => switchTab(userId);
            container.appendChild(tab);
        });
        
        // Onglet Balance (anciennement Commun)
        const communTab = document.createElement('button');
        communTab.className = 'tab' + (currentTab === 'commun' ? ' active' : '');
        communTab.textContent = 'Balance';
        communTab.onclick = () => switchTab('commun');
        container.appendChild(communTab);
        
        // Bouton ajouter utilisateur
        const addBtn = document.createElement('button');
        addBtn.className = 'add-tab';
        addBtn.textContent = '+';
        addBtn.onclick = () => openModal('addTabModal');
        container.appendChild(addBtn);
    }

    function renderDashboard() {
        const container = document.getElementById('dashboard-content');
        container.innerHTML = '';
        
        // D'abord, afficher tous les utilisateurs (sauf Commun)
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                renderUserCard(userId, container);
            }
        }
        
        // Ensuite, afficher Commun en dernier
        if (appData.users.commun) {
            renderUserCard('commun', container);
        }
    }
    
    function renderUserCard(userId, container) {
        const user = appData.users[userId];
        const totalIncome = user.incomes.reduce((sum, item) => sum + item.amount, 0);
        const totalExpense = user.expenses.reduce((sum, item) => sum + item.amount, 0);
        
        // Calculer la part des d√©penses communes
        let commonShare = 0;
        if (userId !== 'commun') {
            appData.commonExpenses.forEach(expense => {
                if (expense.participants.includes(userId)) {
                    commonShare += expense.amount / expense.participants.length;
                }
            });
        }
        
        // Calculer les virements (argent d√©tenu pour d'autres)
        let transferBalance = 0;
        if (appData.transfers && userId !== 'commun') {
            appData.transfers.forEach(transfer => {
                if (transfer.from === userId) {
                    transferBalance -= transfer.amount;
                }
                if (transfer.to === userId) {
                    transferBalance += transfer.amount;
                }
            });
        }
        
        const balance = totalIncome - totalExpense - commonShare;
        const isPositive = balance >= 0;
        
        // G√©n√©rer l'initiale pour l'avatar
        const initial = user.name.charAt(0).toUpperCase();
        
        // Emoji selon le type
        const emoji = userId === 'commun' ? 'üë•' : 'üë§';
        
        // Info virement
        let transferInfo = '';
        if (transferBalance !== 0 && userId !== 'commun') {
            if (transferBalance > 0) {
                transferInfo = `<div class="transfer-info" style="color: var(--success);">üí∞ +${transferBalance.toFixed(2)}‚Ç¨ √† r√©cup√©rer</div>`;
            } else {
                transferInfo = `<div class="transfer-info" style="color: var(--danger);">üí∏ ${transferBalance.toFixed(2)}‚Ç¨ √† rembourser</div>`;
            }
        }
        
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
            <div class="user-card-header">
                <div class="user-avatar">${emoji}</div>
                <h3>${user.name}</h3>
            </div>
            <div class="user-card-body">
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-icon">üìà</div>
                        <div class="stat-label">Revenus</div>
                        <div class="stat-value">+${totalIncome.toFixed(2)}‚Ç¨</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-icon">üìâ</div>
                        <div class="stat-label">D√©penses</div>
                        <div class="stat-value">-${(totalExpense + commonShare).toFixed(2)}‚Ç¨</div>
                    </div>
                </div>
                <div class="balance-card ${isPositive ? 'positive' : 'negative'}">
                    <div class="balance-label">üí∞ Solde disponible</div>
                    <div class="balance-value">${balance >= 0 ? '+' : ''}${balance.toFixed(2)}‚Ç¨</div>
                    ${transferInfo}
                </div>
            </div>
        `;
        container.appendChild(card);
    }

    function renderUserTabs() {
        // Cr√©er les contenus d'onglets pour chaque utilisateur
        const content = document.querySelector('.content');
        
        // Supprimer les anciens onglets utilisateurs
        document.querySelectorAll('.user-tab-content').forEach(el => el.remove());
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const tabContent = document.createElement('div');
                tabContent.id = userId;
                tabContent.className = `tab-content user-tab-content ${appData.currentTab === userId ? 'active' : ''}`;
                
                tabContent.innerHTML = `
                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">Revenus</h2>
                            <button class="btn btn-small" onclick="addIncome('${userId}')">+ Ajouter</button>
                        </div>
                        <div id="${userId}-incomes" class="items-list">
                            ${renderItems(appData.users[userId].incomes, 'income', userId)}
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <h2 class="section-title">D√©penses</h2>
                            <button class="btn btn-small" onclick="addExpense('${userId}')">+ Ajouter</button>
                        </div>
                        <div id="${userId}-expenses" class="items-list">
                            ${renderItems(appData.users[userId].expenses, 'expense', userId)}
                        </div>
                    </div>
                    
                    <div class="section" style="margin-top: 2rem; text-align: center;">
                        <button class="btn btn-danger" onclick="deleteUser('${userId}')">
                            <span class="material-icons">delete_forever</span>
                            Supprimer cet utilisateur
                        </button>
                    </div>
                `;
                
                content.appendChild(tabContent);
            }
        }
    }

    function renderCommonTab() {
        // Rendu des revenus communs
        const commonIncomes = document.getElementById('commun-incomes');
        commonIncomes.innerHTML = renderItems(appData.users.commun.incomes, 'income', 'commun');
        
        // Rendu des d√©penses communes
        const commonExpenses = document.getElementById('commun-expenses');
        if (appData.commonExpenses.length === 0) {
            commonExpenses.innerHTML = '<div class="empty-state">Aucune d√©pense commune ajout√©e</div>';
        } else {
            commonExpenses.innerHTML = appData.commonExpenses.map((expense, index) => `
                <div class="item">
                    <div class="item-info">
                        <div class="item-name">${expense.name}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">
                            Participants: ${expense.participants.map(p => appData.users[p].name).join(', ')}
                        </div>
                    </div>
                    <div class="item-actions">
                        <span class="item-amount expense">-${expense.amount.toFixed(2)}‚Ç¨</span>
                        <button class="btn btn-small btn-danger" onclick="deleteCommonExpense(${index})">√ó</button>
                    </div>
                </div>
            `).join('');
        }
    }

    function renderItems(items, type, userId) {
        if (items.length === 0) {
            const icon = type === 'income' ? 'üìà' : 'üìâ';
            return `
                <div class="empty-state">
                    <div class="empty-state-icon">${icon}</div>
                    <div class="empty-state-text">Aucun √©l√©ment ajout√©</div>
                </div>
            `;
        }
        
        const icon = type === 'income' ? 'üíµ' : 'üõí';
        const itemClass = type === 'income' ? 'income-item' : 'expense-item';
        
        return items.map((item, index) => `
            <div class="item ${itemClass}">
                <div class="item-icon ${type}">${icon}</div>
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div class="item-meta">${new Date(item.date).toLocaleDateString('fr-FR')}</div>
                </div>
                <div class="item-actions">
                    <span class="item-amount ${type}">${type === 'income' ? '+' : '-'}${item.amount.toFixed(2)}‚Ç¨</span>
                    <button class="btn-delete" onclick="deleteItem('${userId}', '${type}s', ${index})">√ó</button>
                </div>
            </div>
        `).join('');
    }

    // Gestion des onglets
    function switchTab(tabId) {
        appData.currentTab = tabId;
        
        // Mettre √† jour les onglets actifs
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        
        // Activer le bon onglet
        const activeTab = Array.from(document.querySelectorAll('.tab')).find(tab => 
            tab.textContent === (tabId === 'dashboard' ? 'Tableau de bord' : 
                               tabId === 'commun' ? 'Commun' : 
                               appData.users[tabId]?.name)
        );
        if (activeTab) activeTab.classList.add('active');
        
        const activeContent = document.getElementById(tabId);
        if (activeContent) activeContent.classList.add('active');
        
        // Masquer/afficher le FAB selon l'onglet
        const fabButton = document.getElementById('fabButton');
        if (tabId === 'dashboard') {
            fabButton.style.display = 'none';
        } else {
            fabButton.style.display = 'flex';
        }
        
        saveData();
    }

    function addNewTab() {
        document.getElementById('newTabName').value = '';
        openModal('addTabModal');
    }

    function confirmAddTab() {
        const name = document.getElementById('newTabName').value.trim();
        if (name) {
            const userId = 'user_' + Date.now();
            appData.users[userId] = {
                name: name,
                incomes: [],
                expenses: []
            };
            saveData();
            renderApp();
            switchTab(userId);
            closeModal('addTabModal');
        }
    }

    // Gestion des revenus
    function addIncome(userId) {
        currentUser = userId;
        document.getElementById('incomeName').value = '';
        document.getElementById('incomeAmount').value = '';
        openModal('addIncomeModal');
    }

    function confirmAddIncome() {
        const name = document.getElementById('incomeName').value.trim();
        const amount = parseFloat(document.getElementById('incomeAmount').value);
        
        if (name && amount > 0) {
            appData.users[currentUser].incomes.push({
                name: name,
                amount: amount,
                date: new Date().toISOString()
            });
            saveData();
            renderApp();
            closeModal('addIncomeModal');
            trackUserAction();
        }
    }

    // Gestion des d√©penses
    function addExpense(userId) {
        currentUser = userId;
        document.getElementById('expenseName').value = '';
        document.getElementById('expenseAmount').value = '';
        openModal('addExpenseModal');
    }

    function confirmAddExpense() {
        const name = document.getElementById('expenseName').value.trim();
        const amount = parseFloat(document.getElementById('expenseAmount').value);
        
        if (name && amount > 0) {
            appData.users[currentUser].expenses.push({
                name: name,
                amount: amount,
                date: new Date().toISOString()
            });
            saveData();
            renderApp();
            closeModal('addExpenseModal');
            trackUserAction();
        }
    }

    // Gestion des d√©penses communes
    function addCommonExpense() {
        document.getElementById('commonExpenseName').value = '';
        document.getElementById('commonExpenseAmount').value = '';
        
        // G√©n√©rer la liste des participants
        const participantsList = document.getElementById('participantsList');
        participantsList.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const checkbox = document.createElement('div');
                checkbox.className = 'participant-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="participant_${userId}" value="${userId}">
                    <label for="participant_${userId}">${appData.users[userId].name}</label>
                `;
                participantsList.appendChild(checkbox);
            }
        }
        
        openModal('addCommonExpenseModal');
    }

    function confirmAddCommonExpense() {
        const name = document.getElementById('commonExpenseName').value.trim();
        const amount = parseFloat(document.getElementById('commonExpenseAmount').value);
        
        // R√©cup√©rer les participants s√©lectionn√©s
        const participants = [];
        document.querySelectorAll('#participantsList input[type="checkbox"]:checked').forEach(checkbox => {
            participants.push(checkbox.value);
        });
        
        if (name && amount > 0 && participants.length > 0) {
            appData.commonExpenses.push({
                name: name,
                amount: amount,
                participants: participants,
                date: new Date().toISOString()
            });
            saveData();
            renderApp();
            closeModal('addCommonExpenseModal');
            trackUserAction();
        }
    }

    // Suppression d'un utilisateur
    function deleteUser(userId) {
        const userName = appData.users[userId].name;
        confirmCallback = () => {
            // V√©rifier si l'utilisateur participe √† des d√©penses communes
            const participatesInCommon = appData.commonExpenses.some(expense => 
                expense.participants.includes(userId)
            );
            
            if (participatesInCommon) {
                alert(`Impossible de supprimer ${userName} car il/elle participe √† des d√©penses communes. Retirez d'abord sa participation aux d√©penses communes.`);
                return;
            }
            
            // Supprimer l'utilisateur
            delete appData.users[userId];
            
            // Si on √©tait sur cet onglet, retourner au tableau de bord
            if (appData.currentTab === userId) {
                appData.currentTab = 'dashboard';
            }
            
            saveData();
            renderApp();
        };
        showConfirm(`√ätes-vous s√ªr de vouloir supprimer l'utilisateur "${userName}" et toutes ses donn√©es ?`);
    }

    // Suppression d'√©l√©ments
    function deleteItem(userId, type, index) {
        confirmCallback = () => {
            appData.users[userId][type].splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('√ätes-vous s√ªr de vouloir supprimer cet √©l√©ment ?');
    }

// ========== GESTION DES VIREMENTS ==========
    
    // Ouvrir le modal d'ajout de virement
    function addTransfer() {
        document.getElementById('transferDescription').value = '';
        document.getElementById('transferAmount').value = '';
        
        // G√©n√©rer les listes d√©roulantes
        const transferFrom = document.getElementById('transferFrom');
        const transferTo = document.getElementById('transferTo');
        transferFrom.innerHTML = '';
        transferTo.innerHTML = '';
        
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const option1 = document.createElement('option');
                option1.value = userId;
                option1.textContent = appData.users[userId].name;
                transferFrom.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = userId;
                option2.textContent = appData.users[userId].name;
                transferTo.appendChild(option2);
            }
        }
        
        openModal('addTransferModal');
    }
    
    // Confirmer l'ajout d'un virement
    function confirmAddTransfer() {
        const description = document.getElementById('transferDescription').value.trim();
        const amount = parseFloat(document.getElementById('transferAmount').value);
        const fromUser = document.getElementById('transferFrom').value;
        const toUser = document.getElementById('transferTo').value;
        
        if (!description) {
            alert('Veuillez entrer une description');
            return;
        }
        if (!amount || amount <= 0) {
            alert('Veuillez entrer un montant valide');
            return;
        }
        if (fromUser === toUser) {
            alert('La personne source et destination doivent √™tre diff√©rentes');
            return;
        }
        
        // Initialiser le tableau des virements s'il n'existe pas
        if (!appData.transfers) {
            appData.transfers = [];
        }
        
        appData.transfers.push({
            description: description,
            amount: amount,
            from: fromUser,
            to: toUser,
            date: new Date().toISOString()
        });
        
        saveData();
        renderApp();
        closeModal('addTransferModal');
        trackUserAction();
        showSuccessMessage('Virement ajout√© !');
    }
    
    // Supprimer un virement
    function deleteTransfer(index) {
        confirmCallback = () => {
            appData.transfers.splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('√ätes-vous s√ªr de vouloir supprimer ce virement ?');
    }
    
    // Calculer la balance entre tous les utilisateurs
    function calculateBalance() {
        const balances = {}; // { "userId": montant } positif = doit recevoir, n√©gatif = doit payer
        
        // Initialiser les balances √† 0 pour chaque utilisateur
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                balances[userId] = 0;
            }
        }
        
        // 1. Prendre en compte les virements
        if (appData.transfers) {
            appData.transfers.forEach(transfer => {
                // La personne "from" a l'argent mais il appartient √† "to"
                // Donc "from" doit de l'argent √† "to"
                balances[transfer.from] -= transfer.amount; // from doit payer
                balances[transfer.to] += transfer.amount;   // to doit recevoir
            });
        }
        
        // 2. Prendre en compte les d√©penses communes
        appData.commonExpenses.forEach(expense => {
            const sharePerPerson = expense.amount / expense.participants.length;
            expense.participants.forEach(participantId => {
                balances[participantId] -= sharePerPerson; // Chacun doit sa part
            });
        });
        
        // 3. Prendre en compte les revenus personnels vs d√©penses personnelles
        for (const userId in appData.users) {
            if (userId !== 'commun') {
                const user = appData.users[userId];
                const totalIncome = user.incomes.reduce((sum, item) => sum + item.amount, 0);
                const totalExpense = user.expenses.reduce((sum, item) => sum + item.amount, 0);
                // Les revenus et d√©penses personnels n'affectent pas la balance entre utilisateurs
                // sauf si on veut les inclure dans un calcul global
            }
        }
        
        return balances;
    }
    
    // Calculer "qui doit combien √† qui" √† partir des balances
    function calculateDebts() {
        const balances = calculateBalance();
        const debts = []; // { from: userId, to: userId, amount: number }
        
        // S√©parer les d√©biteurs et cr√©diteurs
        const debtors = []; // Ceux qui doivent de l'argent (balance n√©gative)
        const creditors = []; // Ceux qui doivent recevoir de l'argent (balance positive)
        
        for (const userId in balances) {
            const balance = balances[userId];
            if (balance < -0.01) { // Seuil pour √©viter les erreurs d'arrondi
                debtors.push({ userId, amount: Math.abs(balance) });
            } else if (balance > 0.01) {
                creditors.push({ userId, amount: balance });
            }
        }
        
        // Algorithme simple pour minimiser les transactions
        debtors.sort((a, b) => b.amount - a.amount);
        creditors.sort((a, b) => b.amount - a.amount);
        
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
            const debtor = debtors[i];
            const creditor = creditors[j];
            
            const amount = Math.min(debtor.amount, creditor.amount);
            
            if (amount > 0.01) {
                debts.push({
                    from: debtor.userId,
                    to: creditor.userId,
                    amount: amount
                });
            }
            
            debtor.amount -= amount;
            creditor.amount -= amount;
            
            if (debtor.amount < 0.01) i++;
            if (creditor.amount < 0.01) j++;
        }
        
        return debts;
    }
    
    // Afficher la section Balance
    function renderBalance() {
        const container = document.getElementById('balance-content');
        if (!container) return;
        
        const userCount = Object.keys(appData.users).filter(id => id !== 'commun').length;
        
        if (userCount < 2) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;">üë•</div>
                    <div style="font-weight: 600; color: var(--text-primary);">Ajoutez des participants</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Il faut au moins 2 personnes pour calculer la balance</div>
                </div>
            `;
            return;
        }
        
        const debts = calculateDebts();
        
        if (debts.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                    <div style="font-weight: 600; color: var(--success); font-size: 1.125rem;">Tout est √©quilibr√© !</div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">Personne ne doit d'argent √† personne</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = debts.map(debt => {
            const fromName = appData.users[debt.from]?.name || 'Inconnu';
            const toName = appData.users[debt.to]?.name || 'Inconnu';
            const fromInitial = fromName.charAt(0).toUpperCase();
            
            return `
                <div style="
                    background: var(--bg-secondary);
                    border-radius: 16px;
                    padding: 1.25rem;
                    margin: 0.75rem;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
                    border: 1px solid var(--border);
                ">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="
                            width: 48px;
                            height: 48px;
                            border-radius: 50%;
                            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: white;
                            flex-shrink: 0;
                        ">${fromInitial}</div>
                        <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                            <span style="font-weight: 700; color: var(--danger);">${fromName}</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">doit payer √†</span>
                            <span style="font-weight: 700; color: var(--success);">${toName}</span>
                        </div>
                    </div>
                    <div style="
                        font-size: 1.5rem;
                        font-weight: 800;
                        color: var(--primary);
                        background: rgba(59, 130, 246, 0.1);
                        padding: 0.5rem 1rem;
                        border-radius: 12px;
                    ">${debt.amount.toFixed(2)}‚Ç¨</div>
                </div>
            `;
        }).join('');
    }
    
    // Afficher la liste des virements
    function renderTransfers() {
        const container = document.getElementById('transfers-list');
        if (!container) return;
        
        if (!appData.transfers || appData.transfers.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üí∏</div>
                    <div class="empty-state-text">Aucun virement ajout√©</div>
                </div>
            `;
            return;
        }
        
        container.innerHTML = appData.transfers.map((transfer, index) => {
            const fromName = appData.users[transfer.from]?.name || 'Inconnu';
            const toName = appData.users[transfer.to]?.name || 'Inconnu';
            return `
                <div class="item transfer-item">
                    <div class="item-icon transfer">üí∏</div>
                    <div class="item-info">
                        <div class="item-name">${transfer.description}</div>
                        <div class="item-meta">${fromName} d√©tient l'argent de ${toName}</div>
                    </div>
                    <div class="item-actions">
                        <span class="item-amount transfer">${transfer.amount.toFixed(2)}‚Ç¨</span>
                        <button class="btn-delete" onclick="deleteTransfer(${index})">√ó</button>
                    </div>
                </div>
            `;
        }).join('');
    }
	
	// ========== SYST√àME DE PARTAGE ==========
    
    // G√©n√©rer ou r√©cup√©rer l'ID du groupe
    function getGroupId() {
        if (!appData.groupId) {
            appData.groupId = generateGroupCode();
            saveData();
        }
        return appData.groupId;
    }
    
    // G√©n√©rer un code de groupe unique (5 caract√®res)
    function generateGroupCode() {
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let code = '';
        for (let i = 0; i < 5; i++) {
            code += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return code;
    }
    
    // Ouvrir le modal de partage
    function openShareModal() {
        const code = getGroupId();
        document.getElementById('shareCode').textContent = code;
        document.getElementById('joinCode').value = '';
        openModal('shareModal');
    }
    
    // Copier le code de partage
    function copyShareCode() {
        const code = document.getElementById('shareCode').textContent;
        copyToClipboard(code, 'Code copi√© ! üìã');
    }
    
    // Copier le lien de partage
    function copyShareLink() {
        const dataToShare = {
            groupId: getGroupId(),
            users: appData.users,
            commonExpenses: appData.commonExpenses,
            transfers: appData.transfers || [],
            exportDate: new Date().toISOString(),
            version: '2.0'
        };
        
        const jsonString = JSON.stringify(dataToShare);
        const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
        const shareUrl = `${window.location.origin}${window.location.pathname}?import=${base64Data}`;
        
        // V√©rifier si le lien n'est pas trop long
        if (shareUrl.length > 2000) {
            alert('‚ö†Ô∏è Trop de donn√©es pour un lien.\n\nUtilisez "T√©l√©charger" pour cr√©er un fichier de sauvegarde.');
            return;
        }
        
        copyToClipboard(shareUrl, 'Lien de partage copi√© ! üîó');
    }
    
    // Fonction utilitaire pour copier dans le presse-papier
    function copyToClipboard(text, successMessage) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage(successMessage);
            }).catch(() => {
                fallbackCopy(text, successMessage);
            });
        } else {
            fallbackCopy(text, successMessage);
        }
    }
    
    // Fallback pour copier sur les anciens navigateurs
    function fallbackCopy(text, successMessage) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showSuccessMessage(successMessage);
        } catch (err) {
            alert('Erreur lors de la copie. Copiez manuellement : ' + text);
        }
        document.body.removeChild(textArea);
    }
    
    // Exporter les donn√©es dans un fichier
    function exportToFile() {
        const dataToExport = {
            groupId: getGroupId(),
            users: appData.users,
            commonExpenses: appData.commonExpenses,
            transfers: appData.transfers || [],
            exportDate: new Date().toISOString(),
            version: '2.0'
        };
        
        const jsonString = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `depenses_${getGroupId()}_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccessMessage('Fichier t√©l√©charg√© ! üì•');
    }
    
    // Importer les donn√©es depuis un fichier
    function importFromFile() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const importedData = JSON.parse(event.target.result);
                    
                    // V√©rifier que c'est un fichier valide
                    if (!importedData.users || !importedData.groupId) {
                        alert('‚ùå Fichier invalide.\n\nCe fichier ne contient pas de donn√©es de d√©penses valides.');
                        return;
                    }
                    
                    const userCount = Object.keys(importedData.users).filter(id => id !== 'commun').length;
                    const expenseCount = (importedData.commonExpenses || []).length;
                    const transferCount = (importedData.transfers || []).length;
                    
                    if (confirm(`üì¶ Importer les donn√©es du groupe "${importedData.groupId}" ?\n\n` +
                               `‚Ä¢ ${userCount} utilisateur(s)\n` +
                               `‚Ä¢ ${expenseCount} d√©pense(s) commune(s)\n` +
                               `‚Ä¢ ${transferCount} virement(s)\n\n` +
                               `‚ö†Ô∏è Cela remplacera vos donn√©es actuelles.`)) {
                        mergeImportedData(importedData);
                        showSuccessMessage('Donn√©es import√©es ! ‚úÖ');
                        closeModal('shareModal');
                    }
                } catch (error) {
                    alert('‚ùå Erreur lors de l\'import.\n\nLe fichier est corrompu ou invalide.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        };
        
        input.click();
    }
    
    // Rejoindre un groupe avec un code
    function joinGroup() {
        const code = document.getElementById('joinCode').value.trim().toUpperCase();
        
        if (!code || code.length < 5) {
            alert('‚ö†Ô∏è Code invalide\n\nEntrez un code de 5 caract√®res.');
            return;
        }
        
        // V√©rifier si c'est le m√™me groupe
        if (code === getGroupId()) {
            showSuccessMessage('Vous √™tes d√©j√† dans ce groupe ! üëç');
            return;
        }
        
        // Informer l'utilisateur comment synchroniser
        alert(`üì≤ Pour rejoindre le groupe "${code}" :\n\n` +
              `1. Demandez au propri√©taire du groupe de vous envoyer :\n` +
              `   ‚Ä¢ Le lien de partage (bouton "Copier le lien")\n` +
              `   ‚Ä¢ Ou le fichier de sauvegarde (bouton "T√©l√©charger")\n\n` +
              `2. Ouvrez le lien re√ßu\n` +
              `   Ou importez le fichier (bouton "Importer")\n\n` +
              `üí° Le propri√©taire du groupe a le code "${getGroupId()}"`);
    }
    
    // Fusionner les donn√©es import√©es
    function mergeImportedData(importedData) {
        appData.groupId = importedData.groupId;
        appData.users = importedData.users;
        appData.commonExpenses = importedData.commonExpenses || [];
        appData.transfers = importedData.transfers || [];
        
        saveData();
        renderApp();
    }
    
    // V√©rifier s'il y a des donn√©es √† importer dans l'URL
    function checkUrlImport() {
        const urlParams = new URLSearchParams(window.location.search);
        const importData = urlParams.get('import');
        
        if (importData) {
            try {
                const jsonString = decodeURIComponent(escape(atob(importData)));
                const importedData = JSON.parse(jsonString);
                
                const userCount = Object.keys(importedData.users).filter(id => id !== 'commun').length;
                const expenseCount = (importedData.commonExpenses || []).length;
                
                if (confirm(`üì¶ Importer les donn√©es du groupe "${importedData.groupId}" ?\n\n` +
                           `‚Ä¢ ${userCount} utilisateur(s)\n` +
                           `‚Ä¢ ${expenseCount} d√©pense(s) commune(s)\n\n` +
                           `‚ö†Ô∏è Cela remplacera vos donn√©es actuelles.`)) {
                    mergeImportedData(importedData);
                    showSuccessMessage('Donn√©es import√©es depuis le lien ! ‚úÖ');
                }
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                console.error('Erreur import URL:', error);
            }
        }
    }
	
    function deleteCommonExpense(index) {
        confirmCallback = () => {
            appData.commonExpenses.splice(index, 1);
            saveData();
            renderApp();
        };
        showConfirm('√ätes-vous s√ªr de vouloir supprimer cette d√©pense commune ?');
    }

    // Menu FAB
    let fabMenuOpen = false;
    
    function toggleFabMenu() {
        fabMenuOpen = !fabMenuOpen;
        const fabMenu = document.getElementById('fabMenu');
        const fabButton = document.getElementById('fabButton');
        
        if (fabMenuOpen) {
            fabMenu.classList.add('active');
            fabButton.style.transform = 'rotate(45deg)';
        } else {
            fabMenu.classList.remove('active');
            fabButton.style.transform = 'rotate(0deg)';
        }
    }
    
    function closeFabMenu() {
        fabMenuOpen = false;
        document.getElementById('fabMenu').classList.remove('active');
        document.getElementById('fabButton').style.transform = 'rotate(0deg)';
    }

    // Ajout rapide de revenu
    function quickAddIncome() {
        closeFabMenu();
        if (appData.currentTab === 'dashboard' || appData.currentTab === 'commun') {
            // Si on est sur le tableau de bord ou commun, utiliser le premier utilisateur
            const firstUser = Object.keys(appData.users).find(id => id !== 'commun');
            if (firstUser) {
                addIncome(firstUser);
            }
        } else {
            addIncome(appData.currentTab);
        }
    }

    // Ajout rapide de d√©pense
    function quickAddExpense() {
        closeFabMenu();
        if (appData.currentTab === 'commun') {
            addCommonExpense();
        } else if (appData.currentTab === 'dashboard') {
            // Si on est sur le tableau de bord, utiliser le premier utilisateur
            const firstUser = Object.keys(appData.users).find(id => id !== 'commun');
            if (firstUser) {
                addExpense(firstUser);
            }
        } else {
            addExpense(appData.currentTab);
        }
    }

    // Fermer le menu FAB en cliquant ailleurs
    document.addEventListener('click', (e) => {
        if (fabMenuOpen && !e.target.closest('.fab') && !e.target.closest('.fab-menu')) {
            closeFabMenu();
        }
    });

    // Calculatrice
    function toggleCalculator() {
        closeFabMenu();
        openModal('calculatorModal');
    }

    function appendToCalc(value) {
        if (calcExpression === '0' && value !== '.') {
            calcExpression = value;
        } else {
            calcExpression += value;
        }
        updateCalcDisplay();
    }

    function clearCalc() {
        calcExpression = '0';
        updateCalcDisplay();
    }

    function deleteLastCalc() {
        if (calcExpression.length > 1) {
            calcExpression = calcExpression.slice(0, -1);
        } else {
            calcExpression = '0';
        }
        updateCalcDisplay();
    }

    function calculateResult() {
        try {
            const result = eval(calcExpression);
            calcExpression = result.toString();
            updateCalcDisplay();
        } catch (e) {
            document.getElementById('calcDisplay').textContent = 'Erreur';
            calcExpression = '0';
        }
    }

    function updateCalcDisplay() {
        const display = document.getElementById('calcDisplay');
        display.textContent = calcExpression;
        
        // Ajuster la taille du texte si n√©cessaire
        if (calcExpression.length > 15) {
            display.style.fontSize = '1rem';
        } else if (calcExpression.length > 10) {
            display.style.fontSize = '1.25rem';
        } else {
            display.style.fontSize = '1.5rem';
        }
    }

    // Gestion du clavier pour la calculatrice
    function handleCalculatorKeyboard(e) {
        const modal = document.getElementById('calculatorModal');
        if (!modal.classList.contains('active')) return;
        
        e.preventDefault();
        
        // Chiffres
        if (e.key >= '0' && e.key <= '9') {
            appendToCalc(e.key);
        }
        // Op√©rateurs
        else if (e.key === '+' || e.key === '-' || e.key === '*' || e.key === '/') {
            appendToCalc(e.key);
        }
        // Point d√©cimal
        else if (e.key === '.' || e.key === ',') {
            appendToCalc('.');
        }
        // √âgal
        else if (e.key === 'Enter' || e.key === '=') {
            calculateResult();
        }
        // Effacer
        else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') {
            clearCalc();
        }
        // Supprimer dernier caract√®re
        else if (e.key === 'Backspace') {
            deleteLastCalc();
        }
    }

    // Ajouter l'√©couteur d'√©v√©nements au chargement
    document.addEventListener('keydown', handleCalculatorKeyboard);

    // Th√®me
function toggleTheme() {
    // Obtenir le th√®me actuel du body (source de v√©rit√©)
    const currentTheme = document.body.getAttribute('data-theme') || 'dark';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    
    console.log('Toggle theme:', currentTheme, '->', newTheme); // Debug
    
    // Appliquer le nouveau th√®me
    document.body.setAttribute('data-theme', newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
    appData.theme = newTheme;
    
    // Sauvegarder le choix du th√®me
    localStorage.setItem('preferredTheme', newTheme);
    saveData();
}

// Fonction pour synchroniser le th√®me
function syncTheme() {
    const bodyTheme = document.body.getAttribute('data-theme');
    const savedTheme = localStorage.getItem('preferredTheme');
    const appTheme = appData.theme;
    
    // Si tous ne sont pas synchronis√©s, utiliser la pr√©f√©rence sauvegard√©e
    if (savedTheme && (bodyTheme !== savedTheme || appTheme !== savedTheme)) {
        document.body.setAttribute('data-theme', savedTheme);
        document.documentElement.setAttribute('data-theme', savedTheme);
        appData.theme = savedTheme;
        console.log('Theme synchronized to:', savedTheme);
    }
}

    // Param√®tres
    function openSettings() {
		updatePinButtonText();
        openModal('settingsModal');
    }

    function exportData() {
        const dataStr = JSON.stringify(appData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `depenses_export_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
        closeModal('settingsModal');
    }

    function importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
    try {
        const data = JSON.parse(event.target.result);
        appData = data;
        
        // Conserver le th√®me pr√©f√©r√© de l'utilisateur
        const preferredTheme = localStorage.getItem('preferredTheme') || 'dark';
        appData.theme = preferredTheme;
        document.body.setAttribute('data-theme', preferredTheme);
        
        saveData();
        renderApp();
        closeModal('settingsModal');
        alert('Donn√©es import√©es avec succ√®s !');
    } catch (error) {
        alert('Erreur lors de l\'importation des donn√©es');
    }
};
                reader.readAsText(file);
            }
        };
        input.click();
    }

    function confirmReset() {
        confirmCallback = () => {
    if (confirm('Cette action supprimera TOUTES les donn√©es. √ätes-vous vraiment s√ªr ?')) {
        // Conserver le th√®me pr√©f√©r√©
        const preferredTheme = localStorage.getItem('preferredTheme') || 'dark';
        
        appData = {
            users: {
                'commun': {
                    name: 'Commun',
                    incomes: [],
                    expenses: []
                }
            },
            commonExpenses: [],
            currentTab: 'dashboard',
            theme: preferredTheme // Utiliser le th√®me pr√©f√©r√©
        };
        saveData();
        renderApp();
        location.reload(); // Recharger la page pour r√©initialiser compl√®tement
        closeModal('settingsModal');
    }
};
        showConfirm('Voulez-vous vraiment r√©initialiser toutes les donn√©es ?');
    }

    // Gestion des modals avec historique
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        // Emp√™cher le scroll du body
        document.body.style.overflow = 'hidden';
        // Ajouter un √©tat √† l'historique pour g√©rer le bouton retour
        history.pushState({ modal: modalId }, '');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        // R√©activer le scroll du body
        document.body.style.overflow = '';
        // Si on ferme manuellement, on recule dans l'historique
        if (history.state && history.state.modal === modalId) {
            history.back();
        }
    }

    function showConfirm(message) {
        const confirmMessageElement = document.getElementById('confirmMessage');
        if (confirmMessageElement) {
            confirmMessageElement.textContent = message;
            document.getElementById('confirmButton').onclick = () => {
                if (confirmCallback) confirmCallback();
                closeModal('confirmModal');
            };
            openModal('confirmModal');
        } else {
            // Fallback si l'√©l√©ment n'existe pas
            if (confirm(message) && confirmCallback) {
                confirmCallback();
            }
        }
    }

    // Gestion du bouton retour sur Android
    window.addEventListener('popstate', (e) => {
        const activeModal = document.querySelector('.modal.active');
        if (activeModal) {
            activeModal.classList.remove('active');
            document.body.style.overflow = '';
        }
    });

    // Statistiques
    function showStats() {
        const statsContent = document.getElementById('statsContent');
        
        // Calculer les statistiques globales
        let totalRevenue = 0;
        let totalExpenses = 0;
        let userStats = [];
        
        // Statistiques par utilisateur
        for (const userId in appData.users) {
            const user = appData.users[userId];
            const userRevenue = user.incomes.reduce((sum, item) => sum + item.amount, 0);
            const userExpenses = user.expenses.reduce((sum, item) => sum + item.amount, 0);
            
            // Part des d√©penses communes
            let commonShare = 0;
            if (userId !== 'commun') {
                appData.commonExpenses.forEach(expense => {
                    if (expense.participants.includes(userId)) {
                        commonShare += expense.amount / expense.participants.length;
                    }
                });
            }
            
            userStats.push({
                name: user.name,
                revenue: userRevenue,
                expenses: userExpenses + commonShare,
                balance: userRevenue - userExpenses - commonShare
            });
            
            totalRevenue += userRevenue;
            totalExpenses += userExpenses + (userId === 'commun' ? 0 : commonShare);
        }
        
        // Total des d√©penses communes
        const totalCommonExpenses = appData.commonExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        
        // G√©n√©rer le HTML
        statsContent.innerHTML = `
            <div style="background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem;">Vue d'ensemble</h3>
                <div style="display: grid; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total des revenus :</span>
                        <span style="color: var(--success); font-weight: bold;">+${totalRevenue.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>Total des d√©penses :</span>
                        <span style="color: var(--danger); font-weight: bold;">-${totalExpenses.toFixed(2)}‚Ç¨</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>D√©penses communes :</span>
                        <span style="color: var(--warning); font-weight: bold;">${totalCommonExpenses.toFixed(2)}‚Ç¨</span>
                    </div>
                    <hr style="border-color: var(--border);">
                    <div style="display: flex; justify-content: space-between;">
                        <span>Solde global :</span>
                        <span style="color: var(--primary); font-weight: bold; font-size: 1.25rem;">${(totalRevenue - totalExpenses).toFixed(2)}‚Ç¨</span>
                    </div>
                </div>
            </div>
            
            <div style="background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem;">Par utilisateur</h3>
                <div style="display: grid; gap: 0.75rem;">
                    ${userStats.map(user => `
                        <div style="padding: 0.5rem; background-color: var(--bg-primary); border-radius: 6px;">
                            <strong>${user.name}</strong>
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.25rem; margin-top: 0.5rem; font-size: 0.875rem;">
                                <span>Revenus :</span>
                                <span style="color: var(--success);">+${user.revenue.toFixed(2)}‚Ç¨</span>
                                <span>D√©penses :</span>
                                <span style="color: var(--danger);">-${user.expenses.toFixed(2)}‚Ç¨</span>
                                <span>Solde :</span>
                                <span style="color: var(--primary); font-weight: bold;">${user.balance.toFixed(2)}‚Ç¨</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="background-color: var(--bg-secondary); padding: 1rem; border-radius: 8px;">
                <h3 style="margin-bottom: 1rem;">Informations</h3>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                    <p>Nombre d'utilisateurs : ${Object.keys(appData.users).length - 1}</p>
                    <p>Nombre de d√©penses communes : ${appData.commonExpenses.length}</p>
                    <p>Derni√®re sauvegarde : ${new Date().toLocaleString('fr-FR')}</p>
                </div>
            </div>
        `;
        
        openModal('statsModal');
    }

// Mettre √† jour le texte du bouton PIN dans les param√®tres
    function updatePinButtonText() {
        const btn = document.getElementById('pinButtonText');
        if (btn) {
            // Assurez-vous que appData.security existe avant d'essayer d'y acc√©der
            btn.textContent = (appData.security && appData.security.pinEnabled) ? 
                'D√©sactiver le code PIN' : 'Activer le code PIN';
        }
    }
	
// PWA et installation am√©lior√©e
function initPWA() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js')
            .then(registration => {
                console.log('Service Worker enregistr√© avec succ√®s:', registration);
                
                // V√©rifier les mises √† jour
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            // Nouveau service worker disponible
                            if (confirm('Une nouvelle version est disponible ! Voulez-vous mettre √† jour ?')) {
                                newWorker.postMessage({ type: 'SKIP_WAITING' });
                                window.location.reload();
                            }
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Erreur Service Worker:', error);
            });
    }
    
    // D√©tection de l'installation PWA
    let deferredPrompt;
    const installBtn = document.getElementById('installAppBtn');
    
    // V√©rifier si l'app n'est pas d√©j√† install√©e
    const isInstalled = window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone || 
                       document.referrer.includes('android-app://');
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        console.log('Installation disponible');
        
        // Afficher le bouton d'installation dans les param√®tres
        if (installBtn) {
            installBtn.style.display = 'flex';
        }
        
        // Ajouter un bouton d'installation dans le header
        addInstallButtonToHeader();
        
        // V√©rifier si l'utilisateur a d√©j√† refus√© r√©cemment
        const lastDeclined = localStorage.getItem('installDeclined');
        const hoursSinceDeclined = lastDeclined ? 
            (Date.now() - parseInt(lastDeclined)) / (1000 * 60 * 60) : 999;
        
        // Montrer la banni√®re imm√©diatement si :
        // - L'utilisateur n'a jamais refus√©
        // - Ou il a refus√© il y a plus de 24 heures
        if (!lastDeclined || hoursSinceDeclined > 24) {
            // Attendre 2 secondes pour que la page soit bien charg√©e
            setTimeout(() => {
                if (deferredPrompt) {
                    showInstallBanner();
                }
            }, 2000);
        }
    });
    
    // Gestionnaire d'installation
    window.installApp = async () => {
        if (!deferredPrompt) {
            // Si pas de prompt, essayer de montrer des instructions personnalis√©es
            showManualInstallInstructions();
            return;
        }
        
        hideInstallBanner();
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
            console.log('Installation accept√©e');
            removeInstallButton();
            if (installBtn) {
                installBtn.style.display = 'none';
            }
            // Montrer un message de succ√®s
            showSuccessMessage('Application install√©e avec succ√®s ! üéâ');
            // Marquer comme install√©e
            localStorage.setItem('pwaInstalled', 'true');
        } else {
            // Enregistrer le refus avec timestamp
            localStorage.setItem('installDeclined', Date.now());
        }
        
        deferredPrompt = null;
    };
    
    // D√©tecter si l'app est install√©e
    window.addEventListener('appinstalled', () => {
        console.log('PWA install√©e avec succ√®s');
        hideInstallBanner();
        removeInstallButton();
        if (installBtn) {
            installBtn.style.display = 'none';
        }
        localStorage.setItem('pwaInstalled', 'true');
    });
    
    // V√©rifier si on est en mode standalone
    if (isInstalled) {
        console.log('App lanc√©e en mode standalone');
        localStorage.setItem('pwaInstalled', 'true');
    }
}

// Ajouter un bouton d'installation dans le header
function addInstallButtonToHeader() {
    // V√©rifier si le bouton existe d√©j√†
    if (document.getElementById('headerInstallBtn')) return;
    
    const headerButtons = document.querySelector('.header-buttons');
    if (!headerButtons) return;
    
    const installButton = document.createElement('button');
    installButton.id = 'headerInstallBtn';
    installButton.className = 'btn-icon install-pulse';
    installButton.onclick = installApp;
    installButton.title = 'Installer l\'application';
    installButton.innerHTML = '<span class="material-icons">install_mobile</span>';
    
    // Ajouter le bouton au d√©but des boutons du header
    headerButtons.insertBefore(installButton, headerButtons.firstChild);
}

// Retirer le bouton d'installation
function removeInstallButton() {
    const btn = document.getElementById('headerInstallBtn');
    if (btn) btn.remove();
}

// Banni√®re d'installation am√©lior√©e
function showInstallBanner() {
    const existingBanner = document.getElementById('installBanner');
    if (existingBanner) return;
    
    const banner = document.createElement('div');
    banner.id = 'installBanner';
    banner.innerHTML = `
        <div style="
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(37, 99, 235, 0.4);
            display: flex;
            align-items: center;
            gap: 1.25rem;
            z-index: 1000;
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: min(calc(100vw - 2rem), 500px);
            width: 100%;
        ">
            <div style="
                background: rgba(255, 255, 255, 0.2);
                border-radius: 16px;
                padding: 1rem;
                backdrop-filter: blur(10px);
                border: 2px solid rgba(255, 255, 255, 0.3);
            ">
                <span class="material-icons" style="font-size: 2.5rem; display: block;">install_mobile</span>
            </div>
            <div style="flex: 1;">
                <strong style="display: block; margin-bottom: 0.375rem; font-size: 1.25rem;">Installer l'application</strong>
                <span style="font-size: 0.9375rem; opacity: 0.95; line-height: 1.4;">Ajoutez l'app √† votre √©cran d'accueil pour un acc√®s rapide et hors ligne ‚ö°</span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: stretch; min-width: 100px;">
                <button onclick="installApp()" style="
                    background: white;
                    color: #2563eb;
                    border: none;
                    padding: 0.75rem 1.5rem;
                    border-radius: 12px;
                    font-weight: 700;
                    cursor: pointer;
                    font-size: 1rem;
                    transition: all 0.2s;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    white-space: nowrap;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.15)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'">Installer</button>
                <button onclick="dismissInstallBanner()" style="
                    background: transparent;
                    color: rgba(255,255,255,0.9);
                    border: none;
                    padding: 0.5rem;
                    cursor: pointer;
                    font-size: 0.875rem;
                    transition: opacity 0.2s;
                    text-decoration: underline;
                " onmouseover="this.style.opacity='0.7'" onmouseout="this.style.opacity='1'">Non merci</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(banner);
}

// Fonction pour masquer la banni√®re avec possibilit√© de la r√©afficher plus tard
function dismissInstallBanner() {
    hideInstallBanner();
    // Enregistrer un refus "l√©ger" (24h avant de re-proposer)
    localStorage.setItem('installDeclined', Date.now());
}

function hideInstallBanner() {
    const banner = document.getElementById('installBanner');
    if (banner) {
        banner.style.animation = 'bounceOut 0.4s ease-in';
        setTimeout(() => banner.remove(), 400);
    }
}

// Instructions manuelles pour les navigateurs non support√©s
function showManualInstallInstructions() {
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isAndroid = /Android/.test(navigator.userAgent);
    
    let instructions = '';
    
    if (isIOS) {
        instructions = `
            <h3>üì± Installation sur iOS</h3>
            <ol style="text-align: left; margin: 1rem 0;">
                <li>Appuyez sur le bouton <strong>Partager</strong> <span style="font-size: 1.2rem;">‚¨ÜÔ∏è</span></li>
                <li>Faites d√©filer et appuyez sur <strong>"Sur l'√©cran d'accueil"</strong></li>
                <li>Appuyez sur <strong>"Ajouter"</strong></li>
            </ol>
        `;
    } else if (isAndroid) {
        instructions = `
            <h3>üì± Installation sur Android</h3>
            <p>Essayez d'utiliser Chrome ou Edge pour installer cette application.</p>
            <ol style="text-align: left; margin: 1rem 0;">
                <li>Ouvrez le menu du navigateur (3 points)</li>
                <li>Appuyez sur <strong>"Installer l'application"</strong></li>
            </ol>
        `;
    } else {
        instructions = `
            <h3>üíª Installation sur ordinateur</h3>
            <p>Cette application peut √™tre install√©e depuis Chrome, Edge ou Brave.</p>
            <p>Cherchez l'ic√¥ne d'installation dans la barre d'adresse.</p>
        `;
    }
    
    const modal = document.createElement('div');
    modal.innerHTML = `
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 1rem;
        " onclick="if(event.target === this) this.remove()">
            <div style="
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 2rem;
                border-radius: 20px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            ">
                ${instructions}
                <button onclick="this.closest('div').parentElement.remove()" style="
                    margin-top: 1rem;
                    background: var(--primary);
                    color: white;
                    border: none;
                    padding: 0.75rem 2rem;
                    border-radius: 10px;
                    font-weight: 600;
                    cursor: pointer;
                ">Compris</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Message de succ√®s
function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 1rem 2rem;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        z-index: 10000;
        animation: slideInDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        font-weight: 600;
        font-size: 1.125rem;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutUp 0.4s ease-in';
        setTimeout(() => toast.remove(), 400);
    }, 3000);
}
	</script>
	<!-- Popup de donation -->
	<div id="donationPopup" class="donation-overlay" style="display: none;">
    <div class="donation-popup">
        <span class="donation-close" onclick="closeDonationPopup()">√ó</span>
        <h3>üíñ Soutenez ce projet</h3>
        <p>Cette application est 100% gratuite et sans publicit√©.<br>
        Si elle vous est utile, un petit don nous aide √† continuer ! üôè</p>
        <a href="https://www.buymeacoffee.com/actuetmedia" target="_blank" class="donation-link">
    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">coffee</span>
    M'offrir un caf√© ‚òï
	</a>
        <p style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.7;">
            Merci de votre soutien ! ‚ù§Ô∏è
        </p>
    </div>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="js/pdf-export.js"></script>
	<script src="js/security.js"></script>
	<!-- Modal de s√©curit√© PIN -->
	<div class="modal" id="pinModal">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <span class="material-icons" style="margin-right: 0.5rem;">lock</span>
            <span id="pinTitle">Entrez votre code PIN</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div id="pinDisplay" style="font-size: 2rem; letter-spacing: 1rem; margin: 1rem 0;">
                ‚óã‚óã‚óã‚óã
            </div>
            <div id="pinError" style="color: var(--danger); font-size: 0.875rem; margin-bottom: 1rem; display: none;"></div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 200px; margin: 0 auto;">
                <button class="pin-btn" onclick="addPinDigit(1)">1</button>
                <button class="pin-btn" onclick="addPinDigit(2)">2</button>
                <button class="pin-btn" onclick="addPinDigit(3)">3</button>
                <button class="pin-btn" onclick="addPinDigit(4)">4</button>
                <button class="pin-btn" onclick="addPinDigit(5)">5</button>
                <button class="pin-btn" onclick="addPinDigit(6)">6</button>
                <button class="pin-btn" onclick="addPinDigit(7)">7</button>
                <button class="pin-btn" onclick="addPinDigit(8)">8</button>
                <button class="pin-btn" onclick="addPinDigit(9)">9</button>
                <button class="pin-btn" onclick="clearPin()">C</button>
                <button class="pin-btn" onclick="addPinDigit(0)">0</button>
                <button class="pin-btn" onclick="submitPin()">‚úì</button>
            </div>
        </div>
    </div>
</div>
<!-- Scripts iOS -->
<script src="js/ios-fixes.js"></script>
<script src="js/ios-install.js"></script>
</body>
</html>