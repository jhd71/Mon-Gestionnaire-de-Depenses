<!DOCTYPE html>
<html lang="fr">
<head>
<script>
    // Appliquer le thÃ¨me immÃ©diatement
    (function() {
        const savedTheme = localStorage.getItem('preferredTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    })();
    
    // ============================================
    // WATCHDOG ANTI-FREEZE PWA v5 (cold start fix)
    // ============================================
    (function() {
        var TIMEOUT = 2000;
        var MAX_RELOADS = 2;
        var reloadCount = parseInt(sessionStorage.getItem('pwaReloadCount') || '0');
        
        window.pwaLoading = true;
        
        var watchdogTimer = setTimeout(function() {
            if (typeof window.initializeApp !== 'function') {
                console.warn('[PWA-FIX] JS non chargÃ© aprÃ¨s ' + TIMEOUT + 'ms !');
                
                if (reloadCount < MAX_RELOADS) {
                    console.warn('[PWA-FIX] Reload #' + (reloadCount + 1));
                    sessionStorage.setItem('pwaReloadCount', String(reloadCount + 1));
                    window.location.reload(true);
                } else {
                    console.error('[PWA-FIX] Ã‰chec aprÃ¨s ' + MAX_RELOADS + ' reloads');
                    sessionStorage.removeItem('pwaReloadCount');
                    showError();
                }
            } else {
                sessionStorage.removeItem('pwaReloadCount');
                window.pwaLoading = false;
                hideLoader();
            }
        }, TIMEOUT);
        
        window.addEventListener('beforeunload', function() {
            clearTimeout(watchdogTimer);
        });
        
        window.hidePwaLoader = hideLoader;
        
        function hideLoader() {
            var loader = document.getElementById('pwa-loader');
            var app = document.getElementById('pwa-app');
            if (loader) loader.style.display = 'none';
            if (app) app.style.visibility = 'visible';
        }
        
        function showError() {
            var loader = document.getElementById('pwa-loader');
            if (loader) {
                loader.innerHTML = '<div style="font-size:3rem;margin-bottom:1rem">âš ï¸</div><div style="color:white;font-size:1.1rem;margin-bottom:1.5rem">ProblÃ¨me de chargement</div><button onclick="sessionStorage.clear();caches.keys().then(function(n){n.forEach(function(c){caches.delete(c)})});setTimeout(function(){location.reload(true)},300)" style="background:#8b5cf6;color:white;border:none;padding:14px 28px;border-radius:10px;font-size:1rem;cursor:pointer">ğŸ”„ Vider le cache</button>';
            }
        }
    })();
</script>
<style>
    #pwa-loader {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: var(--bg, #1f2937);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 999999;
        font-family: system-ui, -apple-system, sans-serif;
    }
    #pwa-loader .spinner {
        font-size: 3.5rem;
        animation: pulse 1.2s ease-in-out infinite;
    }
    #pwa-loader .text {
        color: white;
        font-size: 1.1rem;
        margin-top: 1rem;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.15); opacity: 0.8; }
    }
    #pwa-app {
        visibility: hidden;
    }
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestionnaire de DÃ©penses</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="theme-color" content="#221e33">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="./images/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./images/icon-180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./images/icon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./images/icon-16.png">
    <meta name="msapplication-TileColor" content="#2563eb">
    <meta name="msapplication-TileImage" content="./images/icon-144.png">
</head>
<body>
    <!-- Ã‰cran de chargement PWA -->
    <div id="pwa-loader">
        <div class="spinner">ğŸ’°</div>
        <div class="text">Chargement...</div>
    </div>

    <!-- App -->
    <div id="pwa-app">
    <div class="header">
    <div class="header-title">
        <h1><span class="material-icons header-icon">savings</span> Gestionnaire de DÃ©penses</h1>
    </div>
    <div class="header-buttons">
        <button class="btn-icon" onclick="openShareModal()" title="Partager">
            <span class="material-icons">share</span>
        </button>
        <button class="btn-icon" onclick="showStats()" title="Statistiques">
            <span class="material-icons">insights</span>
        </button>
        <button class="btn-icon" onclick="toggleCalculator()" title="Calculatrice">
            <span class="material-icons">calculate</span>
        </button>
        <button class="btn-icon" onclick="toggleTheme()" title="Changer le thÃ¨me">
            <span class="material-icons">brightness_6</span>
        </button>
        <button class="btn-icon" onclick="openSettings()" title="ParamÃ¨tres">
            <span class="material-icons">settings</span>
        </button>
    </div>
</div>

    <div class="tabs" id="tabs">
        <button class="tab active" onclick="switchTab('dashboard')">Tableau de bord</button>
        <button class="tab" onclick="switchTab('commun')">Commun</button>
        <button class="add-tab" onclick="addNewTab()">+</button>
    </div>

    <div class="content">
        <!-- Tableau de bord -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard" id="dashboard-content">
                <!-- Les cartes utilisateurs seront gÃ©nÃ©rÃ©es ici -->
            </div>
        </div>

        <!-- Onglet Commun -->
        <div id="commun" class="tab-content">
            <!-- Section Balance : Qui doit combien Ã  qui -->
            <div class="section balance-section">
                <div class="section-header">
                    <h2 class="section-title">âš–ï¸ Balance : Qui doit quoi ?</h2>
                    <button class="btn btn-small" onclick="openShareModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        <span class="material-icons" style="font-size: 1rem;">share</span>
                        Partager
                    </button>
                </div>
                <div id="balance-content" class="items-list">
                    <div class="empty-state">Ajoutez des utilisateurs et des transactions pour voir la balance</div>
                </div>
            </div>

            <!-- Section Virements -->
            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ’¸ Virements entre personnes</h2>
                    <button class="btn btn-small" onclick="addTransfer()">+ Ajouter</button>
                </div>
                <div id="transfers-list" class="items-list">
                    <div class="empty-state">Aucun virement ajoutÃ©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Revenus communs</h2>
                    <button class="btn btn-small" onclick="addIncome('commun')">+ Ajouter</button>
                </div>
                <div id="commun-incomes" class="items-list">
                    <div class="empty-state">Aucun revenu ajoutÃ©</div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">DÃ©penses communes</h2>
                    <button class="btn btn-small" onclick="addCommonExpense()">+ Ajouter</button>
                </div>
                <div id="commun-expenses" class="items-list">
                    <div class="empty-state">Aucune dÃ©pense ajoutÃ©e</div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAB menu pour actions rapides -->
    <button class="fab" id="fabButton" onclick="toggleFabMenu()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>
    
    <div class="fab-menu" id="fabMenu">
        <button class="fab-item" onclick="quickAddIncome()">
            <span class="fab-label">ğŸ’µ Ajouter un revenu</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
            </div>
        </button>
        <button class="fab-item" onclick="quickAddExpense()">
            <span class="fab-label">ğŸ›’ Ajouter une dÃ©pense</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M5 12h14"/>
                </svg>
            </div>
        </button>
        <button class="fab-item" onclick="toggleCalculator()">
            <span class="fab-label">ğŸ§® Calculatrice</span>
            <div class="fab-item-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <rect x="4" y="2" width="16" height="20" rx="2"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                    <circle cx="8" cy="12" r="1" fill="white"/>
                    <circle cx="12" cy="12" r="1" fill="white"/>
                    <circle cx="16" cy="12" r="1" fill="white"/>
                    <circle cx="8" cy="16" r="1" fill="white"/>
                    <circle cx="12" cy="16" r="1" fill="white"/>
                    <circle cx="16" cy="16" r="1" fill="white"/>
                </svg>
            </div>
        </button>
    </div>

    <!-- Modal pour ajouter un onglet -->
    <div class="modal" id="addTabModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un utilisateur</div>
            <div class="modal-body">
                <input type="text" class="input" id="newTabName" placeholder="Nom de l'utilisateur" style="margin-bottom: 1rem;">
                
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-primary);">Choisir un avatar :</label>
                <div id="avatarPreview" style="text-align: center; margin-bottom: 1rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 12px;">
                    <span id="avatarPreviewEmoji" style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                
                <!-- Grille d'avatars en dur dans le HTML -->
                <div id="avatarGrid" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; padding: 12px; background: var(--bg-tertiary); border-radius: 12px; max-height: 200px; overflow-y: auto;">
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¤')">ğŸ‘¤</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©')">ğŸ‘©</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨')">ğŸ‘¨</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘§')">ğŸ‘§</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¦')">ğŸ‘¦</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§‘')">ğŸ§‘</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦°')">ğŸ‘©â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦°')">ğŸ‘¨â€ğŸ¦°</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦±')">ğŸ‘©â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦±')">ğŸ‘¨â€ğŸ¦±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘©â€ğŸ¦³')">ğŸ‘©â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¨â€ğŸ¦³')">ğŸ‘¨â€ğŸ¦³</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§”')">ğŸ§”</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘´')">ğŸ‘´</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘µ')">ğŸ‘µ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ§’')">ğŸ§’</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ‘¶')">ğŸ‘¶</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ±')">ğŸ±</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¶')">ğŸ¶</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¦Š')">ğŸ¦Š</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ»')">ğŸ»</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¼')">ğŸ¼</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¦')">ğŸ¦</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¸')">ğŸ¸</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸŒŸ')">ğŸŒŸ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ’')">ğŸ’</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ”¥')">ğŸ”¥</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('âš¡')">âš¡</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸŒˆ')">ğŸŒˆ</button>
                    <button type="button" class="avatar-btn" onclick="selectAvatar('ğŸ¯')">ğŸ¯</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTabModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTab()">Ajouter</button>
            </div>
        </div>
    </div>

<!-- Modal pour modifier l'avatar d'un utilisateur -->
    <div class="modal" id="changeAvatarModal">
        <div class="modal-content">
            <div class="modal-header">Modifier l'avatar</div>
            <div class="modal-body">
                <input type="hidden" id="changeAvatarUserId">
                <div class="avatar-preview" id="changeAvatarPreview" style="text-align: center; margin-bottom: 1rem;">
                    <span style="font-size: 3rem;">ğŸ‘¤</span>
                </div>
                <div class="avatar-grid" id="changeAvatarGrid">
                    <!-- Les avatars seront gÃ©nÃ©rÃ©s par JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('changeAvatarModal')">Annuler</button>
                <button class="btn" onclick="confirmChangeAvatar()">Enregistrer</button>
            </div>
        </div>
    </div>
	
    <!-- Modal pour ajouter un revenu -->
    <div class="modal" id="addIncomeModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter un revenu</div>
            <div class="modal-body">
                <input type="text" class="input" id="incomeName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="incomeAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addIncomeModal')">Annuler</button>
                <button class="btn" onclick="confirmAddIncome()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une dÃ©pense -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">Ajouter une dÃ©pense</div>
            <div class="modal-body">
                <input type="text" class="input" id="expenseName" placeholder="Description" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="expenseAmount" placeholder="Montant" step="0.01">
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddExpense()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal pour ajouter une dÃ©pense commune -->
    <div class="modal" id="addCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ›’ Nouvelle dÃ©pense commune</div>
            <div class="modal-body">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="selectedIconBtn" onclick="toggleIconPicker()">
                            <span id="selectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="commonExpenseName" placeholder="Ex: Courses Leclerc" style="flex: 1;">
                    </div>
                    <input type="hidden" id="commonExpenseIcon" value="ğŸ›’">
                </div>
                
                <!-- SÃ©lecteur d'icÃ´nes -->
                <div id="iconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="iconPickerGrid">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Montant (â‚¬)</label>
                    <input type="number" class="input" id="commonExpenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="commonExpensePaidBy">
                        <!-- Rempli dynamiquement -->
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ‘¥ Participants (qui partage cette dÃ©pense)</label>
                    <div id="participantsList" class="participants">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmAddCommonExpense()">Ajouter</button>
            </div>
        </div>
    </div>

<!-- Modal pour modifier une dÃ©pense commune -->
    <div class="modal" id="editCommonExpenseModal">
        <div class="modal-content">
            <div class="modal-header">âœï¸ Modifier la dÃ©pense</div>
            <div class="modal-body">
                <input type="hidden" id="editExpenseIndex">
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Description</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <button type="button" class="icon-selector-btn" id="editSelectedIconBtn" onclick="toggleEditIconPicker()">
                            <span id="editSelectedIconDisplay">ğŸ›’</span>
                        </button>
                        <input type="text" class="input" id="editCommonExpenseName" placeholder="Ex: Courses Leclerc" style="flex: 1;">
                    </div>
                    <input type="hidden" id="editCommonExpenseIcon" value="ğŸ›’">
                </div>
                
                <!-- SÃ©lecteur d'icÃ´nes pour modification -->
                <div id="editIconPickerContainer" class="icon-picker-container" style="display: none;">
                    <div class="icon-picker-grid" id="editIconPickerGrid">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">Montant (â‚¬)</label>
                    <input type="number" class="input" id="editCommonExpenseAmount" placeholder="0.00" step="0.01">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ’³ PayÃ© par</label>
                    <select class="input" id="editCommonExpensePaidBy">
                        <!-- Rempli dynamiquement -->
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">ğŸ‘¥ Participants</label>
                    <div id="editParticipantsList" class="participants">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('editCommonExpenseModal')">Annuler</button>
                <button class="btn" onclick="confirmEditCommonExpense()">ğŸ’¾ Enregistrer</button>
            </div>
        </div>
    </div>
	
<!-- Modal de partage -->
    <div class="modal" id="shareModal">
        <div class="modal-content" style="max-width: 420px;">
            <div class="modal-header">ğŸ”— Partager ce groupe</div>
            <div class="modal-body">
                
                <!-- Section 1 : Code du groupe -->
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.875rem;">
                        Votre code de groupe unique
                    </p>
                    <div class="share-code" id="shareCode">XXXXX</div>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-small" onclick="copyShareCode()">
                            <span class="material-icons" style="font-size: 1rem;">content_copy</span>
                            Copier le code
                        </button>
                        <button class="btn btn-small btn-success" onclick="copyShareLink()">
                            <span class="material-icons" style="font-size: 1rem;">link</span>
                            Copier le lien
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.75rem;">
                        ğŸ’¡ Le lien permet d'importer directement les donnÃ©es
                    </p>
                </div>
                
                <!-- Section 2 : Rejoindre un groupe -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1rem;">
                    <h4 style="margin-bottom: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ“¥</span> Rejoindre un groupe
                    </h4>
                    <input type="text" class="input" id="joinCode" placeholder="Entrez le code du groupe" style="text-transform: uppercase; letter-spacing: 0.1em; text-align: center; margin-bottom: 0.75rem;">
                    <button class="btn" onclick="joinGroup()" style="width: 100%;">
                        <span class="material-icons">group_add</span>
                        Rejoindre
                    </button>
                </div>
                
                <!-- Section 3 : Export/Import fichier -->
                <div style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 0.5rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ’¾</span> Sauvegarde fichier
                    </h4>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 1rem;">
                        Exportez vos donnÃ©es dans un fichier ou importez depuis un fichier
                    </p>
                    <div style="display: flex; gap: 0.75rem;">
                        <button class="btn btn-outline" onclick="exportToFile()" style="flex: 1;">
                            <span class="material-icons">download</span>
                            TÃ©lÃ©charger
                        </button>
                        <button class="btn btn-outline" onclick="importFromFile()" style="flex: 1;">
                            <span class="material-icons">upload</span>
                            Importer
                        </button>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('shareModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>
	
    <!-- Modal pour ajouter un virement -->
    <div class="modal" id="addTransferModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ’¸ Ajouter un virement</div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.875rem;">
                    Un virement reprÃ©sente de l'argent qu'une personne a sur son compte mais qui appartient Ã  quelqu'un d'autre.
                </p>
                <input type="text" class="input" id="transferDescription" placeholder="Description (ex: Salaire avancÃ©)" style="margin-bottom: 0.75rem;">
                <input type="number" class="input" id="transferAmount" placeholder="Montant" step="0.01" style="margin-bottom: 0.75rem;">
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">De :</label>
                    <select class="input" id="transferFrom" style="margin-bottom: 0.75rem;">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </select>
                </div>
                <div style="margin-top: 0.5rem;">
                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Vers (Ã  qui appartient l'argent) :</label>
                    <select class="input" id="transferTo">
                        <!-- GÃ©nÃ©rÃ© dynamiquement -->
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal('addTransferModal')">Annuler</button>
                <button class="btn" onclick="confirmAddTransfer()">Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Modal calculatrice -->
    <div class="modal" id="calculatorModal">
        <div class="modal-content">
            <div class="modal-header">Calculatrice</div>
            <div class="modal-body">
                <div class="calculator">
                    <div class="calc-display" id="calcDisplay">0</div>
                    <div class="calc-buttons">
                        <button class="calc-btn" onclick="clearCalc()">C</button>
                        <button class="calc-btn" onclick="appendToCalc('/')">/</button>
                        <button class="calc-btn" onclick="appendToCalc('*')">Ã—</button>
                        <button class="calc-btn" onclick="deleteLastCalc()">â†</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('7')">7</button>
                        <button class="calc-btn" onclick="appendToCalc('8')">8</button>
                        <button class="calc-btn" onclick="appendToCalc('9')">9</button>
                        <button class="calc-btn operator" onclick="appendToCalc('-')">-</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('4')">4</button>
                        <button class="calc-btn" onclick="appendToCalc('5')">5</button>
                        <button class="calc-btn" onclick="appendToCalc('6')">6</button>
                        <button class="calc-btn operator" onclick="appendToCalc('+')">+</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('1')">1</button>
                        <button class="calc-btn" onclick="appendToCalc('2')">2</button>
                        <button class="calc-btn" onclick="appendToCalc('3')">3</button>
                        <button class="calc-btn" onclick="appendToCalc('.')">.</button>
                        
                        <button class="calc-btn" onclick="appendToCalc('0')">0</button>
                        <button class="calc-btn equal" onclick="calculateResult()">=</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('calculatorModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal paramÃ¨tres -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">ParamÃ¨tres</div>
            <div class="modal-body">
    <div style="display: grid; gap: 1rem;">
        <!-- Bouton d'installation (visible seulement si non installÃ©) -->
        <button class="btn" id="installAppBtn" style="background-color: #2563eb; display: none;" onclick="installApp()">
            <span class="material-icons">install_mobile</span>
            Installer l'application
        </button>
		<button class="btn" onclick="togglePinSecurity()">
			<span class="material-icons">lock</span>
			<span id="pinButtonText">Activer le code PIN</span>
		</button>
        <button class="btn" onclick="exportData()">
            <span class="material-icons">download</span>
            Exporter les donnÃ©es
        </button>
		<button class="btn" onclick="exportToPDF()">
            <span class="material-icons">picture_as_pdf</span>
            Exporter en PDF
        </button>
        <button class="btn" onclick="importData()">
            <span class="material-icons">upload</span>
            Importer des donnÃ©es
        </button>
        <button class="btn" style="background-color: #e11d48;" onclick="showDonationPopup()">
            <span class="material-icons">favorite</span>
            Soutenir ce projet gratuit
        </button>
        <button class="btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="clearCacheAndReload()">
            <span class="material-icons">cached</span>
            Vider le cache (mise Ã  jour)
        </button>
        <button class="btn btn-danger" onclick="confirmReset()">
            <span class="material-icons">delete_forever</span>
            RÃ©initialiser tout
        </button>
        <button class="btn" onclick="showAbout()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
            <span class="material-icons">info</span>
            Ã€ propos
        </button>
    </div>
</div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('settingsModal')">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Modal statistiques -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">insights</span>
                Statistiques
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Filtres pÃ©riode -->
                <div style="display: flex; background: var(--bg-tertiary); border-radius: 12px; margin: 1rem; overflow: hidden;">
                    <button class="stats-period-btn active" onclick="setStatsPeriod('month')" id="periodMonth">Mois</button>
                    <button class="stats-period-btn" onclick="setStatsPeriod('year')" id="periodYear">AnnÃ©e</button>
                    <button class="stats-period-btn" onclick="setStatsPeriod('all')" id="periodAll">Tous</button>
                </div>
                
                <!-- Navigation mois/annÃ©e -->
                <div id="statsNavigation" style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <button onclick="navigateStats(-1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <span id="statsPeriodLabel" style="font-weight: 600; min-width: 150px; text-align: center;">dÃ©cembre 2025</span>
                    <button onclick="navigateStats(1)" style="background: var(--bg-tertiary); border: none; color: var(--text-primary); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
                
                <!-- Graphique et total -->
                <div style="background: var(--bg-secondary); border-radius: 16px; margin: 0 1rem 1rem; padding: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <!-- Graphique camembert -->
                        <div id="pieChartContainer" style="width: 150px; height: 150px; flex-shrink: 0;">
                            <svg id="pieChart" viewBox="0 0 100 100" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                                <!-- GÃ©nÃ©rÃ© dynamiquement -->
                            </svg>
                        </div>
                        <!-- LÃ©gende -->
                        <div style="flex: 1;">
                            <div id="statsTotal" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem; color: var(--primary);">Total: 0 â‚¬</div>
                            <div id="statsLegend" style="display: flex; flex-direction: column; gap: 0.375rem; font-size: 0.875rem;">
                                <!-- GÃ©nÃ©rÃ© dynamiquement -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtre groupe/utilisateur -->
                <div style="margin: 0 1rem 1rem;">
                    <select class="input" id="statsUserFilter" onchange="updateStats()" style="padding: 0.75rem 1rem;">
                        <option value="all">Pour le groupe</option>
                        <!-- Options gÃ©nÃ©rÃ©es dynamiquement -->
                    </select>
                </div>
                
                <!-- Liste des dÃ©penses par catÃ©gorie -->
                <div id="statsCategoryList" style="margin: 0 1rem 1rem;">
                    <!-- GÃ©nÃ©rÃ© dynamiquement -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('statsModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

	<!-- Popup de donation -->
	<div id="donationPopup" class="donation-overlay" style="display: none;">
    <div class="donation-popup">
        <span class="donation-close" onclick="closeDonationPopup()">Ã—</span>
        <h3>ğŸ’– Soutenez ce projet</h3>
        <p>Cette application est 100% gratuite et sans publicitÃ©.<br>
        Si elle vous est utile, un petit don nous aide Ã  continuer ! ğŸ™</p>
        <a href="https://fr.tipeee.com/actuetmedia" target="_blank" class="donation-link">
    <span class="material-icons" style="vertical-align: middle; margin-right: 8px;">favorite</span>
    Me soutenir sur Tipeee ğŸ’–
	</a>
        <p style="margin-top: 1rem; font-size: 0.875rem; opacity: 0.7;">
            Merci de votre soutien ! â¤ï¸
        </p>
    </div>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
	<script src="js/pdf-export.js"></script>
	<script src="js/security.js"></script>
	<!-- Modal de sÃ©curitÃ© PIN -->
	<div class="modal" id="pinModal">
    <div class="modal-content" style="max-width: 350px;">
        <div class="modal-header">
            <span class="material-icons" style="margin-right: 0.5rem;">lock</span>
            <span id="pinTitle">Entrez votre code PIN</span>
        </div>
        <div class="modal-body" style="text-align: center;">
            <div id="pinDisplay" style="font-size: 2rem; letter-spacing: 1rem; margin: 1rem 0;">
                â—‹â—‹â—‹â—‹
            </div>
            <div id="pinError" style="color: var(--danger); font-size: 0.875rem; margin-bottom: 1rem; display: none;"></div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; max-width: 200px; margin: 0 auto;">
                <button class="pin-btn" onclick="addPinDigit(1)">1</button>
                <button class="pin-btn" onclick="addPinDigit(2)">2</button>
                <button class="pin-btn" onclick="addPinDigit(3)">3</button>
                <button class="pin-btn" onclick="addPinDigit(4)">4</button>
                <button class="pin-btn" onclick="addPinDigit(5)">5</button>
                <button class="pin-btn" onclick="addPinDigit(6)">6</button>
                <button class="pin-btn" onclick="addPinDigit(7)">7</button>
                <button class="pin-btn" onclick="addPinDigit(8)">8</button>
                <button class="pin-btn" onclick="addPinDigit(9)">9</button>
                <button class="pin-btn" onclick="clearPin()">C</button>
                <button class="pin-btn" onclick="addPinDigit(0)">0</button>
                <button class="pin-btn" onclick="submitPin()">âœ“</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ã€ propos -->
    <div class="modal" id="aboutModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh;">
            <div class="modal-header">
                <span class="material-icons" style="margin-right: 0.5rem;">info</span>
                Ã€ propos
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: 70vh;">
                
                <!-- En-tÃªte app -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 4rem; margin-bottom: 0.5rem;">ğŸ’°</div>
                    <h2 style="margin: 0; font-size: 1.5rem;">Gestionnaire de DÃ©penses</h2>
                    <p style="color: var(--text-secondary); margin: 0.5rem 0;">Version 2.0</p>
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">Application PWA gratuite et sans publicitÃ©</p>
                </div>
                
                <!-- Description -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ“± PrÃ©sentation</h3>
                    <p>Application web progressive (PWA) de gestion de dÃ©penses partagÃ©es, inspirÃ©e de Tricount. IdÃ©ale pour les couples, colocataires ou groupes d'amis souhaitant gÃ©rer leurs finances communes.</p>
                </div>
                
                <!-- FonctionnalitÃ©s principales -->
                <div class="about-section">
                    <h3 class="about-title">âœ¨ FonctionnalitÃ©s principales</h3>
                    <div class="about-features">
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ </span>
                            <div>
                                <strong>Tableau de bord</strong>
                                <p>Vue d'ensemble des finances de chaque membre</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">âš–ï¸</span>
                            <div>
                                <strong>Balance automatique</strong>
                                <p>Calcul "Qui doit quoi Ã  qui" avec minimisation des transactions</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ’³</span>
                            <div>
                                <strong>DÃ©penses communes</strong>
                                <p>SystÃ¨me "PayÃ© par" avec sÃ©lection des participants</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ“Š</span>
                            <div>
                                <strong>Statistiques</strong>
                                <p>Graphique camembert, filtres par pÃ©riode et par personne</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ”—</span>
                            <div>
                                <strong>Partage facile</strong>
                                <p>Lien court gÃ©nÃ©rÃ© automatiquement pour partager le groupe</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ”’</span>
                            <div>
                                <strong>SÃ©curitÃ©</strong>
                                <p>Code PIN optionnel, donnÃ©es stockÃ©es localement</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ“´</span>
                            <div>
                                <strong>Mode hors ligne</strong>
                                <p>Fonctionne sans connexion internet</p>
                            </div>
                        </div>
                        <div class="about-feature-item">
                            <span class="about-feature-icon">ğŸ¨</span>
                            <div>
                                <strong>ThÃ¨mes</strong>
                                <p>Mode sombre et mode clair</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Autres fonctionnalitÃ©s -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ› ï¸ Autres fonctionnalitÃ©s</h3>
                    <ul style="color: var(--text-secondary); line-height: 1.8; padding-left: 1.5rem;">
                        <li>ğŸ’¸ Gestion des virements entre personnes</li>
                        <li>ğŸ§® Calculatrice intÃ©grÃ©e</li>
                        <li>ğŸ“„ Export PDF des donnÃ©es</li>
                        <li>ğŸ’¾ Sauvegarde/restauration JSON</li>
                        <li>ğŸ“± Installation sur l'Ã©cran d'accueil</li>
                        <li>âœï¸ Modification des dÃ©penses</li>
                        <li>ğŸ·ï¸ 36 icÃ´nes pour catÃ©goriser les dÃ©penses</li>
                    </ul>
                </div>
                
                <!-- ConfidentialitÃ© -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ” ConfidentialitÃ©</h3>
                    <p>Vos donnÃ©es restent sur votre appareil. Aucune information n'est envoyÃ©e Ã  un serveur externe. L'application fonctionne entiÃ¨rement en local.</p>
                </div>
                
                <!-- Contact -->
                <div class="about-section">
                    <h3 class="about-title">ğŸ“§ Contact</h3>
                    <p>Une question, une suggestion ou un bug Ã  signaler ?</p>
                    <a href="/cdn-cgi/l/email-protection#7d1e1213091c1e093d1c1e09081809101819141c531b0f" class="about-contact-btn">
                        <span class="material-icons">email</span>
                        <span class="__cf_email__" data-cfemail="ec8f8382988d8f98ac8d8f98998998818988858dc28a9e">[email&#160;protected]</span>
                    </a>
                </div>
                
                <!-- CrÃ©dits -->
                <div class="about-section" style="text-align: center; border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                        DÃ©veloppÃ© avec â¤ï¸ par <strong>ActuetMedia</strong>
                    </p>
                    <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 0.5rem;">
                        Â© 2025 - Tous droits rÃ©servÃ©s
                    </p>
                    <button class="btn btn-small" onclick="showDonationPopup(); closeModal('aboutModal');" style="margin-top: 1rem; background: linear-gradient(135deg, #e11d48 0%, #be123c 100%);">
                        <span class="material-icons" style="font-size: 1rem;">favorite</span>
                        Soutenir ce projet gratuit
                    </button>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('aboutModal')" style="flex: 1;">Fermer</button>
            </div>
        </div>
    </div>

    </div><!-- Fin de #pwa-app -->

    <!-- Scripts externes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="js/security.js"></script>
    <script src="js/app.js"></script>
    <script src="js/pdf-export.js"></script>
    <script src="js/ios-fixes.js"></script>
    <script src="js/ios-install.js"></script>
</body>
</html>
